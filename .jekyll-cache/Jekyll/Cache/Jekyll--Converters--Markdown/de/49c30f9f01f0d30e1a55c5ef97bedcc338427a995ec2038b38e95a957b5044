I"Œ<h3 id="80-edit-profile-get">8.0 Edit Profile GET</h3>

<p>ë¡œê·¸ì¸ í–ˆì„ ë•Œ, í”„ë¡œí•„ì„ ë°”ê¾¸ëŠ” í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ë³´ê² ë‹¤. userRouter.jsì—ì„œ /edit ë¼ìš°í„°ë¥¼ ìˆ˜ì •í•´ì„œ GET, POSTì— ë§ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“ ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
...
import {
    getEdit,
    postEdit,
    ...
}
...
userRouter.route("/edit").get(getEdit).post(postEdit);
...
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ì£¼ëŠ”ë°, edit-profile ë·°ë¡œ ëœë”ë§í•˜ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const getEdit = (req, res) =&gt; {
    return res.render("edit-profile", { pageTitle: "Edit Profile" });
};

export const postEdit = (req, res) =&gt; {
    return res.render("edit-profile");
};
</code></pre></div></div>

<p>ì•„ì§ edit-profileì´ë¼ëŠ” ë·°ê°€ ì—†ê¸° ë•Œë¬¸ì— ë§Œë“¤ì–´ì¤€ë‹¤. ì´ë•Œ, Name, Email, Username, Locationë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ë§Œë“ ë‹¤. ì´ë•Œ, ê° input ì•ˆì˜ ê°’ì€ loggedInUserì—ì„œ ì‚¬ìš©í•œë‹¤. ë¹„ë°€ë²ˆí˜¸ëŠ” ë‚˜ì¤‘ì— ë”°ë¡œ ìˆ˜ì •í•˜ëŠ” ê²ƒì„ ë§Œë“¤ì–´ì¤„ ì˜ˆì •ì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// edit-profile.pug
extends base

block content
    form(method="POST")
        input(placeholder="Name", name="name", type="text", required, value=loggedInUser.name)
        input(placeholder="Email", name="email", type="email", required, value=loggedInUser.email)
        input(placeholder="Username", name="username", type="text", required, value=loggedInUser.username)
        input(placeholder="Location", name="location", type="text", required, value=loggedInUser.location)
        input(type="submit", value="Update Profile")
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  base.pugë¥¼ ìˆ˜ì •í•´ì„œ ë¡œê·¸ì¸ í–ˆì„ ê²½ìš° í”„ë¡œí•„ì„ ìˆ˜ì •í•˜ëŠ” ë§í¬ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// base.pug
...
    if loggedIn
        li
            a(href="/users/edit") Edit Profile
        ...
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>ì´ë ‡ê²Œí•˜ë©´ ê¸°ë³¸ì ì¸ í‹€ì€ ì™„ì„±ë˜ì—ˆì§€ë§Œ ë¬¸ì œê°€ ìˆë‹¤. ìš°ë¦¬ëŠ” í”„ë¡œí•„ì„ ìˆ˜ì •í•˜ëŠ” í˜ì´ì§€ê°€ ë¡œê·¸ì¸ í–ˆì„ ê²½ìš°ì—ë§Œ ë³´ì´ê²Œ ë§Œë“¤ì–´ì¤¬ë‹¤. í•˜ì§€ë§Œ ë§í¬ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì£¼ì†Œë¥¼ ë°”ë¡œ ì…ë ¥í•´ë„ í•´ë‹¹ í˜ì´ì§€ì— ê°ˆ ìˆ˜ ìˆë‹¤. ì´ ê²½ìš° ë¡œê·¸ì¸ì„ í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ loggedInUserì´ undefinedì¼ ê²ƒì´ë‹¤. ê·¸ëŸ°ë° ìš°ë¦¬ëŠ” edit-profile.pugì—ì„œ loggedInUserì˜ ê°’ì„ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ì´ë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•´ì„œ loggedInUserì´ ë¹„ì–´ìˆì„ ê²½ìš° ë¹„ì–´ìˆëŠ” ê°ì²´ê°€ ë˜ë„ë¡ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ì´ëŠ”</td>
      <td>Â </td>
      <td>ë¥¼ ì‚¬ìš©í•˜ë©´ êµ‰ì¥íˆ ê°„ë‹¨íˆ ìˆ˜ì •í•  ìˆ˜ ìˆë‹¤.</td>
    </tr>
  </tbody>
</table>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// middlewares.js
export const localsMiddleware = (req, res, next) =&gt; {
    ...
    res.locals.loggedInUser = req.session.user || {};
    next();
};
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>ì´ë ‡ê²Œí•˜ë©´ req.sessionì´ ë¹„ì–´ìˆëŠ” ê²½ìš° {}ë¡œ ì‚¬ìš©í•˜ê³  ì•„ë‹ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ì•„ë¬´ëŸ° ë¬¸ì œ ì—†ë‹¤. ì£¼ì˜í•  ê²ƒì€ a</td>
      <td>Â </td>
      <td>b ê°€ aë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ê³  aê°€ falseì¸ ê²½ìš°ì—ë§Œ bë¥¼ ì‹¤í–‰í•œë‹¤ëŠ” ê²ƒì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìˆœì„œë¥¼ ë°”ê¿”ì„œ {}</td>
      <td>Â </td>
      <td>req.session.userë¡œ ì ì–´ì£¼ë©´, loggedInUserì´ í•­ìƒ ë¹„ê²Œ ë˜ë¯€ë¡œ ìˆœì„œë¥¼ ë°”ê¿”ì„œëŠ” ì•ˆ ëœë‹¤.</td>
    </tr>
  </tbody>
</table>

<h3 id="81-protector-and-public-middlewares">8.1 Protector and Public Middlewares</h3>

<p>ìš°ë¦¬ëŠ” ì´ì „ì— ì£¼ì†Œë¥¼ í†µí•œ í˜ì´ì§€ ì´ì „ìœ¼ë¡œ ìƒê¸°ëŠ”, í”„ë¡œí•„ ìˆ˜ì • í˜ì´ì§€ì˜ ì˜¤ë¥˜ë¥¼ í•´ê²°í•´ì¤¬ë‹¤. ê·¸ëŸ°ë° ì´ëŠ” ì—¬ê¸°ì„œë§Œ í•´ë‹¹ë˜ëŠ” ì´ì•¼ê¸°ê°€ ì•„ë‹ˆë‹¤. ë¡œê·¸ì¸í•œ ê²½ìš°ì— ë¡œê·¸ì¸ í˜ì´ì§€ ë§í¬ê°€ ë³´ì´ì§€ ì•Šê²Œ ë§Œë“¤ì—ˆì§€ë§Œ, ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•  ê²½ìš° ì ‘ì†í•  ìˆ˜ ìˆë‹¤. ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°ì—ë„ ë¡œê·¸ì•„ì›ƒ í˜ì´ì§€ì— ì ‘ì†í•  ìˆ˜ ìˆê³ , í”„ë¡œí•„ ìˆ˜ì • í˜ì´ì§€ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤. ì´ì²˜ëŸ¼ í˜„ì¬ ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ìƒê´€ ì—†ì´ í˜ì´ì§€ë¥¼ ì˜¤ê°ˆ ìˆ˜ ìˆë‹¤ëŠ” ë¬¸ì œê°€ ìˆë‹¤.</p>

<p>ì´ë²ˆì—ëŠ” ì´ë¥¼ ìˆ˜ì •í•˜ê¸° ìœ„í•´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì£¼ê² ë‹¤. ì‚¬ìš©í•  ë¯¸ë“¤ì›¨ì–´ëŠ” 2ê°€ì§€ë¡œ protectorMiddleware, publicOnlyMiddlewareë‹¤. ìš°ì„  protectorMiddlewareëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í•œ ê²½ìš° ê·¸ëŒ€ë¡œ í†µê³¼í•˜ê³ , ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ê²½ìš°ëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ë‹¤. publicOnlyMiddlewareëŠ” ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° í†µê³¼í•˜ê³ , ë¡œê·¸ì¸ í•œ ê²½ìš° í™ˆìœ¼ë¡œ ë³´ë‚´ì¤€ë‹¤.</p>

<p>ì´ ë‘˜ì„ ì‚¬ìš©í•´ì„œ ë¼ìš°í„°ì— ë¯¸ë“¤ì›¨ì–´ë¥¼ ì¶”ê°€í•´ì£¼ë©´, ë’¤ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì‹¤í–‰ë˜ê¸° ì „ì— ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  ì‹¤í–‰ë˜ì–´ì„  ì•ˆ ë˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§‰ì•„ì¤€ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ <code class="language-plaintext highlighter-rouge">userRouter.get("/logout", protectorMiddleware, logout)</code>ìœ¼ë¡œ ì ì–´ì£¼ì—ˆë‹¤ê³  ìƒê°í•´ë³´ì. /users/logoutì— ì ‘ì†í–ˆì„ ë•Œ, protectorMiddlewareê°€ ì‹¤í–‰ëœë‹¤. ë§Œì•½ ë¡œê·¸ì¸ í–ˆë‹¤ë©´, protectorMiddlewareê°€ ì•„ë¬´ëŸ° ì¼ë„ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ logout ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì‹¤í–‰ëœë‹¤. ë°˜ëŒ€ë¡œ ë¡œê·¸ì¸ í•˜ì§€ ì•Šì€ ê²½ìš°, protectorMiddlewareê°€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ë‚´ë¯€ë¡œ, ë’¤ì˜ logout ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<p>ì•„ë˜ëŠ” middlewares.jsì— protectorMiddlewareê³¼ publicOnlyMiddlewareë¥¼ ë§Œë“¤ì–´ ì¤€ ê²ƒì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// middlewares.js

export const protectorMiddleware = (req, res, next) =&gt; {
    if(req.session.loggedIn) {
        return next();
    } else {
        return res.redirect("/login");
    }
};

export const publicOnlyMiddleware = (req, res, next) =&gt; {
    if(!req.session.loggedIn) {
        return next();
    } else {
        return res.redirect("/");
    }
};
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ì´ë“¤ì„ importí•´ì„œ ë¼ìš°í„°ë³„ë¡œ ì‚¬ìš©í•´ì£¼ë©´ ëœë‹¤. ê·¸ ì „ì— ì–´ë–¤ ê²ƒì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€ ë¶„ë¥˜í•´ì•¼ í•œë‹¤. ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ ì‘ë™ë˜ê³  ì‹¶ì€ ë¼ìš°í„°ëŠ” â€œ/users/logoutâ€, â€œ/users/editâ€ì´ë‹¤. ë¡œê·¸ì•„ì›ƒí•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ë¼ìš°í„°ëŠ” â€œ/users/github/startâ€, â€œ/users/github/finishâ€, â€œ/loginâ€, â€œ/joinâ€ì´ë‹¤.</p>

<p>ê·¸ëŸ°ë° â€œ/editâ€ì´ë‚˜ â€œ/joinâ€ì€ .getê³¼ .postë¥¼ ë‘˜ ë‹¤ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ì„ íƒì§€ëŠ” 2ê°€ì§€ê°€ ìˆë‹¤. ì²« ë²ˆì§¸ëŠ” <code class="language-plaintext highlighter-rouge">rootRouter.route("/join").get(publicOnlyMiddleware, getJoin).post(publicOnlyMiddleware, postJoin);</code>ì²˜ëŸ¼ .get, .postì— ë‘˜ ë‹¤ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ìˆë‹¤. ë‹¤ë¥¸ í•˜ë‚˜ëŠ” .allì„ ì‚¬ìš©í•´ì„œ ëª¨ë“  ê²½ìš°ì— ì‘ë™ë˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ê³  ê·¸ ë’¤ì— .get, .postë¥¼ ì ì–´ì£¼ëŠ” ê²ƒì´ë‹¤. <code class="language-plaintext highlighter-rouge">rootRouter.route("/join").all(publicOnlyMiddleware).get(getJoin).post(postJoin);</code></p>

<p>ì´ë¥¼ ì ìš©í•´ì„œ ê° ë¼ìš°í„°ë³„ë¡œ ë§Œë“¤ì–´ì£¼ë©´ ë‹¤ìŒì²˜ëŸ¼ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// rootRouter.js
import { publicOnlyMiddleware } from "../middlewares";
...
rootRouter
    .route("/join")
    .all(publicOnlyMiddleware)
    .get(getJoin)
    .post(postJoin);
rootRouter
  .route("/login")
  .all(publicOnlyMiddleware)
  .get(getLogin)
  .post(postLogin);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
import { protectorMiddleware, publicOnlyMiddleware } from "../middlewares";
...
userRouter.get("/logout", protectorMiddleware, logout);
userRouter.route("/edit").all(protectorMiddleware).get(getEdit).post(postEdit);
userRouter.get("/github/start", publicOnlyMiddleware, startGithubLogin);
userRouter.get("/github/finish", publicOnlyMiddleware, finishGithubLogin);
</code></pre></div></div>

<h3 id="82-edit-profile-post-part-one">8.2 Edit Profile Post part One</h3>

<p>ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ëŸ¬ë„ ë³´í˜¸í•´ì¤˜ì•¼ í•œë‹¤. ë¹„ë””ì˜¤ë¥¼ edit, delete, uploadëŠ” ë¡œê·¸ì¸ í•œ ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ videoRouter.jsë¡œ ì´ë™í•´ì„œ ì•„ë˜ì²˜ëŸ¼ protectorMiddlewareë¥¼ ì¶”ê°€í•´ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoRouter.js
import { protectorMiddleware } from "../middlewares";

const videoRouter = express.Router();

videoRouter.get("/:id([0-9a-f]{24})", watch);
videoRouter
  .route("/:id([0-9a-f]{24})/edit")
  .all(protectorMiddleware)
  .get(getEdit)
  .post(postEdit);
videoRouter
  .route("/:id([0-9a-f]{24})/delete")
  .all(protectorMiddleware)
  .get(deleteVideo);
videoRouter
  .route("/upload")
  .all(protectorMiddleware)
  .get(getUpload)
  .post(postUpload);
</code></pre></div></div>

<p>ì•„ì§ì€ video modelê³¼ user modelì„ ì—°ê²°í•˜ì§€ ì•Šì•˜ì§€ë§Œ, ë‚˜ì¤‘ì— ë¹„ë””ì˜¤ì— ì–´ë–¤ ì‚¬ìš©ìê°€ ì—…ë¡œë“œ í–ˆëŠ”ì§€ë¥¼ ì¶”ê°€í•˜ë©´ ìˆ˜ì •, ì‚­ì œ, ì—…ë¡œë“œê°€ ê°€ëŠ¥í•´ì§ˆ ê²ƒì´ë‹¤.</p>

<p>íŒí•˜ë‚˜ë¥¼ ì£¼ìë©´, ì„í¬íŠ¸ í•˜ê³  ì‹¶ì€ íŒŒì¼ì„ ì—´ì–´ë†“ê³ , ê·¸ íŒŒì¼ì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ VSCì—ì„œ ìë™ìœ¼ë¡œ ê·¸ í•¨ìˆ˜ë¥¼ importí•œë‹¤. ë°˜ë“œì‹œ ë‘ íŒŒì¼ì´ ëª¨ë‘ ì—´ë ¤ ìˆì–´ì•¼ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì ì— ì£¼ì˜í•˜ì.</p>

<p>ë‹¤ìŒìœ¼ë¡œ ì—…ë¡œë“œ ë¹„ë””ì˜¤ëŠ” ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ ê°€ëŠ¥í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ base.pugì—ì„œ ë§í¬ë¥¼ ìˆ˜ì •í•´ì„œ ë¡œê·¸ì¸ í•œ ê²½ìš°ì—ë§Œ Upload Videoê°€ ë³´ì´ë„ë¡ ë§Œë“ ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// base.pug
...
    if loggedIn
        li
            a(href="/videos/upload") Upload Video
        li
            a(href="/users/edit") Edit Profile
        li
            a(href="/login")  Login
...
</code></pre></div></div>

<p>ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ edit-profileì„ ë§Œë“¤ì–´ë³´ê² ë‹¤. edit-profile í˜ì´ì§€ì—ì„œ POSTë¡œ ìˆ˜ì •í•  ì •ë³´ë¥¼ ë³´ë‚´ë©´ ì´ë¥¼ postEditì—ì„œ ìˆ˜ì •í•œë‹¤. POSTë¡œ ë³´ë‚´ì¤€ ì •ë³´ëŠ” req.bodyì— ë“¤ì–´ ìˆìœ¼ë¯€ë¡œ, ê·¸ ì•ˆì—ì„œ name, emai, username, locationì„ ë°›ì•„ì˜¨ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const postEdit = (req, res) =&gt; {
    const { name, email, username, location } = req.body;
}
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ë°›ì•„ì˜¨ ì •ë³´ë¥¼ ê°€ì§€ê³  ì—…ë°ì´íŠ¸ë¥¼ í•´ì¤˜ì•¼ í•œë‹¤. ê·¸ë ‡ê²Œ í•˜ë ¤ë©´ findByIdAndUpdate()ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” idê°€ í•„ìš”í•œë°, ì´ëŠ” req.session.user._idì— ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìš°ì„ ì€ _idë¥¼ ë°›ì•„ì™€ì•¼ í•œë‹¤. <code class="language-plaintext highlighter-rouge">const _id = req.session.user._id;</code>ë¡œ ì ì–´ì¤˜ë„ _idë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ìˆì§€ë§Œ ì•„ë˜ ë°©ë²•ì´ ë” íš¨ê³¼ì ì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const {
    session: {
        user: { _id },
    },
} = req;
</code></pre></div></div>

<p>ì™œ ì´ ë°©ì‹ì´ ë” íš¨ê³¼ì ì¸ê°€ í•˜ë©´ í•œ ë²ˆì— ì—¬ëŸ¬ ê³³ì—ì„œ ì •ë³´ë¥¼ ë°›ì•„ì˜¬ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ìš°ë¦¬ì˜ ê²½ìš° req.session.user._idë¥¼ ë°›ì•„ì˜´ê³¼ ë™ì‹œì—, req.bodyì—ì„œ name, email, username, locationì„ ë°›ì•„ì˜¤ê³  ìˆë‹¤. ì•„ë˜ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ì´ë¥¼ ë™ì‹œì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆê³ , ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ë” í¸í•´ì§„ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const {
    session: {
        user: { _id },
    },
    body: { name, email, username, location },
} = req;
</code></pre></div></div>

<p>ì´ì œ ì´ë ‡ê²Œ ì°¾ì€ ì •ë³´ë“¤ë¡œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ í•´ë³´ì. ì •ë³´ë¥¼ ì°¾ê³  ì—…ë°ì´íŠ¸ í•˜ê¸°ìœ„í•´ì„  <code class="language-plaintext highlighter-rouge">findByIdAndUpdate(_id, [update] [,options])</code>ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì—¬ê¸°ì„œ _idì— _idë¥¼ ë„£ì–´ì£¼ê³ , updateì— ë³€ê²½í•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì ì–´ì£¼ë©´ ëœë‹¤.
findByIdAndUpdateë¡œ ìƒˆë¡œ ë°›ì•„ì˜¨ ìë£Œë¡œ ì—…ë°ì´íŠ¸ í•´ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export const postEdit = async (req, res) =&gt; {
    const {
        session: {
            user: { _id },
        },
        body: { name, email, username, location },
    } = req;
    await User.findByIdAndUpdate(_id, {
        name,
        email,
        username,
        location,
    });
    return res.render("edit-profile");
};
</code></pre></div></div>

<p>ì—…ë°ì´íŠ¸ í•œ í›„ì— í˜ì´ì¦ˆë¥¼ ë³´ë©´ name, email, username, locationì´ ì „í˜€ ì—…ë°ì´íŠ¸ ë˜ì§€ ì•Šì•˜ë‹¤. ê·¸ëŸ°ë° ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³´ë©´ ì—…ë°ì´íŠ¸ ë¼ìˆë‹¤. DBê°€ ì—…ë°ì´íŠ¸ ëìŒì—ë„, í˜ì´ì§€ê°€ ê·¸ëŒ€ë¡œì¸ ì´ìœ ëŠ”, ìš°ë¦¬ê°€ DBë¥¼ ì—…ë°ì´íŠ¸ í•œ ê²ƒì¼ ë¿ì´ì§€ ì„¸ì…˜ì„ ì—…ë°ì´íŠ¸ í•œ ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì´ë‹¤. ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ì„¸ì…˜ì´ DBë¡œë¶€í„° ë§Œë“¤ì–´ì§„ ê²ƒì€ ë§ì§€ë§Œ, DBì™€ ì„¸ì…˜ì€ ë³„ê°œì˜ ê²ƒì´ë‹¤.</p>

<p>ì ì‹œ ì„¸ì…˜ì„ ë³µìŠµí•´ë³´ì. ì„¸ì…˜ì´ ë§Œë“¤ì–´ì§€ëŠ” ê³¼ì •ì„ ì•„ë˜ì™€ ê°™ë‹¤.</p>

<ol>
  <li>HTTP ìš”ì²­ì´ ë“¤ì–´ì˜¨ë‹¤.</li>
  <li>ë¯¸ë“¤ì›¨ì–´ê°€ ì„¸ì…˜ ì¿ í‚¤ë¥¼ í™•ì¸í•œë‹¤.</li>
  <li>ì„¸ì…˜ ì¿ í‚¤ê°€ ì—†ë‹¤ë©´, ìƒˆë¡œ í•˜ë‚˜ ë§Œë“¤ê³  ë§ˆì§€ë§‰ì— ì„¸ì…˜ ì•„ì´ë””ë¥¼ ë§Œë“¤ì–´ì„œ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ë°˜í™˜í•œë‹¤.</li>
  <li>ì„¸ì…˜ ì¿ í‚¤ê°€ ìˆë‹¤ë©´, ì„¸ì…˜ ì•„ì´ë””ë¡œ ì„¸ì…˜ì„ ì°¾ì•„ì„œ request ê°ì²´ì— ì„¸ì…˜ ì •ë³´ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.</li>
  <li>ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ê°€ ì¢…ë£Œëœë‹¤.</li>
  <li>request ê°ì²´ì— ì„¸ì…˜ ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ, ì´í›„ ìµìŠ¤í”„ë ˆìŠ¤ì—ì„œ ì¼ì–´ë‚˜ëŠ” ê³¼ì •ì—ì„œ ì„¸ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤.</li>
</ol>

<p>ìš°ë¦¬ê°€ ì§€ê¸ˆê¹Œì§€ req.sessionì„ ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆë˜ ì´ìœ ê°€, ì„¸ì…˜ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ë©´ì„œ DBì— ìˆë˜ ì„¸ì…˜ ê°ì²´ê°€ requestì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë¦¬ê³  ìš°ë¦¬ëŠ” ìœ„ì—ì„œ ì´ ì„¸ì…˜ ì •ë³´ì—ì„œ _idë¥¼ ì°¾ì•„ì™€ì„œ DBë¥¼ ìˆ˜ì •í•´ì£¼ì—ˆì„ ë¿ì´ë‹¤.</p>

<p>ë‹¤ì‹œ ëŒì•„ê°€ì„œ viewë¥¼ ë³´ë©´ localsì˜ ìë£Œë¥¼ ìš°ë¦¬ì—ê²Œ ë³´ì—¬ì¤€ë‹¤. ì´ localsì´ ë‚˜ì˜¨ ê³³ì€, middlewares.jsì˜ localMiddlewareì—ì„œ sessionì„ localsì— ë„£ì–´ì£¼ê³  ìˆë‹¤. ê·¸ë¦¬ê³  ì„¸ì…˜ì€ ë¡œê·¸ì¸ í•  ë•Œ, <code class="language-plaintext highlighter-rouge">req.session.loggedIn = true</code>ì™€ <code class="language-plaintext highlighter-rouge">req.session.user = user</code>ì„ ì¶”ê°€í•´ì„œ ë§Œë“¤ì–´ì¤€ ê²ƒì´ë‹¤. ì—¬ê¸°ì„œ ì„¸ì…˜ì€ DBì™€ ë³„ê°œì˜ ê²ƒìœ¼ë¡œ ìš°ë¦¬ëŠ” ì„¸ì…˜ì„ ì—…ë°ì´íŠ¸ í•´ì¤¬ì„ ë¿ì´ë‹¤. ê·¸ë˜ì„œ ìš°ë¦¬ì˜ DBì—ëŠ” loggedIn ê°™ì€ ì†ì„±ì´ ìƒê¸°ì§€ ì•ŠëŠ” ê²ƒì´ë‹¤.</p>

<p>ìš°ë¦¬ê°€ ìƒìš”í•œ findByIdAndUpdateëŠ” DBë¥¼ ì—…ë°ì´íŠ¸ í•˜ëŠ” í•¨ìˆ˜ë‹¤. ê·¸ë˜ì„œ DBëŠ” ì—…ë°ì´íŠ¸ ë˜ì—ˆì§€ë§Œ, ì„¸ì…˜ì„ ë°”ê¿”ì£¼ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì„¸ì…˜ì€ ê·¸ëŒ€ë¡œì¸ ê²ƒì´ë‹¤. ê·¸ë˜ì„œ ìš°ë¦¬ì—ê²Œ ë³´ì´ëŠ” í˜ì´ì§€ëŠ” ì´ì „ì˜ ì„¸ì…˜ì„ ê·¸ëŒ€ë¡œ ë³´ì—¬ì£¼ê³  ì•„ë¬´ëŸ° ë³€í™”ê°€ ì—†ëŠ” ê²ƒì´ë‹¤.</p>

<h3 id="83-edit-profile-post-part-two">8.3 Edit Profile Post part Two</h3>

<p>ìš°ë¦¬ëŠ” DBë¥¼ ì—…ë°ì´íŠ¸ í•´ì¤¬ì§€ë§Œ, í˜ì´ì§€ì— ì•„ë¬´ëŸ° ë³€í™”ë„ ì—†ì—ˆë‹¤. ì´ëŠ” í”„ë¡ íŠ¸ì—”íŠ¸ëŠ” sessionìœ¼ë¡œë¶€í„° ì •ë³´ë¥¼ ì–»ê¸° ë•Œë¬¸ì´ë‹¤. ì—¬ê¸°ì„œ sessionì€ ë¡œê·¸ì¸ í•  ë•Œë§Œ ì‚¬ìš©ë˜ê³  ìˆëŠ”ë°, ê²°êµ­ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í•œ ê²½ìš°ì—ë§Œ ë°”ë€ë‹¤. ê·¸ë˜ì„œ DBë¥¼ ì—…ë°ì´íŠ¸ í•´ë„ sessionì´ ë°”ë€Œì§ˆ ì•ŠëŠ”ë‹¤. ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ê°€ ìˆë‹¤.</p>

<p>ì²« ë²ˆì§¸, sessionì— ì§ì ‘ ë„£ì–´ì£¼ëŠ” ê²ƒì´ë‹¤. ì•ì„œ DBë¥¼ ì—…ë°ì´íŠ¸ í•œ postEditì—ì„œ <code class="language-plaintext highlighter-rouge">res.session.user = {name, email, username, locaion}</code>ìœ¼ë¡œ ì§ì ‘ ì—…ë°ì´íŠ¸ í•´ì£¼ëŠ” ê²ƒì´ë‹¤. ê·¸ëŸ°ë° sessionì€ ì € ì™¸ì—ë„ ë‹¤ì–‘í•œ ì •ë³´ë¥¼ ë‹´ê³  ìˆë‹¤. ìœ„ì™€ ê°™ì´ ì‘ì„±í•˜ë©´ ì € ì´ì™¸ì˜ ì •ë³´ëŠ” ì—†ì–´ì§€ê²Œ ë  ê²ƒì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ë‚˜ë¨¸ì§€ ì •ë³´ë„ ë„£ì–´ì¤˜ì•¼ í•œë‹¤. ì´ëŠ” <code class="language-plaintext highlighter-rouge">...req.session.user</code>ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. ì—¬ê¸°ì„œ â€¦ì€ ì•ˆì˜ ë‚´ìš©ì„ ë°–ìœ¼ë¡œ êº¼ë‚´ì¤€ë‹¤ëŠ” ì˜ë¯¸ë¡œ, req.session.user ì•ˆì˜ ë‚´ìš©ì„ {}ì„ ì œê±°í•˜ê³  êº¼ë‚´ì¤€ë‹¤ëŠ” ëœ»ì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì•„ë˜ì²˜ëŸ¼ ì‘ì„±í•˜ë©´ sessionì˜ ë‚´ìš©ì„ ëª¨ë‘ êº¼ë‚´ì£¼ê³ , name, email, username, locationì„ ë®ì–´ì¨ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    ...
    req.sesison.user = {
        ...req.session.user,
        name,
        email,
        username,
        loaction,
    };
    return res.redirect("/user/edit");
</code></pre></div></div>

<p>ë‘ ë²ˆì§¸, findByIdAndUpdateë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì´ë‹¤. <code class="language-plaintext highlighter-rouge">findByIdAndUpdate(_id, [update], [options]))</code>ëŠ” ì°¾ìœ¼ë ¤ëŠ” _id, ì—…ë°ì´íŠ¸í•  ë‚´ìš©, ì˜µì…˜ ìˆœì„œë¡œ íŒ¨ëŸ¬ë¯¸í„°ë¥¼ ë„£ëŠ”ë‹¤. ê·¸ë¦¬ê³  findByIdAndUpdateëŠ” ë³€ê²½í•œ ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤. ê·¸ëŸ°ë° findByIdAndUpdateì˜ ì¤‘ìš”í•œ ì ì€ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ì—…ë°ì´íŠ¸ ì´ì „ì˜ ë°ì´í„°ë¼ëŠ” ì ì´ë‹¤. ìš°ë¦¬ëŠ” ì—…ë°ì´íŠ¸ ì´í›„ì˜ ë°ì´í„°ê°€ í•„ìš”í•˜ë‹¤. ì´ ê²½ìš° optionsì— returnDocument=â€afterâ€ë¡œ ì„¤ì •í•˜ë©´ ì—…ë°ì´íŠ¸ ì´í›„ì˜ ë°ì´í„°ê°€ ë‚˜ì˜¨ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì—…ë°ì´íŠ¸ í•œ ë‚´ìš©ì„ ë°˜í™˜ ë°›ì•„ì„œ ë°”ë¡œ req.session.userì— ë„£ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
  const updatedUser = await User.findByIdAndUpdate(
    _id,
    {
      name,
      email,
      username,
      location,
    },
    { returnDocument: "after" }
  );
  req.session.user = updatedUser;
  return res.redirect("/users/edit");
}
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ usernameê³¼ emailì„ ì—…ë°ì´íŠ¸ í•  ë•Œ, ì¤‘ë³µë˜ëŠ” ê°’ì´ ìˆëŠ”ì§€ ê²€ì‚¬í•´ì•¼ í•œë‹¤. ì´ëŠ” existsë¥¼ ì“°ë©´ ì¡´ì¬ ì—¬ë¶€ëŠ” ì‰½ê²Œ ì•Œ ìˆ˜ ìˆë‹¤. ìš°ë¦¬ëŠ” ì´ì „ì—ë„ <code class="language-plaintext highlighter-rouge">const exists = await User.exitsts({ $or: [{ username }, { email }] });</code>ë¡œ usernameê³¼ emailì´ ìˆëŠ”ì§€ í™•ì¸í–ˆì—ˆë‹¤. ê·¸ëŸ°ë° ì–´ë–»ê²Œ ì‚¬ìš©ìê°€ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸ í•˜ë ¤ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆì„ê¹Œ? ë§Œì•½ ì‚¬ìš©ìê°€ ì•„ë¬´ê²ƒë„ ìˆ˜ì •í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ì—…ë°ì´íŠ¸ë¥¼ ëˆ„ë¥´ë©´, ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì´ë¯€ë¡œ ê°’ì„ ì—…ë°ì´íŠ¸ í•˜ì§€ ì•Šê²Œ ëœë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìš°ë¦¬ëŠ” ì‚¬ìš©ìê°€ usernameì´ë‚˜ emailì„ ë³€ê²½ì‹œì¼°ëŠ”ì§€ë¥¼ ì•Œì•„ë´ì•¼ í•œë‹¤.</p>

<p>ì´ë¥¼ ìœ„í•´ì„œ _idë¡œ ì‚¬ìš©ìë¥¼ ì°¾ì•„ì£¼ê³ , ì‚¬ìš©ìì˜ username, emailê³¼ ì…ë ¥ë°›ì€ username, emailì— ì°¨ì´ê°€ ìˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ê³ , ì°¨ì´ê°€ ì—†ë‹¤ë©´ ì—…ë°ì´íŠ¸ë¥¼ í•´ì¤˜ì•¼ í•œë‹¤. ë¨¼ì € <code class="language-plaintext highlighter-rouge">const findedUser = await User.findById({_id});</code>ë¡œ _idë¥¼ ì‚¬ìš©í•´ì„œ ì‚¬ìš©ì°¨ë¥¼ ì°¾ì•„ì¤€ë‹¤. ê·¸ í›„ emailì„ ë¹„êµí•´ì„œ ì„œë¡œ ë‹¤ë¥´ë‹¤ë©´, ë°”ê¾¸ë ¤ëŠ” emailì„ ê²€ìƒ‰í•´ì„œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•´ì¤˜ì•¼ í•œë‹¤. ì´ëŠ” <code class="language-plaintext highlighter-rouge">const findEmail = await User.findOne({ email });</code>ë¡œ ê°€ëŠ¥í•˜ë‹¤. ê·¸ í›„ì— ë‘˜ì˜ _idë¥¼ ë¹„êµí•´ì„œ ë‹¤ë¥´ë‹¤ë©´ ë°”ê¾¸ë ¤ëŠ” ì´ë©”ì¼ì„ ì“°ëŠ” ì‚¬ìš©ìê°€ ìˆë‹¤ëŠ” ì˜ë¯¸ì´ë¯€ë¡œ í—ˆìš©í•´ì„œëŠ” ì•ˆ ëœë‹¤. ì´ë•Œ, ë°”ê¾¸ë ¤ëŠ” ì´ë©”ì¼ì„ ì“°ëŠ” ì‚¬ìš©ìê°€ ì—†ì„ ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì—, findEmailì´ nullì¸ì§€ í™•ì¸í•´ì¤˜ì•¼ í•œë‹¤. ë™ì¼í•œ ê³¼ì •ì„ usernameì— ì ìš©í•˜ê³ , ì´ ë‘˜ì„ í†µê³¼í–ˆë‹¤ë©´ usernameê³¼ emailì„ ë³€ê²½í•´ì¤€ë‹¤. ì•„ë˜ëŠ” ì´ë¥¼ ì½”ë“œë¡œ ì ì€ ê²ƒì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export const postEdit = async (req, res) =&gt; {
  const {
    session: {
      user: { _id },
    },
    body: { name, email, username, location },
  } = req;
  /*
   * We need to check that username or email are already existed or not.
   * First, we need to find user by _id.
   */
  const findedUser = await User.findById({ _id });
  // Next, we check findedUser.email and email are equal
  if(findedUser.email !== email) {
    // If they are different, find the owner of email
    const findEmail = await User.findOne({ email });
    // findEmail can be null, so we need to check it
    // and identify they have same _id
    if(findEmail !== null &amp;&amp; findedUser._id !== findEmail._id) {
        // If _id are different, it means that the users are different
        // So, we shouldn't allow to change email
        console.log("This email already exists");
        return res.redirect("/users/edit");
    }
  }
  if(findedUser.username !== username) {
    const findName = await User.findOne({ username });
    if(findName !== null &amp;&amp; findedUser._id !== findName._id) {
      console.log("This username already exists");
      return res.redirect("/users/edit");
    }
  }
  const updatedUser = await User.findByIdAndUpdate(
    _id,
    {
      name,
      email,
      username,
      location,
    },
    { returnDocument: "after" }
  );
  req.session.user = updatedUser;
  return res.redirect("/users/edit");
};
</code></pre></div></div>

<h3 id="84-change-password-part-one">8.4 Change Password part One</h3>

<p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ëŠ” í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ë³´ê² ë‹¤. edit-profile.pugì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¿€ ìˆ˜ ìˆëŠ” í˜ì´ì§€ë¡œ ê°€ëŠ” ë§í¬ë¥¼ ë§Œë“¤ì–´ì£¼ê² ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// edit-profile.pug
...
block content
    form(method="POST")
        ...
        input(type="submit", value="Update Profile")
        // add link to go to change-password page
        hr
        a(href="change-password") Change Password &amp;rarr;
</code></pre></div></div>

<p>ë¬¼ë¡  ì•„ì§ ë¼ìš°í„°ë„ ì»¨íŠ¸ë¡¤ëŸ¬ë„ ì—†ê¸° ë•Œë¬¸ì— change-passwordë¡œ ê°€ë”ë¼ë„ ì•„ë¬´ëŸ° ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤. ë¨¼ì € ì»¨ë¥´ë¡¤ëŸ¬ë¶€í„° ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. ê·¸ëŸ°ë° ì§€ê¸ˆê¹Œì§€ ìš°ë¦¬ëŠ” êµ‰ì¥íˆ ë§ì€ view íŒŒì¼ì„ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì—, ì •ë¦¬ë˜ì§€ ì•Šì€ ì±„ë¡œ ê³„ì† ëŠ˜ì–´ê°€ê³  ìˆë‹¤. ì•ìœ¼ë¡œëŠ” ì‚¬ìš©ìì™€ ê´€ë ¨ëœ ê²ƒì€ users í´ë”ì—, ë¹„ë””ì˜¤ì™€ ê´€ë ¨ëœ ê²ƒì€ videos í´ë”ì— ë§Œë“¤ì–´ì¤„ ê²ƒì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ viewë¥¼ ëœë”ë§í•  ë•Œ, users í´ë”ì—ì„œ ë¶ˆëŸ¬ì™€ì•¼ í•œë‹¤. ì´ë¥¼ ê°€ì§€ê³  userController.jsì— getChangePasswordì™€ postChangePasswordë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const getChangePassword = (req, res) =&gt; {
    // We need to organize views for future.
    // So, we will make users folder and put change-password file inside of it.
    return res.render("users/change-password", { pageTitle: "Change Password"});
};

export const postChangePassword = (req, res) =&gt; {
    return res.redirect("/");
};
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ ë¼ìš°í„°ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
...
// import get/postChangePassword from userController
import {
    ...
    getChangePassword,
    postChangePassword,
} from "../controllers/userController";
...
userRouter.route("/edit").all(protectorMiddleware).get(getEdit).post(postEdit);
// add a change-password router
userRouter
    .route("/change-password")
    .all(protectorMiddleware)
    .get(getChangePassword)
    .post(postChangePassword);
...
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ change-password view íŒŒì¼ì„ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. ì•ì„œ ë§í–ˆë“¯ì´ ë¶„ë¥˜ë¥¼ ìœ„í•´, views í´ë” ì•ˆì— usersë¼ëŠ” í´ë”ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ê·¸ ì•ˆì— change-password.pug íŒŒì¼ì„ ë§Œë“¤ì–´ì£¼ë ¤ê³  í•œë‹¤. ë¬¸ì œëŠ” ì´ì „ì²˜ëŸ¼ <code class="language-plaintext highlighter-rouge">extends base</code>ë¥¼ í•˜ë©´ ì•ˆ ëœë‹¤. base íŒŒì¼ì´ í´ë” ë°–ì— ìˆìœ¼ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">extends ../base</code>ë¡œ ì ì–´ì¤˜ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// change-password.pug
extends ../base

block content
   form(method="POST")
    input(placeholder="Old Passwrod", type="password", name="oldPassword")
    input(placeholder="New Password", type="password", name="newPassword")
    input(placeholder="New Password Confirmation", type="password",  name="newPasswordConfirmation")
    input(type="submit", value="Change Password")
</code></pre></div></div>

<p>ê·¸ ë°–ì—ë„ í•œ ê°€ì§€ ë¬¸ì œê°€ ë” ìˆë‹¤. ê¹ƒí—ˆë¸Œë¡œ ë¡œê·¸ì¸ í•œ ê²½ìš°ì—ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ìš°ë¦¬ ì‚¬ì´íŠ¸ì—ì„œ ë°”ê¿€ ìˆ˜ê°€ ì—†ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸í•œ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í˜ì´ì§€ê°€ ë³´ì—¬ì„œëŠ” ì•ˆ ëœë‹¤. ì´ ê²½ìš° 3ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤. ì²« ë²ˆì§¸ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì†Œì…œ ë¡œê·¸ì¸ì¸ ê²½ìš°ë¥¼ í™•ì¸í•´ì„œ í™ˆìœ¼ë¡œ ëŒë ¤ë³´ë‚´ëŠ” ê²ƒì´ë‹¤. ë‘ ë²ˆì§¸ ë°©ë²•ì€ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ì€ ë³´ì´ë˜ ì‚¬ìš©í•  ìˆ˜ëŠ” ì—†ê²Œ ë§Œë“œëŠ” ê²ƒì´ë‹¤. ì„¸ ë²ˆì§¸ëŠ” ì•„ì˜ˆ edit-profile í˜ì´ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë²„íŠ¼ì´ ì•ˆ ë³´ì´ê²Œ í•´ì„œ ëˆ„ë¥¼ ìˆ˜ ì—†ê²Œ í•˜ëŠ” ê²ƒì´ë‹¤. ì•„ë˜ëŠ” ì²« ë²ˆì§¸ë‚˜, ë‘ ë²ˆì§¸ ë°©ë²•ì„ ì„ íƒí•  ê²½ìš° ì½”ë“œë¥¼ ì‚½ì…í•´ì•¼ í•  ìœ„ì¹˜ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
export const getChangePassword = (req, res) =&gt; {
    // First, if use is logged in social authentication, redirect to home
    if (req.session.user.socialOnly === true) {
        return res.redirect("/");
        // or we can show alert and go back to the page
    }
    return res.render("users/change-password", { pageTitle: "Change Password"});
};
...
</code></pre></div></div>

<p>í•˜ì§€ë§Œ ì œì¼ ì¢‹ì€ ê²ƒì€ ê¸°ëŠ¥í•˜ì§€ ì•ŠëŠ” ê²ƒì€ ìˆ¨ê¸°ëŠ” ë°©ë²•ì´ë¯€ë¡œ, ì†Œì…œ ë¡œê·¸ì¸í•œ ê²½ìš°ì—” ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¾¸ëŠ” ë²„íŠ¼ì´ ì—†ë„ë¡ ë§Œë“¤ì–´ì£¼ì. edit-profile.pug íŒŒì¼ì—ì„œ ì†Œì…œ ë¡œê·¸ì¸ì¸ ê²½ìš° Change Passwordê°€ ë³´ì´ì§€ ì•Šê²Œ ë§Œë“ ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// edit-profile.pug
...
block content
    ...
    input(type="submit", value="Update Profile")
    // If user is logged in social authentication, Change Password anchor must be hidden.
    if !loggedInUser.socialOnly
        hr
        a(href="change-password") Change Password &amp;rarr;
</code></pre></div></div>

<h3 id="85-change-password-part-two">8.5 Change Password part Two</h3>

<p>í˜„ì¬ ìš°ë¦¬ëŠ” ì†Œì…œ ë¡œê·¸ì¸í•œ ì •ë³´ê°€ DBì— ë‚¨ì•„ ìˆìœ¼ë¯€ë¡œ, ëª½ê³ ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ì›Œì£¼ë„ë¡ í•œë‹¤. <code class="language-plaintext highlighter-rouge">mongo</code>ë¡œ ì ‘ì†í•œ <code class="language-plaintext highlighter-rouge">use wetube</code>ë¡œ wetubeë¥¼ ì‚¬ìš©í•˜ëŠ” ë°ì´í„°ë¡œ ì§€ì •í•œë‹¤. ê·¸ ë‹¤ìŒì— <code class="language-plaintext highlighter-rouge">db.sessions.remove({})</code>ë¥¼ ì…ë ¥í•˜ë©´ ì„¸ì…˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ì§€ìš¸ ìˆ˜ ìˆë‹¤. ê°™ì€ ë°©ë²•ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">db.users.remove({})</code>ë¡œ ì‚¬ìš©ì ì •ë³´ë„ ëª¨ë‘ ì§€ì›Œì¤€ë‹¤.</p>

<p>ê·¸ë¦¬ê³  ìƒˆë¡œ íšŒì›ê°€ì…ì„ í•´ ì¤€ ë‹¤ìŒ, edit-profileì— ë“¤ì–´ê°€ë©´ ì†Œì…œ ë¡œê·¸ì¸ ë•ŒëŠ” ë³¼ ìˆ˜ ì—†ì—ˆë˜ Change Passwordë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° ì•ìœ¼ë¡œë„ ì†Œì…œ ë¡œê·¸ì¸ê³¼, ì¼ë°˜ ë¡œê·¸ì¸ì„ ë‚˜ëˆ ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ë§ì„ ìˆ˜ë„ ìˆë‹¤. ì´ ê²½ìš°ì—” ì†Œì…œ ë¡œê·¸ì¸ í•œ ê²½ìš°ì™€ ì•„ë‹Œ ê²½ìš°ë¥¼ ë‚˜ëˆ ì£¼ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì£¼ë©´ ë”ìš± í¸í•  ê²ƒì´ë‹¤. ìš°ë¦¬ëŠ” ì•„ì§ì€ í•„ìš”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¶”ê°€í•˜ì§€ëŠ” ì•Šê² ë‹¤. ë§Œì•½ ë§Œë“ ë‹¤ë©´ passwordOnly ê°™ì´ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì¶”ê°€í•˜ë©´ ëœë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ postChangePasswordë¥¼ ì™„ì„±ì‹œì¼œì•¼ í•œë‹¤. ìš°ì„ ì€ formì—ì„œ ë³´ë‚´ì£¼ëŠ” ì •ë³´ë¥¼ ë°›ì•„ì£¼ê³ , í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ë¥¼ ì•Œì•„ë‚´ì•¼ í•œë‹¤. _idëŠ” req.session.userì— ìˆê³ , formì—ì„œ ë³´ë‚´ì¤€ ì •ë³´ëŠ” req.bodyì— ë“¤ì–´ ìˆë‹¤. ì´ì „ì— postEditì—ì„œ í•œ ê²ƒì²˜ëŸ¼ ì‘ì„±í•˜ë©´ ê°„ë‹¨í•˜ê²Œ ë°ì´í„°ë¥¼ ë°›ì•„ ì˜¨ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const postChangePassword = async (req, res) =&gt; {
    const {
        session: {
            user: { _id },
        },
        body: { oldPassword, newPassword, newPasswordConfirmation },
    } = req;
    return res.redirect("/");
};
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ í•´ì•¼ í•  ì¼ì€ ìƒˆë¡œ ë§Œë“¤ ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ì€ì§€ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ë‹¤. ë§Œì•½ ë¹„ë°€ë²ˆí˜¸ê°€ ë‹¤ë¥´ë‹¤ë©´ errorMessageë¥¼ ì „ì†¡í•˜ê²Œ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ë˜í•œ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìœ¼ë¯€ë¡œ status(400)ìœ¼ë¡œ ë¸Œë¼ìš°ì €ê°€ ì‹¤íŒ¨í–ˆìŒì„ ì¸ì§€í•˜ê²Œ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  view íŒŒì¼ë„ ìˆ˜ì •í•´ì„œ errorMessageë¥¼ ì¶œë ¥í•˜ê²Œ ë§Œë“¤ì–´ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    ...
    const {
        ...
    } = req;
    if (newPassword !== newPasswordConfirmation) {
        return res.status(400).render("users/change-password", {
            pageTitle: "Change Password",
            errorMessage: "The password does not match the confirmation",
        });
    }
    ...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// change-password.pug
block content
    if errorMessage
        span #{errorMessage}
    ...
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ oldPasswordê°€ ì¼ì¹˜í–ˆëŠ”ì§€ë¥¼ í™•ì¸í•´ì•¼ í•œë‹¤. ì´ëŠ” ì´ì „ì— bcryptë¡œ í•´ê²°í•œ ì ì´ ìˆë‹¤. ê°™ì€ ë°©ì‹ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  req.session.user.passwordê°€ í•„ìš”í•˜ë¯€ë¡œ ë°›ì•„ì™€ì£¼ê³ , bcrypt.compare()ë¡œ ë¹„êµí•´ì¤€ë‹¤. ê·¸ í›„ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ìœ„ì™€ ë™ì¼í•˜ê²Œ í•˜ë˜, ì—ëŸ¬ ë©”ì„¸ì§€ë§Œ ìˆ˜ì •í•´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const postChangePassword = async (req, res) =&gt; {
    const {
        session: {
            // get password
            user: { _id, password },
        },
        body: { oldPassword, newPassword, newPasswordConfirmation },
    } = req;
    // use bcrypt to check password
    const ok = await bcrypt.compare(oldPassword, password);
    // and, if !ok show errorMessage
    if (!ok) {
        return res.status(400).render("users/change-password", {
            pageTitle: "Change Password",
            errorMessage: "The current password is incorrect",
        });
    }
    if (newPassword !== newPasswordConfirmation) {
        return res.status(400).render("users/change-password", {
            pageTitle: "Change Password",
            errorMessage: "The password does not match the confirmation",
        });
    }
    return res.redirect("/");
};
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ ëª¨ë“  ê²ƒì´ ì¼ì¹˜í•œë‹¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì¤˜ì•¼ í•œë‹¤. ì´ì „ì— ìš°ë¦¬ëŠ” User ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ ë•Œ, preë¡œ ì €ì¥í•˜ê¸° ì „ì— í•´ì‹œí•¨ìˆ˜ë¡œ ì•”í˜¸í™” í•˜ëŠ” ê³¼ì •ì„ ì¶”ê°€í•´ì¤¬ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìš°ë¦¬ê°€ <code class="language-plaintext highlighter-rouge">user.save();</code>ë§Œ ì‚¬ìš©í•˜ë”ë¼ë„ ì•Œì•„ì„œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•”í˜¸í™” í•œë‹¤. ê·¸ëŸ°ë° ìš°ë¦¬ëŠ” ì•„ì§ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¿”ì£¼ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¿”ì¤€ ë‹¤ìŒì— ì €ì¥í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì‚¬ìš©ìë¥¼ _idë¡œ ì°¾ì•„ì™€ì„œ passwordë¥¼ newPasswordë¡œ ë°”ê¿”ì¤€ ë‹¤ìŒì— ì €ì¥í•˜ë„ë¡ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const postChangePassword = async (req, res) =&gt; {
    ...
    const user = await User.findById(_id);
    user.password = newPassword;
    await user.save();
    return res.redirect("/");
};
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°”ê¿€ ê²½ìš° ê°•ì œë¡œ ë¡œê·¸ì•„ì›ƒ ì‹œí‚¤ê³  ë‹¤ì‹œ ë¡œê·¸ì¸ í•˜ë„ë¡ ë§Œë“¤ì–´ë³´ì. ì´ ê²½ìš°ëŠ” ê°„ë‹¨í•˜ë‹¤. <code class="language-plaintext highlighter-rouge">return res.redirect("/users/logout");</code>ìœ¼ë¡œ ë³´ë‚´ì£¼ê¸°ë§Œ í•˜ë©´ ëœë‹¤. ì´ë ‡ê²Œí•˜ë©´ ì™„ì„±ì´ë‹¤.</p>

<p>ê·¸ëŸ°ë° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì—¬ëŸ¬ ë²ˆ ë°”ê¾¸ë ¤ê³  í•˜ë©´ The current password is incorrectë¼ëŠ” ë¬¸êµ¬ê°€ ë‚˜ì˜¨ë‹¤. ë‹¤ì‹œ ë§í•´ì„œ oldPasswordì™€ passwordê°€ ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì´ë‹¤. ì™œ ì´ëŸ° ì¼ì´ ë°œìƒí•˜ëŠ” ê²ƒì¼ê¹Œ?</p>

<p>ì´ëŠ” ìš°ë¦¬ê°€ oldPasswordì™€ ì„¸ì…˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¹„êµí•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•œë‹¤. ìš°ë¦¬ëŠ” ì„¸ì…˜ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°›ì•„ì™€ì„œ ê²€ì¦í•˜ëŠ”ë° ì‚¬ìš©í•˜ì§€ë§Œ, ì •ì‘ ì„¸ì…˜ì€ ì—…ë°ì´íŠ¸ í•˜ì§€ ì•Šì•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¹„êµí•  ë•Œ, ì„¸ì…˜ì— ìˆëŠ ì´ì „ì˜ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¹„êµí•˜ê²Œ ë˜ê³ , ì—ëŸ¬ ë©”ì„¸ì§€ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì´ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì„¸ì…˜ì„ ì—…ë°ì´íŠ¸ í•´ì¤˜ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    ...
    await user.save();
    // update session's password
    req.session.user.password = user.password;
    ...
</code></pre></div></div>

<p>ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œëŠ” _idë¡œ ì‚¬ìš©ìë¥¼ ì°¾ëŠ” ë¶€ë¶„ì„ íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦í•˜ëŠ” ê³³ ë³´ë‹¤ ë¨¼ì € ì‚¬ìš©í•œ ë‹¤ìŒ, password ëŒ€ì‹ ì— user.passwordë¥¼ ì‚¬ìš©í•´ë„ ëœë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì„¸ì…˜ì—ì„œ ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ DBì—ì„œ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì—, ì„¸ì…˜ì„ ì—…ë°ì´íŠ¸í•´ì¤„ í•„ìš”ê°€ ì—†ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const postChangePassword = async (req, res) =&gt; {
  const {
    session: {
      user: { _id },
    },
    body: { oldPassword, newPassword, newPasswordConfirmation },
  } = req;
  // find user by _id
  const user = await User.findById(_id);
  // We can use user.password to confirm oldPassword.
  const ok = await bcrypt.compare(oldPassword, user.password);
  if (!ok) {
    return res.status(400).render("users/change-password", {
      pageTitle: "Change Password",
      errorMessage: "The current password is incorrect",
    });
  }
  if (newPassword !== newPasswordConfirmation) {
    return res.status(400).render("users/change-password", {
      pageTitle: "Change Password",
      errorMessage: "The password does not match the confirmation",
    });
  }
  // We don't need to find _id here.
  user.password = newPassword;
  await user.save();
  return res.redirect("/users/logout");
};
</code></pre></div></div>

<h3 id="86-file-uploads-part-one">8.6 File Uploads part One</h3>

<p>ì–´ë–»ê²Œ íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ëŠ”ì§€ ì•Œì•„ë³´ì. ì‚¬ìš©ìì˜ ì•„ë°”íƒ€ìš© ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ë ¤ê³  í•œë‹¤. ìš°ì„  ë‹¹ì—°íˆ ë¡œê·¸ì¸ í•œ ê²½ìš°ì— edit-profileì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ì¹¸ì„ ë§Œë“¤ì–´ì£¼ì. ê·¸ëŸ¬ê¸° ìœ„í•´ì„œëŠ” inputì— ì†ì„±ìœ¼ë¡œ type=â€fileâ€ë¡œ ì§€ì •í•´ì„œ ë§Œë“¤ë©´ ëœë‹¤. ë‹¤ë§Œ ìš°ë¦¬ëŠ” ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì¶”ê°€í•˜ê¸°ë¥¼ ì›í•˜ë¯€ë¡œ accept=â€image/*â€œë¥¼ ì¶”ê°€í•´ì£¼ë„ë¡ í•˜ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// edit-profile.pug
block content
    form(method="POST")
        label(for="avatar") Avatar
        input(type="file", name="avatar", id="avatar", accept="image/*")
        ...
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ìš°ë¦¬ëŠ” <a href="https://www.npmjs.com/package/multer">multer</a>ì´ë¼ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•œë‹¤. multerì€ íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ë„ë¡ ë„ì™€ì£¼ëŠ”ë°, formìœ¼ë¡œ ì œì¶œí•œ íŒŒì¼ì„ reqì— file ë˜ëŠ” filesì— ë„£ì–´ì¤€ë‹¤. multerë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">npm i multer</code>ë¡œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì¤€ë‹¤. multerë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ formì„ <strong>multipart/form-data</strong>ë¡œ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. ìœ„ì˜ formìœ¼ë¡œ ëŒì•„ê°€ì„œ enctype=â€multipart/form-dataâ€ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤. ì´ ì†ì„±ì€ formì˜ ì¸ì½”ë”© ë°©ë²•ì„ ë°”ê¿”ì£¼ê¸° ë•Œë¬¸ì— ìŠì–´ë²„ë ¤ì„œëŠ” ì•ˆ ëœë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ ìš°ë¦¬ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤. middlewares.jsì— ê°€ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ë° uploadFilesë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë§Œë“¤ì. ê·¸ëŸ°ë° ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” req, resë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ì‹  dest, fileFilter, limits, preservePathë¥¼ ì‚¬ìš©í•œë‹¤. destëŠ” ë§ ê·¸ëŒ€ë¡œ íŒŒì¼ì„ ì–´ë””ì— ì €ì¥ì‹œí‚¬ì§€ë¥¼ ì§€ì •í•˜ëŠ” ê²ƒì´ë‹¤. ì¶”í›„ì— ìì„¸íˆ ì„¤ëª…í•˜ê² ì§€ë§Œ í•˜ë“œì— ì§ì ‘ ì €ì¥í•˜ëŠ” ê²ƒì€ ê·¸ë¦¬ ì¢‹ì€ ë°©ë²•ì´ ì•„ë‹ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆì€ í•˜ë“œì— ì €ì¥ì‹œí‚¤ê³  ë‚˜ì¤‘ì— ë°”ê¿”ì£¼ë„ë¡ í•˜ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// middlewares.js
import multer from "multer";
...
export const uploadFiles = multer({
   dest: "uploads/"
});
</code></pre></div></div>

<p>ë‚˜ëŠ” ìœ„ì˜ í´ë”ê°€ ìë™ìœ¼ë¡œ ìƒê²¨ì„œ ì•„ë¬´ëŸ° ë¬¸ì œ ì—†ì—ˆì§€ë§Œ, í˜¹ì‹œë¼ë„ ìƒê¸°ì§€ ì•ŠëŠ”ë‹¤ë©´ ì§ì ‘ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•´ë³´ê² ë‹¤. ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ê³³ì€ edit-profileì´ postë˜ëŠ” ê³³ì´ë‹¤. ì‚¬ìš©ë˜ëŠ” ìˆœì„œëŠ” <code class="language-plaintext highlighter-rouge">app.post("/profile", upload.single("avatar"), function (req, res, next){})</code> í˜•íƒœê°€ ë˜ë©´ ëœë‹¤. ë‹¤ì‹œ ë§í•´ url, ë¯¸ë“¤ì›¨ì–´, ì»¨íŠ¸ë¡¤ëŸ¬ ìˆœìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•œë‹¤. ìš°ë¦¬ëŠ” urlì„ ì•ì— routeì— ì ì–´ì¤¬ê¸° ë•Œë¬¸ì— post ì•ˆì— ë¯¸ë“¤ì›¨ì–´, ì»¨íŠ¸ë¡¤ëŸ¬ë§Œ ì ì–´ì£¼ë©´ ëœë‹¤. ë¯¸ë“¤ì›¨ì–´ë¥¼ ì ì–´ì¤„ ë•Œ, single, array, fieldsë¥¼ ì§€ì •í•  ìˆ˜ ìˆëŠ”ë°, ê°ê° í•˜ë‚˜ì˜ íŒŒì¼, array íŒŒì¼, object íŒŒì¼ì´ë‹¤. ìš°ë¦¬ëŠ” ì´ë¯¸ì§€ íŒŒì¼ í•˜ë‚˜ë§Œ ì˜¬ë¦´ ê²ƒì´ê¸° ë•Œë¬¸ì— uploadFiles.single()ì„ ì‚¬ìš©í•œë‹¤. ì´ë•Œ, single ì•ˆì— ë“¤ì–´ê°€ëŠ” ë¬¸ìëŠ” formì—ì„œ ë°›ì•„ì˜¤ëŠ” inputì˜ nameì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì•„ë˜ì²˜ëŸ¼ ì ì–´ì¤˜ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
...
userRouter
  .route("/edit")
  .all(protectorMiddleware)
  .get(getEdit)
  .post(uploadFiles.single("avatar"), postEdit);
...
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ multer ë¯¸ë“¤ì›¨ì–´ì˜ ì‘ë™ ë°©ë²•ì„ ì„¤ëª…í•´ì•¼ í•œë‹¤. multerì€ formì—ì„œ íŒŒì¼ì„ ë°›ì•„ì˜¤ê³  uploadFilesë¥¼ ì‹¤í–‰ì‹œì¼œì„œ ê·¸ íŒŒì¼ì„ í´ë”ì— ì €ì¥í•œë‹¤. ê·¸ í›„ ì €ì¥í•œ ì •ë³´ë¥¼ postEditì— ì „ë‹¬í•´ì¤€ë‹¤. ì´ë ‡ê²Œ ì¶”ê°€í•œ ì •ë³´ëŠ” req.fileì—ì„œ ì°¾ì„ ìˆ˜ ìˆë‹¤. postEditì—ì„œ console.log(req.file)ì„ ì ì–´ì£¼ê³ , íŒŒì¼ì„ ì—…ë¡œë“œ í–ˆì„ ë•Œ ì½˜ì†”ì— ì íˆëŠ” ê²ƒì„ í™•ì¸í•´ë³´ì. ê·¸ ì¤‘ì—ì„œ pathê°€ ì¤‘ìš”í•œë°, ìš°ë¦¬ê°€ User ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ ë•Œ, ì•„ë°”íƒ€ urlì„ ë§Œë“¤ì—ˆë‹¤. ì—¬ê¸°ì—ë‹¤ê°€ ì½˜ì†”ì— ë‚˜ì˜¨ pathë¥¼ ì ì–´ì£¼ë©´ í•´ë‹¹ ì‚¬ìš©ìì™€ íŒŒì¼ì´ ì—°ê²°ë˜ê²Œ ëœë‹¤. ì´ì— ê´€í•œ ê²ƒì€ ë‹¤ìŒì— ê³„ì†í•˜ê² ë‹¤.</p>

<h3 id="87-file-uploads-part-two">8.7 File Uploads part Two</h3>

<p>ì–´ë–»ê²Œ í•˜ë©´ íŒŒì¼ì„ ì‚¬ìš©ìì™€ ì—°ê²° ì‹œí‚¬ ìˆ˜ ìˆì„ë¼? ì²˜ìŒ ë“œëŠ” ìƒê°ì€ req.file.pathë¥¼ ê°€ì ¸ì™€ì„œ findByIdAndUpdateë¥¼ ì‚¬ìš©í•  ë•Œ, ê°™ì´ ë„£ì–´ì„œ ì—…ë°ì´íŠ¸ í•´ì£¼ë©´ ë  ê²ƒ ê°™ë‹¤. ê·¸ëŸ°ë° ì‚¬ìš©ìê°€ ì•„ë°”íƒ€ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì–´ë–»ê²Œ ë ê¹Œ? ì•„ë°”íƒ€ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë‹¤ë©´ fileì´ undefinedì´ë¯€ë¡œ pathê°€ ì¡´ì¬í•˜ì§€ ì•Šì•„ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ req.file.pathë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ req.fileì„ ê°€ì ¸ì™€ì•¼ í•œë‹¤. í•˜ì§€ë§Œ ì—¬ì „íˆ fileì´ undefinedì¸ ê²½ìš°ì—” ì—…ë°ì´íŠ¸ í•´ì£¼ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì„¸ì…˜ì˜ user ì •ë³´ë¥¼ í™œìš©í•´ì•¼ í•œë‹¤.</p>

<p>ìš°ì„  req.session.userì—ì„œ avatarUrlì„ ë°›ì•„ì˜¨ë‹¤. ê·¸ë¦¬ê³  findByInAndUpdate ì•ˆì—ì„œ avatarUrlì„ ì—…ë°ì´íŠ¸ í•˜ë˜, ì‚¼í•­ ì—°ì‚°ìë¥¼ ì‚¬ìš©í•´ì„œ fileì´ undefinedì¸ ê²½ìš°ì—” avatarUrlì„ ê·¸ëŒ€ë¡œ ë„£ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const postEdit = async (req, res) =&gt; {
  const {
    session: {
        // get avatarUrl
        user: { _id, avatarUrl },
    },
    body: { name, email, username, location },
    // get file
    file,
  } = req;
  ...
  const updatedUser = await User.findByIdAndUpdate(
    _id,
    {
        ...
        // use ternary operator to update avatarUrl
        // if file exists then update url
        // else it uses same avatarurl
        avatarUrl: file ? file.path : avatarUrl,
      ...
    }
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ commit í•˜ê¸° ì „ì— .gitignoreì— /uploads í´ë”ë¥¼ ì¶”ê°€í•´ì„œ íŒŒì¼ì´ ì»¤ë°‹ ë˜ëŠ” ê²ƒì„ ë§‰ì•„ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// .gitignore
/node_modules
.env
/uploads
</code></pre></div></div>

<p>ì´ë ‡ê²Œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ëŠ” ê²ƒì„ ì™„ë£Œí–ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ìš°ë¦¬ëŠ” íŒŒì¼ì„ DBì— ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ì‹ ì— íŒŒì¼ì˜ ìœ„ì¹˜ë¥¼ DBì— ì €ì¥í•˜ê³ , íŒŒì¼ì€ ë”°ë¡œ uploadsì— ì €ì¥í•œë‹¤. ë‹¤ì‹œ ë§í•´ DBì—ëŠ” íŒŒì¼ì„ ì €ì¥í•˜ì§€ ì•Šê³  ì˜¤ì§ ê·¸ ìœ„ì¹˜ë§Œì„ ì €ì¥í•´ì•¼ í•œë‹¤. DBëŠ” íŒŒì¼ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ê³µê°„ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì´ë‹¤.</p>

<p>ì´ì œ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ê°€ ë³´ì´ë„ë¡ edit-profileì„ ìˆ˜ì •í•´ì£¼ì. ê·¸ëŸ°ë° imgì˜ src ì†ì„±ì„ ì‚¬ìš©í•  ë•Œ, loggedInUser.avatarUrlì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ìƒëŒ€ urlë¡œ íŒë‹¨í•´ì„œ users/uploadsì—ì„œ íŒŒì¼ì„ ì°¾ê²Œ ëœë‹¤. ê·¸ëŸ°ë° uploads í´ë”ëŠ” /uploadsì— ìˆìœ¼ë¯€ë¡œ, ì ˆëŒ€ urlì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// edit-profile.pug
...
block content
    img(src="/" + loggedInUser.avatarUrl, width="100", height="100")
    ...
</code></pre></div></div>

<p>í•˜ì§€ë§Œ ì´ë ‡ê²Œ ì‘ì„±í•´ì¤˜ë„ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ ì´ìœ ëŠ” ì´ë¯¸ì§€ë¥¼ ë°›ì•„ì™€ì•¼í•  urlì„ ë¼ìš°í„°ë‚˜ ì‚¬ìš©í•´ì•¼ í•  í´ë”ë¡œ ì§€ì •í•œ ì ë„ ì—†ê¸° ë•Œë¬¸ì— ìµìŠ¤í”„ë ˆìŠ¤ê°€ ì²˜ë¦¬í•˜ì§€ ëª»í•˜ê¸° ë•Œë¬¸ì´ë‹¤.</p>

<h3 id="88-static-fiels-and-recap">8.8 Static Fiels and Recap</h3>

<p>ì´ì œ ë¸Œë¼ìš°ì €ê°€ uploads í´ë”ì— ìˆëŠ” íŒŒì¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. ì™œ ì´ëŸ° ì¼ì„ í•´ì•¼ í•˜ëƒë©´, ë§Œì•½ ë¸Œë¼ìš°ì €ê°€ ì–´ë–¤ í´ë”ë“  ê°ˆ ìˆ˜ ìˆë‹¤ê³  í•˜ë©´, ë³´ì•ˆìƒ ì¢‹ì§€ ëª»í•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì‚¬ìš©í•˜ëŠ” í´ë”ë¥¼ ë”°ë¡œ ì§€ì •í•´ì£¼ë„ë¡ ë§Œë“¤ì–´ì ¸ìˆë‹¤. ê·¸ëŸ¬ê¸° ìœ„í•´ì„œ static files servingì´ë¼ëŠ” ê²ƒì„ í™œì„±í™” ì‹œí‚¨ë‹¤. ì´ëŠ” í´ë” ì „ì²´ë¥¼ ë¸Œë¼ìš°ì €ì—ê²Œ ë…¸ì¶œ ì‹œí‚¤ëŠ” ê¸°ëŠ¥ì´ë‹¤.</p>

<p>ìš°ì„  /upload ë¼ìš°í„°ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  í´ë”ë¥¼ ë…¸ì¶œì‹œí‚¤ê¸° ìœ„í•´ express.static()ì„ ì‚¬ìš©í•œë‹¤. staticì—ëŠ” ë…¸ì¶œì‹œí‚¤ê³  ì‹¶ì€ í´ë”ë¥¼ ì ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// server.js
...
app.use(localsMiddleware);
app.use("/uploads", express.static("uploads"));
app.use("/", rootRouter);
...
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ê³  ë‹¤ì‹œ edit-profileì„ í™•ì¸í•´ë³´ë©´ ì•„ë°”íƒ€ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<p>ìš”ì•½í•˜ë©´ ìš°ë¦¬ê°€ ì›í•˜ë˜ ê²ƒì€ íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ëŠ” ê²ƒì´ì—ˆë‹¤. ê·¸ë˜ì„œ multerì„ ì‚¬ìš©í•´ íŒŒì¼ì„ ë°›ì•„ì˜¤ê²Œ ë§Œë“¤ì—ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ formì„ ë§Œë“¤ì–´ì„œ ì´ë¯¸ì§€ë¥¼ ë°›ì•„ì˜¤ê³  ì„œë²„ì— ì €ì¥í–ˆë‹¤. multer ë¯¸ë“¤ì›¨ì–´ëŠ” ë°›ì•„ì˜¨ íŒŒì¼ì˜ ì •ë³´ë¥¼ ë‹¤ìŒ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ reqì— ë„£ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤. ìš°ë¦¬ëŠ” reqì—ì„œ fileì„ ë°›ì•„ì™”ë‹¤. ì´ fileì€ ì‚¬ìš©ìê°€ ì—…ë¡œë“œ í–ˆì„ ìˆ˜ë„ ì•ˆ í–ˆì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì‚¼í•­ ì—°ì‚°ìë¥¼ ì‚¬ìš©í•´ì„œ undefinedì¸ ê²½ìš°ì—ë„ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë§Œë“¤ì—ˆë‹¤. ê·¸ë¦¬ê³  avartarUrlì„ ë°›ì•„ì™”ì§€ë§Œ ì•„ì§ ë¸Œë¼ìš°ì €ëŠ” ì´ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ ëª¨ë¥¸ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ express.static()ìœ¼ë¡œ í´ë”ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ì¤¬ë‹¤. ê·¸ ê²°ê³¼ edit-profileì—ì„œ ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤.</p>

<p>ê·¸ëŸ°ë° ë¬¸ì œê°€ ìˆë‹¤. ìš°ë¦¬ê°€ ìƒˆë¡œ íŒŒì¼ì„ ì—…ë¡œë“œí•  ë•Œë§ˆë‹¤ ìƒˆë¡œ íŒŒì¼ì´ ìƒê¸°ê³ , ì´ì „ì˜ íŒŒì¼ì€ ì‚­ì œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ íŒŒì¼ì´ ê³„ì† ìŒ“ì´ê²Œ ëœë‹¤. ë˜í•œ íŒŒì¼ì´ ì„œë²„ì— ì €ì¥ë˜ê³  ìˆë‹¤ëŠ” ì ë„ ë¬¸ì œë‹¤. ì„œë²„ëŠ” ê³„ì† ì¢…ë£Œë˜ê³  ë‹¤ì‹œ ì‹œì‘ë˜ê¸° ë•Œë¬¸ì—, ì—…ë¡œë“œí•˜ë©´ ê·¸ ì „ ì„œë²„ì˜ ì €ì¥ëœ íŒŒì¼ë“¤ì´ ì‚¬ë¼ì§€ê²Œ ëœë‹¤. ë˜í•œ ì—¬ëŸ¬ ì„œë²„ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë©´ í•œ ì„œë²„ê°€ ë‹¤ìš´ë˜ì—ˆì„ ë•Œ, ê·¸ ì„œë²„ì— ì €ì¥ëœ íŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ëœë‹¤. ë‚˜ì¤‘ì— ì´ ë°©ë²•ì„ ê³ ì³ì„œ ì„œë²„ê°€ ë‹¤ì‹œ ì‹œì‘ë¼ë„ íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ìˆê²Œ ë§Œë“¤ê² ë‹¤.</p>

<h3 id="89-video-upload">8.9 Video Upload</h3>

<p>ì´ë²ˆì—ëŠ” ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œ í•˜ëŠ” ê²ƒì„ ì¶”ê°€í•´ë³´ê² ë‹¤. ì•ì„œ ì´ë¯¸ì§€ì—ì„œ í–ˆë˜ ê²ƒì„ ê·¸ëŒ€ë¡œ ë¹„ë””ì˜¤ë¡œ í•œë‹¤ê³  ë³´ë©´ ëœë‹¤. ìš°ì„  ìƒ˜í”Œ ë¹„ë””ì˜¤ê°€ í•˜ë‚˜ í•„ìš”í•˜ë‹¤. ìƒ˜í”Œ ë¹„ë””ì˜¤ëŠ” <a href="https://sample-videos.com/">sample-video</a>ì—ì„œ ì›í•˜ëŠ” ì‚¬ì–‘ìœ¼ë¡œ ë°›ì„ ìˆ˜ ìˆìœ¼ë‹ˆ í•˜ë‚˜ ì¤€ë¹„í•˜ì.</p>

<p>upload.pugì— ë“¤ì–´ê°€ì„œ ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œí•˜ëŠ” ê²ƒì„ ì¶”ê°€í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// upload.pug
block content
    if errorMessage
        span=errorMessage
    form(method="POST", enctype="multipart/form-data")
        label(for="video") Video File
        input(type="file", accept="video/*", required, id="video", name="video")
        ...
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ videoRouter.jsì— ë“¤ì–´ê°€ì„œ /uploadì˜ postì— uploadFiles ë¯¸ë“¤ì›¨ì–´ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import {
    ...
    uploadFiles,
} from "../middlewares";

...
userRouter
  .route("/upload")
  .all(protectorMiddleware)
  .get(getUpload)
  // add uploadFiles middleware
  .post(uploadFiles.single("video"), postUpload);
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ multerì˜ ì˜µì…˜ì„ ì†Œê°œí•´ì•¼ í•œë‹¤. multerëŠ” íŒŒì¼ì˜ í¬ê¸°ë¥¼ ì œí•œí•  ìˆ˜ ìˆë‹¤. fileSizeë¼ëŠ” ì˜µì…˜ì¸ë°, ì´ë¥¼ ì‚¬ìš©í•´ì„œ ì´ë¯¸ì§€ëŠ” 3MBì´í•˜ë¡œ, ë¹„ë””ì˜¤ëŠ” 10MB ì´í•˜ë¡œ ì œí•œí•˜ê² ë‹¤. ê·¸ë˜ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë‚˜ëˆ ì„œ ìš©ëŸ‰ì„ ì œí•œí•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ 2ê°œë¡œ ë§Œë“¤ê² ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// middlewares.js

expot const avatarUpload = multer({
    dest: "uploads/avatars/",
    limits: {
        fileSize: 300000,
    },
});

export const videoUpload = multer({
    dest: "uploads/videos/",
    limits: {
        fileSize: 10000000,
    },
});
</code></pre></div></div>

<p>ë¯¸ë“¤ì›¨ì–´ì˜ ì´ë¦„ì„ ë°”ê¿¨ìœ¼ë¯€ë¡œ ê·¸ì— ë§ì¶”ì–´ ì´ë¦„ì„ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
import {
    ...
    avatarUpload,
} from "../middlewares";
...
userRouter
    .route("/edit")
    .all(protectorMiddleware)
    .get(getEdit)
    // change middleware's name
    .post(avatarUpload.single("avatar"), postEdit);
...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoRouter.js
import {
    ...
    videoUpload
} from "../middlewares";
...
videoRouter
  .route("/upload")
  .all(protectorMiddleware)
  .get(getUpload)
  .post(videoUpload.single("video"), postUpload);
...
</code></pre></div></div>

<p>íŒŒì¼ì˜ í¬ê¸°ì— ë”°ë¼ ìˆ«ìë¥¼ ë°”ê¿”ê°€ë©° íŒŒì¼ì´ ì—…ë¡œë“œ ë˜ëŠ”ì§€ ì•„ë‹Œì§€ í…ŒìŠ¤íŠ¸ í•´ë³´ì. ë§Œì•½ íŒŒì¼ì´ ë„ˆë¬´ í¬ë‹¤ë©´ ì—ëŸ¬ê°€ ë°œìƒí•´ì„œ í˜ì´ì§€ê°€ ëœë”ë§ ë˜ì§€ ì•ŠëŠ”ë‹¤. ìš°ë¦¬ëŠ” ì—ëŸ¬ë§Œ ë³´ë‚´ê³  í˜ì´ì§€ëŠ” ëœë”ë§ ë˜ê²Œ í•˜ê³  ì‹¶ê¸° ë•Œë¬¸ì— ë‚˜ì¤‘ì— ì´ ë¬¸ì œë¥¼ ìˆ˜ì •í•´ë³´ê² ë‹¤.</p>

<p>ìš°ì„ ì€ postUploadì—ì„œ ë¹„ë””ì˜¤ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ë§Œë“¤ì–´ì£¼ë ¤ê³  í•œë‹¤. ê·¸ ì „ì— videoSchemaë¥¼ ë³´ë©´ ìš°ë¦¬ëŠ” ë¹„ë””ì˜¤ì˜ urlì„ ì†ì„±ìœ¼ë¡œ ë„£ì–´ì£¼ì§€ ì•Šì•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ì •í•´ì„œ fileUrlì„ ì†ì„±ìœ¼ë¡œ ê°€ì§€ë„ë¡ ë§Œë“ ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Video.js
const videoSchema = new mongoose.Schema({
  title: { type: String, required: true, trim: true, maxLength: 80 },
  fileUrl: { type: String, required: true },
  description: { type: String, required: true, trim: true, minLength: 20 },
  ...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js

export const postUpload = async (req, res) =&gt; {
    // get fileUrl from req.file.path
    const file = req.file;
    const { title, description, hashtags } = req.body;
    try {
        await Video.create({
        title,
        description,
        // We add fileUrl on the videoSchema.
        // So, we can create video with fileUrl
        fileUrl: file.path,
        hashtags: Video.formatHashtags(hashtags),
        });
        return res.redirect("/");
    } catch (error) {
        console.log(error);
        return res.status(400).render("upload", {
        pageTitle: "Upload Video",
        errorMessage: error._message,
        });
    }
};
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ ë¹„ë””ì˜¤ê°€ ë‚˜ì˜¤ë„ë¡ watch.pugì— ë§Œë“¤ì–´ì¤€ë‹¤. videoì— srcë¥¼ ì¶”ê°€í•´ì£¼ë©´ ë¹„ë””ì˜¤ê°€ ìƒì„±ëœë‹¤. ì—¬ê¸°ë‹¤ê°€ controlsë¥¼ ì¶”ê°€í•´ì„œ ì¬ìƒ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
block content
    video(src="/" + video.fileUrl, controls)
    ...
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ postUpload ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì¡°ê¸ˆ ìˆ˜ì •í•˜ê² ë‹¤. fileì„ ë°›ì•„ì˜¤ëŠ” ëŒ€ì‹ ì— <code class="language-plaintext highlighter-rouge">{ path } = req.file</code>ì„ ì‚¬ìš©í•˜ë©´ <code class="language-plaintext highlighter-rouge">fileUrl: path,</code>ë¡œ ì¤„ì¼ ìˆ˜ ìˆë‹¤. ì•„ë‹ˆë©´ ES6ë¥¼ ì‚¬ìš©í•´ì„œ ì•„ë˜ì²˜ëŸ¼ ì¤„ì¼ ìˆ˜ë„ ìˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js

export const postUpload = async (req, res) =&gt; {
    // We can make a path to fileUrl
    const { path: fileUrl } = req.file;
    ...
    try {
        // We can shortcut fileUrl: path, to fileUrl.
        fileUrl,
    }
    ...
};
</code></pre></div></div>

<h3 id="810-user-profile">8.10 User Profile</h3>

<p>ì´ë²ˆì—ëŠ” í”„ë¡œí•„ í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ë³´ê² ë‹¤. í”„ë¡œí•„ í˜ì´ì§€ì—ì„œëŠ” ì´ë¦„ê³¼ ì•„ë°”íƒ€ ê°™ì€ ê¸°ë³¸ì ì¸ ì •ë³´ ë¿ë§Œ ì•„ë‹ˆë¼, ì—…ë¡œë“œí•œ ë¹„ë””ì˜¤ë„ ë³¼ ìˆ˜ ìˆê²Œ ë§Œë“¤ê² ë‹¤. ê·¸ë¦¬ê³  ì˜ìƒì„ í‹€ë©´ ëˆ„ê°€ ê·¸ ì˜ìƒì„ ì˜¬ë ¸ëŠ”ì§€ ì•Œë ¤ì£¼ê³ , í•´ë‹¹ ë™ì˜ìƒì˜ ì†Œìœ ìê°€ ì•„ë‹ˆë¼ë©´ edit, delete ê¸°ëŠ¥ì„ ì“¸ ìˆ˜ ì—†ë„ë¡ ë§Œë“¤ê² ë‹¤.</p>

<p>ìš°ë¦¬ê°€ ë§Œë“  ë¹„ë””ì˜¤ë¥¼ ë³´ë©´ ì†Œìœ ì ì •ë³´ê°€ ì—†ë‹¤. ë˜í•œ ì‚¬ìš©ìë„ ì–´ë–¤ ë¹„ë””ì˜¤ë¥¼ ì˜¬ë ¸ëŠ”ì§€ ì •ë³´ê°€ ì—†ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ë¹„ë””ì˜¤ì— ì†Œìœ ìë¥¼ í•œ ëª… ë§Œë“¤ê³ , ì‚¬ìš©ìëŠ” ì—…ë¡œë“œí•œ ë¹„ë””ì˜¤ë¥¼ ì—¬ëŸ¬ ê°œ ê°€ì§€ë„ë¡ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ì´ë¥¼ ìœ„í•´ ìš°ë¦¬ ëª¨ë¸ì„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.</p>

<p>ëª¨ë¸ì„ ìˆ˜ì •í•˜ê¸° ì•ì„œ ëª¨ë¸ì„ ë³´ì—¬ì£¼ëŠ” í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ì•¼ í™•ì¸í•˜ê¸° ì‰½ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ base.pugì—ì„œ í”„ë¡œíŒŒì¼ í˜ì´ì§€ë¡œ ê°€ëŠ” ë§í¬ë¥¼ ë§Œë“¤ì–´ ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// base.pug
    if loddgeIn
        li
            ...
        li
            a(href=`/users/${loggedInUser._id}`) My Profile
        ...
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  userRouter.jsì˜ ë¼ìš°í„°ë„ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
...
userRotuer.get("/:id", see);
...
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  see ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤. ìš°ì„ ì€ idë¥¼ ê°€ì ¸ì™€ì•¼ í•œë‹¤. ì´ë•Œ, idëŠ” user sessionìœ¼ë¡œ ë°›ì•„ì˜¤ë©´ ì•ˆ ëœë‹¤. ì™œëƒí•˜ë©´ ì¶”í›„ì—ëŠ” í”„ë¡œíŒŒì¼ì„ ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ ì¤„ ê²ƒì´ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë˜ì„œ ì§€ê¸ˆì€ req.paramsì—ì„œ idë¥¼ ë°›ì•„ì˜¨ë‹¤. ê·¸ë¦¬ê³  idë¡œ ì‚¬ìš©ìë¥¼ ì°¾ì€ ë‹¤ìŒì— ëœë”ë§ í•˜ëŠ” í˜ì´ì§€ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ë³´ë‚´ì„œ í”„ë¡œíŒŒì¼ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ê²Œ í•œë‹¤. ì´ë•Œ, ì‚¬ìš©ìê°€ ì—†ì„ ìˆ˜ë„ ìˆëŠ”ë°, ê·¸ ê²½ìš° 404 í˜ì´ì§€ê°€ ë‚˜ì˜¤ë„ë¡ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const see = (req, res) =&gt; {
    const { id } = req.params;
    cosnt user = User.findById(id);
    if(!user) {
        return res.status(404).render("404", { pageTitle: "User not found." });
    }
    return res.render("users/profile", { pageTitle: user.name, user });
};
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  profile viewë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// profile.pug
extends ../base

block content
    h1 hello
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í”„ë¡œíŒŒì¼ì„ ë³´ì—¬ì£¼ëŠ” í˜ì´ì§€ í˜•íƒœëŠ” ë§Œë“¤ì—ˆë‹¤. ë¬¸ì œëŠ” ë¹„ë””ì˜¤ì™€ ì‚¬ìš©ìê°€ ì „í˜€ ì—°ê²°ë˜ì–´ ìˆì§€ ì•Šë‹¤ëŠ” ì ì´ë‹¤. ì´ëŠ” ëª¨ë¸ì„ ì—…ë°ì´íŠ¸ í•´ì•¼ í•´ê²°ë˜ê¸° ë•Œë¬¸ì— í˜„ì¬ ì •ë³´ë¥¼ ëª¨ë‘ ì§€ì›Œì¤˜ì•¼ í•œë‹¤. í„°ë¯¸ë„ì„ ì—´ì–´ì„œ mongo -&gt; use wetube -&gt; db.videos.remove({}) -&gt; db.users.remove({})ë¡œ ëª¨ë“  ë¹„ë””ì˜¤ì™€ ì‚¬ìš©ì ì •ë³´ë¥¼ ì—†ì• ì¤€ë‹¤.</p>

<h3 id="811-video-owner">8.11 Video Owner</h3>

<p>ìš°ë¦¬ëŠ” ì´ë²ˆì— ë¹„ë””ì˜¤ì™€ ì‚¬ìš©ìë¥¼ ì—°ê²°í•˜ëŠ” ì¼ì„ í•´ë³´ê² ë‹¤. ì—°ê²°ì„ ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ë¬¼ë¡  _idë‹¤. _idëŠ” ì„œë¡œ ë‹¬ë¼ì„œ í•˜ë‚˜ ë¿ì¸ë°ë‹¤ê°€, ëœë¤í•œ ìˆ«ìë¼ ë¹„ë””ì˜¤ë‚˜ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•˜ê¸° ê°€ì¥ ì¢‹ê¸° ë•Œë¬¸ì´ë‹¤. userì—ëŠ” userê°€ ì—…ë¡œë“œí•œ videoì˜ idë¥¼ ì €ì¥í•˜ê³ , videoì—ëŠ” ì˜ìƒì„ ì˜¬ë¦° userì˜ idë¥¼ ì ì–´ì¤€ë‹¤.</p>

<p>ë¨¼ì € videoSchemaì— ownerë¥¼ ì¶”ê°€í•´ì£¼ê² ë‹¤. ê·¸ëŸ°ë° ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ì •í•  ë•Œ, ownerì˜ íƒ€ì…ì´ ë¬¸ì œê°€ ëœë‹¤. ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ê¸°ëŠ¥ì€ <a href="https://mongoosejs.com/docs/populate.html">populate()</a>ë¼ëŠ” ê¸°ëŠ¥ì¸ë°, ì´ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Schema.Types.ObjectIdë¼ëŠ” íƒ€ì…ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ê·¸ëŸ°ë° ObjectIdë¼ëŠ” íƒ€ì…ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ì— ì—†ë‹¤. ê·¸ë˜ì„œ íƒ€ì…ì€ mongoose.Schema.Types.ObjectIdë¥¼ ì‚¬ìš©í•´ì¤˜ì•¼ í•˜ëŠ”ë°, ì´ëŠ” ëª½êµ¬ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” íƒ€ì…ìœ¼ë¡œ DBì˜ ë‹¤ë¥¸ ë°ì´í„°ì˜ Idë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” ì´ë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê¸°ì–µí•˜ì. ë‹¤ìŒìœ¼ë¡œ idë¥¼ ê°€ì ¸ì˜¤ë”ë¼ë„ ì–´ë–¤ ìë£Œì—ì„œ ê°€ì ¸ì™€ì•¼ í• ì§€ ëª¨ë¥¸ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ìš°ë¦¬ê°€ 20ê°œ ì •ë„ì˜ ëª¨ë¸ì´ ìˆë‹¤ê³  í•˜ë©´, íƒ€ì…ë§Œìœ¼ë¡œëŠ” idë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì–´ë–¤ ëª¨ë¸ì—ì„œ ê°€ì ¸ì˜¤ëŠ”ì§€ ì¶”ê°€í•˜ëŠ” refë¼ëŠ” ì†ì„±ì´ ìˆë‹¤. ì—¬ê¸°ì— ê°€ì ¸ì˜¤ê³  ì‹¶ì€ ëª¨ë¸ì˜ ì´ë¦„ì„ ì ì–´ì£¼ë©´ ëœë‹¤. ìµœì¢…ì ìœ¼ë¡œ ì½”ë“œëŠ” ì•„ë˜ì²˜ëŸ¼ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Video.js
const videoSchema = new mongoose.Schema({
    ...
    owner: {type: mongoose.Schema.Types.ObjectId, required: true, ref: "User" },
});
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œí•  ë•Œ, ì‚¬ìš©ì idë¥¼ ëª¨ë¸ì— ë„£ì–´ì¤˜ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ userController.jsì—ì„œ postUploadì— ì‚¬ìš©ì _idë¥¼ ì¶”ê°€í•˜ëŠ” ì½”ë“œë¥¼ ë§Œë“¤ì—ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
const {
    user: { _id },
} = req.session;
...
try {
    await Video.create({
        ...
        owner: _id,
    });
    ...
}
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•˜ê³  ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œ í•œ ë‹¤ìŒì—, ëª½êµ¬ìŠ¤ì—ì„œ ë¹„ë””ì˜¤ë¥¼ í™•ì¸í•´ë³´ë©´ ownerê°€ ì¶”ê°€ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” ë™ì˜ìƒì„ ìˆ˜ì •, ì‚­ì œí•˜ëŠ” ì¼ì€ ê·¸ ë™ì˜ìƒì˜ ì†Œìœ ìë§Œ ê°€ëŠ¥í•˜ê²Œ í•˜ë ¤ê³  í–ˆë‹¤. ìš°ë¦¬ëŠ” ëˆ„ê°€ ë¡œê·¸ì¸ ë˜ì—ˆëŠ”ì§€ ì•Œê³  ìˆìœ¼ë¯€ë¡œ ë¡œê·¸ì¸ ëœ ì‚¬ëŒì˜ idì™€ ownerì˜ idê°€ ì¼ì¹˜í•˜ë©´, ê·¸ ë™ì˜ìƒì˜ ì†Œìœ ìê°€ ë¡œê·¸ì¸ í–ˆë‹¤ê³  ìƒê°í•  ìˆ˜ ìˆë‹¤. watch.pugì—ì„œ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì„œ ì†Œìœ ìì¸ ê²½ìš°ì—ë§Œ ìˆ˜ì •, ì‚­ì œ ë²„íŠ¼ì´ ë³´ì´ë„ë¡ ë§Œë“¤ì. ifë¬¸ì„ ì‚¬ìš©í•˜ê³  <code class="language-plaintext highlighter-rouge">video.owner === loggedInUser._id</code>ë¥¼ ë¹„êµí•˜ë©´ ë  ê²ƒ ê°™ë‹¤. ê·¸ëŸ°ë° ì´ë ‡ê²Œ í•˜ë©´ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ ì´ìœ ëŠ” video.ownerëŠ” ObjectIdê³  _idëŠ” stringì´ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì–‘ìª½ì— String()ì„ ì”Œì›Œì„œ ì„œë¡œê°€ ìŠ¤íŠ¸ë§ì´ ë˜ê²Œ ë§Œë“  ë‹¤ìŒ ë¹„êµí•´ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
...
block content
    ...
    if String(video.owner) === String(loggedInUser._id)
        a(href=`${video.id}/edit`) Edit Video &amp;rarr;
        br
        a(href=`${video.id}/delete`) Delete Video &amp;rarr;
</code></pre></div></div>

<p>ì¶”ê°€ì ìœ¼ë¡œ ë¹„ë””ì˜¤ ì†Œìœ ìê°€ ë™ì˜ìƒ ì•„ë˜ì— ë‚˜ì˜¤ë„ë¡ ë§Œë“¤ì–´ ì£¼ë ¤ê³  í•œë‹¤. ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ëŒì•„ê°€ì„œ ìƒê°í•´ë³´ë©´, ìš°ë¦¬ëŠ” ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆë‹¤. ë‹¤ì‹œ ë§í•´ ìš°ë¦¬ëŠ” ë¹„ë””ì˜¤ ì•ˆì˜ ownerë„ ì°¾ì„ ìˆ˜ ìˆë‹¤. ownerì— ìˆëŠ” idë¡œ ì‚¬ìš©ìë¥¼ ì°¾ì•„ì¤€ ë‹¤ìŒ, í˜ì´ì§€ë¥¼ ëœë”ë§ í•  ë•Œ, ì‚¬ìš©ìë¥¼ ë°›ì•„ì™€ì„œ ì´ë¦„ì„ ë³´ì—¬ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
...
import User from "../models/user";
...
export const watch = async (req, res) =&gt; {
    ...
    const owner = await User.findById(video.owner);
    ...
    return res.render("watch", { pageTitle: video.title, video, owner});
};
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
...
block content
    ...
    div
        small Uploaded by #{owner.name}
    if String(owner._id) === String(loggedInUser._id)
        a(href=`${video.id}/edit`) Edit Video &amp;rarr;
        br
        a(href=`${video.id}/delete`) Delete Video &amp;rarr;
</code></pre></div></div>

<h3 id="812-video-owner-part-two">8.12 Video Owner part Two</h3>

<p>ì•ì„œ ìš°ë¦¬ëŠ” ownerë¥¼ ë”°ë¡œ ì°¾ì•„ì™€ì„œ ë³´ì—¬ì¤¬ë‹¤. ê·¸ëŸ°ë° ëª½êµ¬ìŠ¤ì—ì„œ ì´ë¥¼ ëŒ€ì‹ í•  ìˆ˜ ìˆë‹¤. ë‹¤ì‹œ ë§í•´ videoì˜ ownerë§Œìœ¼ë¡œë„ ì•ì„œ í–ˆë˜ ê²ƒê³¼ ë™ì¼í•œ ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤. ì´ëŠ” ìš°ë¦¬ê°€ ëª¨ë¸ì„ ë§Œë“¤ ë•Œ, refë¥¼ ì ì–´ì¤¬ê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ê²ƒì´ë‹¤. ë¨¼ì € ì•„ë˜ ë‘ ì½”ë“œë¥¼ ì‹¤í–‰í•´ì„œ videoì˜ ì°¨ì´ ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const watch = async (req, res) =&gt; {
    ...
    const video = await Vide.findById(id);
    console.log(video)
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const watch = async (req, res) =&gt; {
    ...
    const video = await Vide.findById(id).populate("owner");
    console.log(video)
}
</code></pre></div></div>

<p>ì½”ë“œë¥¼ í™•ì¸í•˜ë©´ videoì˜ ownerì— idê°€ ì•„ë‹ˆë¼ user ì •ë³´ê°€ ë‹´ê²¨ ìˆë‹¤. ì´ëŠ” populateì˜ ê¸°ëŠ¥ìœ¼ë¡œ â€œownerâ€ì— í•´ë‹¹í•˜ëŠ” ObjectIdë¡œ userë¥¼ ì°¾ì•„ì¤€ë‹¤. ì´ëŠ” ì´ì „ì— ìš°ë¦¬ê°€ ëª¨ë¸ì—ì„œ refì— Userë¥¼ ì ì—ˆê¸° ë•Œë¬¸ì—, ObjectIdë§Œìœ¼ë¡œ userë¥¼ ì°¾ì€ ê²ƒì´ë‹¤.</p>

<p>ì´ì œ í…œí”Œë¦¿ê³¼ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì´ì— ë§ì¶°ì„œ ì¡°ê¸ˆ ìˆ˜ì •í•˜ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const watch = async (req, res) =&gt; {
    ...
    return res.render("watch", { pageTitle: video.title, video });
};
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
block content
    ...
        small Uploaded by #{video.owner.name}
    if String(video.owner._id) === String(loggedInUser._id)
    ...
</code></pre></div></div>

<p>ì´ë ‡ê²Œ ë¹„ë””ì˜¤ì— ì‚¬ìš©ì ì •ë³´ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì€ ëì´ ë‚¬ë‹¤. ë‹¤ìŒìœ¼ë¡œ í•  ì¼ì€ íŠ¹ì • ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ ëª¨ë“  ë¹„ë””ì˜¤ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ ë§Œë“œëŠ” ê²ƒì´ë‹¤. ë¹„ë””ì˜¤ ì•„ë˜ ì´ë¦„ì„ ëˆ„ë¥´ë©´, ì†Œìœ ìì˜ ëª¨ë“  ë¹„ë””ì˜¤ë¥¼ ë³´ì—¬ì£¼ëŠ” í˜ì´ì§€ë¡œ ê°€ë„ë¡ ë§í¬ë¥¼ ìˆ˜ì •í•˜ê² ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
block content
    ...
        small Uploaded by
            a(href=`/users/${video.owner._id}`)=video.owner.name
    if String(video.owner._id) === String(loggedInUser._id)
    ...
</code></pre></div></div>

<p>ì´ì œ í”„ë¡œíŒŒì¼ë¡œ ê°€ë„ë¡ ë§Œë“¤ì–´ì¤¬ë‹¤. ê·¸ëŸ°ë° ì§€ê¸ˆê¹Œì§€ í•œ ê²ƒë§Œ í•´ë„ ì‚¬ìš©ìê°€ ì˜¬ë¦° ë¹„ë””ì˜¤ë¥¼ ëª¨ë‘ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤. ë°©ë²•ì€ see ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ Video.find()ë¥¼ ì‚¬ìš©í•´ì„œ ownerê°€ _idì¸ ê²ƒì„ ì°¾ìœ¼ë©´ ëœë‹¤. ê·¸ í›„ ì´ë¥¼ ëœë”ë§ í•˜ëŠ” í˜ì´ì§€ë¡œ ë³´ë‚´ì„œ ë³´ì—¬ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export const see = async (req, res) =&gt; {
    ...
    const videos = await Video.find({ owner: user._id });
    return res.render(
        ..., {
            ...
            videos,
        });
};
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// profile.pug
extends ../base
include ../mixins/video


block content
    each video in videos
        +video(video)
    else
        li Sorry nothing found.
</code></pre></div></div>

<p>ì´ë ‡ê²Œ í•´ê²°í•´ë„ ë˜ì§€ë§Œ ë” ê°„ê²°í•˜ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë²•ì´ ìˆë‹¤. ëŒ€ì‹ ì— User ëª¨ë¸ì— ë¹„ë””ì˜¤ _idë¥¼ ë„£ì–´ì¤˜ì•¼ í•˜ë¯€ë¡œ DBë¥¼ ì´ˆê¸°í™” ì‹œí‚¨ í›„ì— ì§„í–‰í•´ì•¼ í•œë‹¤. ì´ëŠ” ë‹¤ìŒì— ì•Œì•„ë³´ê² ë‹¤.</p>

<h3 id="813-users-video">8.13 Userâ€™s Video</h3>

<p>Userì— ì¶”ê°€í•˜ëŠ” VideoëŠ” ì—¬ëŸ¬ ê°œê°€ ìˆì„ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ëª¨ë¸ì„ ìˆ˜ì •í•  ë•Œ, arrayë¡œ ì¶”ê°€í•´ì£¼ê² ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ Videoì— Userë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒê³¼ ë™ì¼í•˜ì§€ë§Œ, requiredì¼ í•„ìš”ê°€ ì—†ê³ , refì— Videoë¥¼ ì ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// User.js
const userSchema = new mongoose.Schema({
    ...
      videos: [{ type: mongoose.Schema.Types.ObjectId, ref: "Video" }],
});
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ videoControllerì˜ postUploadë¥¼ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤. ì™œëƒí•˜ë©´ ë¹„ë””ì˜¤ë¥¼ ì—…ë¡œë“œ í•  ë•Œ, Userì—ê²Œ Videoì˜ _idë¥¼ ì¶”ê°€í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤. Video.createëŠ” ìƒˆë¡œ ë§Œë“  Videoë¥¼ ë°˜í™˜í•œë‹¤. ì´ë¥¼ ê°€ì ¸ì™€ì„œ _idë¡œ ì°¾ì€ ì‚¬ìš©ìì—ê²Œ ë¹„ë””ì˜¤ë¥¼ ì¶”ê°€í•´ì£¼ë„ë¡ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const postUpload = async (req, res) =&gt; {
    ...
    try {
        const newVideo = await Video.create({
          ...
        });
        const user = await User.findById(_id);
        user.videos.push(newVideo._id);
        user.save();
        ...
    } ...
};
</code></pre></div></div>

<p>ì´ì œ ëœë”ë§ ë˜ëŠ” í˜ì´ì§€ì™€, ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë§Œ ìˆ˜ì •í•˜ë©´ ëœë‹¤. userController.jsì—ì„œ seeë¥¼ ë³´ë©´ idë¡œ ì‚¬ìš©ìë¥¼ ì°¾ê³  ìˆë‹¤. ì—¬ê¸°ë‹¤ê°€ populate(â€œvideosâ€)ë¥¼ ì“°ë©´, í•´ë‹¹ ì‚¬ìš©ìì˜ videosì— ë¹„ë””ì˜¤ ì •ë³´ê°€ ë“¤ì–´ê°€ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  ì´ë¥¼ ê°€ì§€ê³  ëœë”ë§ í•˜ëŠ” í˜ì´ì§€ì—ì„œëŠ” videos ëŒ€ì‹ ì— user.videosë¥¼ ì‚¬ìš©í•˜ë©´ ëª¨ë“ ê²Œ í•´ê²° ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const see = async (req, res) =&gt; {
    ...
    const user = await User.findById(id).populate("videos");
    ...
};
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// profile.pug
extends ../base
include ../mixins/video

block content
    each video in user.videos
        +video(video)
    else
        li Sorry nothing found.
</code></pre></div></div>

<p>ì—¬ê¸°ê¹Œì§€ í•˜ë©´ ë“œë””ì–´ ì‚¬ìš©ìì™€ ë¹„ë””ì˜¤ë¥¼ ëª¨ë‘ ì—°ê²°í•˜ëŠ”ë° ì„±ê³µí–ˆë‹¤. í•˜ì§€ë§Œ ì•„ì§ ë¬¸ì œê°€ ë‚¨ì•„ ìˆë‹¤. ìš°ë¦¬ëŠ” ë¹„ë””ì˜¤ í˜ì´ì§€ì—ì„œ ì†Œìœ ìê°€ ì•„ë‹ˆë©´ Edit, Delete ë§í¬ë¥¼ ë³´ì´ì§€ ì•Šê²Œ ë§Œë“¤ì—ˆë‹¤. ê·¸ë ‡ì§€ë§Œ ì•„ì§ë„ url ìì²´ë¡œ ë“¤ì–´ê°€ì„œ ìˆ˜ì •, ì‚­ì œê°€ ê°€ëŠ¥í•˜ë‹¤. ë‹¹ì—°íˆë„ ì†Œìœ ìê°€ ì•„ë‹ˆë©´ ìˆ˜ì •, ì‚­ì œ í•  ìˆ˜ ì—†ë„ë¡ ë§Œë“¤ì–´ì•¼ í•œë‹¤.</p>

<p>ê·¸ë¦¬ê³  í•œ ê°€ì§€ ë¬¸ì œê°€ ë” ìˆë‹¤. ìš°ë¦¬ëŠ” ì•ì„œ postUploadì—ì„œ Userì˜ videosë¥¼ ì°¾ì•„ì„œ ë„£ì–´ì£¼ì—ˆë‹¤. ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">user.save()</code>ë¡œ ì €ì¥í•´ì£¼ì—ˆë‹¤. ë¬¸ì œëŠ” ìš°ë¦¬ê°€ User ëª¨ë¸ì„ ë§Œë“¤ ë•Œ, preë¥¼ ì‚¬ìš©í•´ì„œ ì €ì¥í•  ë•Œë§ˆë‹¤ í•´ì‹±í•˜ë„ë¡ ë§Œë“¤ì—ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì˜ìƒì„ ì—…ë¡œë“œ í•  ë•Œë§ˆë‹¤ ë¹„ë°€ë²ˆí˜¸ê°€ ë°”ë€Œê²Œ ë˜ê³  ë¡œê·¸ì¸ í•  ìˆ˜ ì—†ê²Œ ëœë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ íŠ¹ì •í•œ ê²½ìš°ì—ë§Œ í•´ì‹±ì´ ì¼ì–´ë‚˜ë„ë¡ ì´ë¥¼ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>

<p>ë‹¤ìŒì—ëŠ” ìœ„ì˜ ë‘ ë¬¸ì œë¥¼ ìˆ˜ì •í•´ë³´ê² ë‹¤.</p>

<h3 id="814-bugfix">8.14 Bugfix</h3>

<p>í•´ì‹±ì´ ë°˜ë³µì ìœ¼ë¡œ ì¼ì–´ë‚˜ëŠ” ê²ƒì„ ê³ ì¹˜ëŠ” ì¼ì€ ê°„ë‹¨í•˜ë‹¤. ì €ì¥í•  ë•Œë§ˆë‹¤ í•´ì‹±í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë¹„ë°€ë²ˆí˜¸ê°€ ìˆ˜ì •ë  ë•Œë§ˆë‹¤ í•´ì‹±í•˜ë©´ í•´ê²°ëœë‹¤. userSchema.pre()ë¡œ ëŒì•„ê°€ì„œ ë§í•´ë³´ì. ì—¬ê¸°ì„œ thisëŠ” userê³¼ ë™ì¼í•˜ë‹¤ê³  ë§ í–ˆì—ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ this.ì„ ì…ë ¥í•˜ë©´ ì—¬ëŸ¬ ì„ íƒì§€ê°€ ë‚˜ì˜¨ë‹¤. ì—¬ê¸°ì„œ isModified()ë¥¼ ì‚¬ìš©í•˜ë©´ ì–´ë–¤ ê²ƒì´ ë³€í™”ê°€ ìˆì—ˆì„ ê²½ìš°ì— trueê°€ ë°˜í™˜ëœë‹¤. ìš°ë¦¬ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ë°”ë€Œì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ìœ¼ë¯€ë¡œ, isModified(â€œpasswordâ€)ë¼ê³  ì ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// User.js
userSchema.pre("save", async function () {
  if (this.isModified("password")) {
    this.password = await bcrypt.hash(this.password, 5);
  }
});
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ getEditì„ ìˆ˜ì •í•´ì„œ ì˜ìƒ ì£¼ì¸ì—ê²Œë§Œ edit í˜ì´ì§€ê°€ ë‚˜ì˜¤ë„ë¡ í•˜ê² ë‹¤. ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë³´ë©´ videoê°€ ìˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ì†Œìœ ìë¥¼ ì°¾ì„ ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  ìš°ë¦¬ëŠ” ì„¸ì…˜ìœ¼ë¡œ í˜„ì¬ ë¡œê·¸ì¸ í•œ ì‚¬ëŒì„ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ ë‘˜ì„ ë¹„êµí•´ì„œ ì„œë¡œ ë‹¤ë¥´ë‹¤ë©´ edit í˜ì´ì§€ë¥¼ ëœë”ë§ í•˜ì§€ ì•Šìœ¼ë©´ ëœë‹¤. editì„ ëœë”ë§ í•˜ëŠ” ëŒ€ì‹ ì— í™ˆìœ¼ë¡œ ë³´ë‚´ì¤„ í…ë°, ì´ ë•Œ status(403)ì„ ì ì–´ì¤€ë‹¤. 403ì€ Forbiddenì„ ì˜ë¯¸í•˜ê¸° ë•Œë¬¸ì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const getEdit = async (req, res) =&gt; {
    ...
    const {
        user: { _id },
    } = req.session;
    const video = await Video.findById(id);
        ...
    if (video.owner !== _id) {
        return res.status(403).redirect("/");
    }
    return res.render("edit", { pageTitle: `Edit: ${video.title}`, video });
};
</code></pre></div></div>

<p>ê·¸ëŸ°ë° ì´ë ‡ê²Œ í•˜ê³  ì‹¤í–‰í•˜ë©´ ì†Œìœ ìê°€ ë™ì¼í•¨ì—ë„ ë¶ˆêµ¬í•˜ê³  ì¸ì‹í•˜ì§€ ëª» í•œë‹¤. ê·¸ ì´ìœ ëŠ” video.ownerê³¼ _idê°€ typeì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì´ë‹¤. <code class="language-plaintext highlighter-rouge">console.log(typeof video.owner, typeof _id)</code>ë¥¼ í™•ì¸í•´ë³´ë©´ video.ownerì€ objectê³  _idëŠ” stringì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ë‘˜ì— String()ì„ ì‚¬ìš©í•´ì„œ íƒ€ì…ì„ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤. ì´ëŠ” ì´ì „ì— watch.pugdì—ì„œ ë™ì¼í•œ ë°©ë²•ìœ¼ë¡œ í•´ê²°í•´ì£¼ì—ˆë‹¤. ì´ì²˜ëŸ¼ ìƒê¸´ ê²ƒì€ ê°™ì§€ë§Œ íƒ€ì…ì´ ë‹¤ë¥¸ ê²½ìš° ì„œë¡œ ë‹¤ë¥¸ ê²ƒìœ¼ë¡œ ì¸ì‹í•˜ê¸° ë•Œë¬¸ì— ì£¼ì˜í•´ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const getEdit = async (req, res) =&gt; {
    ...
    const {
        user: { _id },
    } = req.session;
    const video = await Video.findById(id);
        ...
    if (String(video.owner) !== String(_id)) {
        return res.status(403).redirect("/");
    }
    return res.render("edit", { pageTitle: `Edit: ${video.title}`, video });
};
</code></pre></div></div>

<p>ë™ì¼í•œ ë°©ë²•ìœ¼ë¡œ postEditì—ë„ ê°™ì€ ì²˜ë¦¬ë¥¼ í•´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const postEdit = async (req, res) =&gt; {
    const {
        user: { _id },
    } = req.session;
        ...
    if (String(video.owner) !== String(_id)) {
        return res.status(403).redirect("/");
    }
    ...
};
</code></pre></div></div>

<p>ë°±ì—”ë“œì—ì„œëŠ” ì´ì™€ ê°™ì€ ì¼ì´ ì¤‘ìš”í•˜ë‹¤. ë§í¬ë§Œì„ ìˆ¨ê¸°ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, í—ˆë½ë˜ëŠ” ì‚¬ëŒì´ ì•„ë‹ˆë©´ ë°˜ë“œì‹œ ë§‰ì•„ì•¼ í•œë‹¤. ê·¸ë˜ì•¼ urlë¡œ ì ‘ê·¼í•´ì„œ í—ˆë½ë˜ì§€ ì•Šì€ ì¼ì´ ìƒê¸°ëŠ” ê²ƒì„ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.</p>

<p>ê°™ì€ ì´ìœ ë¡œ deleteVideoì—ë„ ë™ì¼í•œ ì¼ì„ í•´ì¤˜ì•¼ í•œë‹¤. ê·¸ëŸ°ë° videoê°€ ì—†ê¸° ë•Œë¬¸ì— idë¡œ ì°¾ì•„ì¤˜ì•¼ í•˜ê³ , ë™ì‹œì— ì„¸ì…˜ì—ì„œ user._idë¥¼ ë°›ì•„ì˜¨ë‹¤. videoê°€ ì—†ì„ ê²½ìš° 404ë¥¼ ë³´ì—¬ì£¼ê³ , ì†Œìœ ì£¼ê°€ ì•„ë‹Œ ê²½ìš° 403ìœ¼ë¡œ forbiddenì„ í‘œì‹œí•˜ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export const deleteVideo = async (req, res) =&gt; {
    const { id } = req.params;
    const {
        user: { _id },
    } = req.session;
    const video = await Video.findById(id);
    if (!video) {
        return res.status(404).render("404", { pageTitle: "Video not found." });
    }
    if (String(video.owner) !== String(_id)) {
        return res.status(403).redirect("/");
    }
        ...
};
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ ìš°ë¦¬ëŠ” videoë¥¼ ë°›ì•„ì˜¬ ë•Œ, populateë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë‹¤. ì´ëŠ” ìš°ë¦¬ê°€ idë§Œ í•„ìš”í•˜ê¸° ë•Œë¬¸ì´ë‹¤. populateëŠ” ëª¨ë“  ì •ë³´ë¥¼ ë°›ì•„ì˜¤ê¸° ë•Œë¬¸ì— DBë¥¼ í˜¹ì‚¬ì‹œí‚¨ë‹¤. ë§Œì•½ populateë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  í•´ê²°í•  ìˆ˜ ìˆë‹¤ë©´, êµ³ì´ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ë‹¤.</p>

<h3 id="815-conclusions">8.15 Conclusions</h3>
:ET