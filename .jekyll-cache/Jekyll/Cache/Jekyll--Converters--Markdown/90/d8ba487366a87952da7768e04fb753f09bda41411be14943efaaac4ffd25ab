I"<h2 id="16-comment-section">16 COMMENT SECTION</h2>

<h3 id="160-introduction">16.0 Introduction</h3>

<h3 id="161-comment-models">16.1 Comment Models</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/models/Comment.js
import mongoose from "mongoose";

const commentSchema = new mongoose.Schema({
  text: { type: String, required: true },
  owner: { type: mongoose.Schema.Types.ObjectId, required: true, ref: "User" },
  video: { type: mongoose.Schema.Types.ObjectId, required: true, ref: "Video" },
  createdAt: { type: Date, required: true, default: Date.now },
});

const Comment = mongoose.model("Comment", commentSchema);

export default Comment;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/init.js
import "./db";
import "./models/Video";
import "./models/User";
import "./models/Comment";
import app from "./server";
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// User.js
  location: String,
  // add comments
  comments: [{ type: mongoose.Schema.Types.ObjectId, ref: "Comment" }],
  videos: [{ type: mongoose.Schema.Types.ObjectId, ref: "Video" }],
});
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Video.js
  meta: {
    views: { type: Number, default: 0, required: true },
  },
  // add comments
  comments: [
    { type: mongoose.Schema.Types.ObjectId, required: true, ref: "Comment" },
  ],
  owner: { type: mongoose.Schema.Types.ObjectId, required: true, ref: "User" },
</code></pre></div></div>

<h3 id="162-comment-box">16.2 Comment Box</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/client/commentSection.js
const videoContainer = document.getElementById("videoContainer");
const form = document.getElementById("commentForm");
const textarea = form.querySelector("textarea");
const btn = form.querySelector("button");

const handleSubmit = (event) =&gt; {
  event.preventDefault();
  const text = textarea.value;
  const video = videoContainer.dataset.id;
};

form.addEventListener("submit", handleSubmit);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// webpack.config.js
const BASE_JS = "./src/client/js/";

module.exports = {
  entry: {
    main: BASE_JS + "main.js",
    videoPlayer: BASE_JS + "videoPlayer.js",
    recorder: BASE_JS + "recorder.js",
    commentSection: BASE_JS + "commentSection.js",
  },
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
    div.video__data
        p.video__title=video.title
        small.video__owner Uploaded by 
            a(href=`/users/${video.owner._id}`)=video.owner.name
        small.video__createdAt=new Date(video.createdAt).toLocaleDateString("ko-kr", {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})
        if String(video.owner._id) === String(loggedInUser._id)
            a(href=`${video.id}/edit`) Edit Video &amp;rarr;
            br
            a(href=`${video.id}/delete`) Delete Video &amp;rarr;
    if loggedIn
        div.video__comments
            form.video__comment-form#commentForm
                textarea(cols="30", rows="10", placeholder="Write a nice commment...")
                button Add Comment


block scripts
    script(src="/static/js/videoPlayer.js")
    script(src="/static/js/commentSection.js") 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// client/scss/screens/watch.scss
.video__data {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  .video__title {
    font-size: 26px;
    margin-bottom: 5px;
  }
  .video__createdAt {
    font-size: 12px;
  }
  .video__owner {
    margin-bottom: 5px;
    font-size: 14px;
    a {
      color: cornflowerblue;
      text-decoration: underline;
    }
  }
}
</code></pre></div></div>

<h3 id="163-api-route-part-one">16.3 API Route part One</h3>
<p>ì§€ê¸ˆê¹Œì§€ ì‘ì„±í•œ ì½”ë“œë¥¼ ë³´ë©´ ë¡œê·¸ì•„ì›ƒ í–ˆì„ ë•Œ, ì—ëŸ¬ê°€ ë‚˜ì˜¨ë‹¤. ì´ëŠ” ë¡œê·¸ì¸ í•˜ì§€ ì•Šì•˜ì„ ë•Œ, textarea, buttonì´ ì—†ê¸° ë•Œë¬¸ì— ìƒê¸°ëŠ” ë¬¸ì œì ì´ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„  2ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤. í•˜ë‚˜ëŠ” ë¡œê·¸ì¸ í–ˆì„ ê²½ìš°ì—ë§Œ scriptë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì´ë‹¤.</p>

<p>ë‹¤ë¥¸ ë°©ë²•ì€ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ë‹¤. formì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ì´ë²¤íŠ¸ê°€ ì‹¤í–‰ë˜ê³ , textareaë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ë§Œë“¤ì—ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// comment.js
const videoContainer = document.getElementById("videoContainer");
const form = document.getElementById("commentForm");

const handleSubmit = (event) =&gt; {
    event.preventDefault();
    const textarea = form.querySelector("textarea");
    const text = textarea.value;
    ...
};

if (form) {
    form.addEventListener("submit", handleSubmit);
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
block scripts
    script(src="/static/js/videoPlayer.js")
    if loggedIn
        script(src="/static/js/commentSection.js") 
</code></pre></div></div>
<p>ì´ì œ commentë¥¼ ë°±ì—”ë“œë¡œ ë³´ë‚´ì„œ ì²˜ë¦¬í•´ì¤˜ì•¼ í•œë‹¤. ì•„ì§ commentë¥¼ ì²˜ë¦¬í•˜ëŠ” routerê°€ ì—†ê¸´í•˜ì§€ë§Œ, ìš°ì„ ì€ fetchë¡œ ê¸°ëŠ¥ì„ ë§Œë“  í›„ì— ë¼ìš°í„°ë¥¼ ë§Œë“¤ê² ë‹¤. fetchë¡œ urlì„ ì§€ì •í•˜ëŠ” ê²ƒì€ ê°„ë‹¨í•˜ê³ , post ë°©ì‹ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ì ë„ ëª…í™•í•˜ë‹¤. ê·¸ëŸ°ë° textë¥¼ ì–´ë–»ê²Œ ì „ë‹¬í• ì§€ê°€ ë¬¸ì œë‹¤. textë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ì„  bodyì— textë¥¼ ì „ë‹¬í•´ì¤˜ì•¼ í•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ req.body ì•ˆì— textê°€ ì „ë‹¬ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// comment.js
const videoContainer = document.getElementById("videoContainer");
const form = document.getElementById("commentForm");

const handleSubmit = (event) =&gt; {
    ...
    const text = textarea.value;
    const videoId = videoContainer.dataset.id;
    fetch(`/api/videos/${videoId}/comment`, {
        method: "POST",
        body: {
            text,
        },
    });
};
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ë¼ìš°í„°ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ì£¼ë©´ ëœë‹¤. ìš°ì„  ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” bodyì™€ paramsë§Œ ì¶œë ¥í•˜ê²Œ ë§Œë“¤ì–´ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// apiRouter.js
import { registerView, createComment } from "../controllers/videoController";
...
apiRouter.post("/videos/:id([0-9a-f]{24})/comment", createComment);
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const createComment = (req, res) =&gt; {
  console.log(req.params);
  console.log(req.body);
  return res.end();
};
</code></pre></div></div>

<p>ë¬¸ì œëŠ” req.bodyë¥¼ í™•ì¸í•˜ë©´ textê°€ ì—†ë‹¤. ì´ ë¬¸ì œëŠ” ë‹¤ìŒì— í•´ê²°í•´ë³´ì.</p>

<h3 id="164-api-route-part-two">16.4 API Route part Two</h3>
<p>ìš°ì„  í•œ ê°€ì§€ ì‚´í´ë³¼ ê²ƒì´ ìˆë‹¤. ì§€ê¸ˆê¹Œì§€ formìœ¼ë¡œ POSTë¡œ ì œì¶œí•˜ë©´ req.bodyì— ì œì¶œí•œ ë‚´ìš©ì´ ë“¤ì–´ìˆì—ˆë‹¤. ì´ëŠ” <code class="language-plaintext highlighter-rouge">app.use(express.urlencoded({ extended: true }));</code>ë¥¼ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ê²ƒì´ë‹¤. ì´ì œ ì„œë²„ê°€ fetchë¡œ ì˜¤ëŠ” ì •ë³´ë¥¼ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. ìš°ë¦¬ê°€ fetchë¡œ ë³´ë‚´ëŠ” ì •ë³´ëŠ” JSONì´ë‹¤. ë¬¸ì œëŠ” JSONì€ ì „ë‹¬ë˜ëŠ” ê³¼ì •ì—ì„œ ì„œë²„ì™€ ë¸Œë¼ìš°ì €ê°€ ì´ë¥¼ stringìœ¼ë¡œ ì¸ì‹í•´ë²„ë¦°ë‹¤. ì˜ˆë¥¼ ë“¤ì–´ <code class="language-plaintext highlighter-rouge">object = { text: "sdjflkasdf" }</code>ê°€ ìˆì„ ë•Œ, objectê°€ ì „ë‹¬ë˜ë©´ <code class="language-plaintext highlighter-rouge">object.toString()</code>ì´ ì‹¤í–‰ë˜ì–´ì„œ, <code class="language-plaintext highlighter-rouge">[object Object]</code>ë¼ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
  fetch(`/api/videos/${videoId}/comment`, {
    method: "POST",
    body: { text }  // "[object Object]"
  });
</code></pre></div></div>

<p>ê·¸ë ‡ë‹¤ë©´ bodyì—ì„œ { text }ê°€ ì•„ë‹ˆë¼ textë¥¼ ë³´ë‚´ë©´ ì–´ë–»ê²Œ ë ê¹Œ? ë¸Œë¼ìš°ì €ëŠ” ì´í•´í•  ìˆ˜ ìˆì§€ë§Œ, ì•„ì‰½ê²Œë„ ì„œë²„ëŠ” ì´í•´í•˜ì§€ ëª»í•œë‹¤. ì„œë²„ì—ì„œ ì´í•´í•˜ê¸° ìœ„í•´ì„œëŠ” <code class="language-plaintext highlighter-rouge">app.use(express.text());</code>ë¥¼ ì ì–´ì£¼ë©´ ëœë‹¤. ê·¸ë¦¬ê³  ë‹¤ì‹œ ë‚´ìš©ì„ ë³´ë©´ ë‚´ìš©ì´ ì „ë‹¬ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// server.js
app.use(express.txt());
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
  fetch(`/api/videos/${videoId}/comment`, {
    method: "POST",
    body: text  // "This is typed on text"
  });
</code></pre></div></div>

<p>í•˜ì§€ë§Œ ì•„ì§ë„ ë¬¸ì œê°€ ìˆë‹¤. ìš°ë¦¬ëŠ” text í•˜ë‚˜ì˜ ì •ë³´ë°–ì— ë³´ë‚´ì§€ ëª»í•˜ê³  ìˆë‹¤. ê²½ìš°ì— ë”°ë¼ ì—¬ëŸ¬ ì •ë³´ë¥¼ ë³´ë‚´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤. ì´ ê²½ìš° objectë¥¼ ë³´ë‚´ì•¼ í•˜ëŠ”ë°, ìš°ë¦¬ëŠ” objectê°€ ì „ë‹¬ë˜ì§€ ì•ŠìŒì„ ì•Œê³  ìˆë‹¤. ê·¸ë˜ì„œ JSON.stringify()ë¥¼ ì‚¬ìš©í•œë‹¤. JSON.stringify()ëŠ” ì „ë‹¬ëœ objectë¥¼ stringìœ¼ë¡œ ë°”ê¿”ì„œ ì „ë‹¬í•´ì¤€ë‹¤. ê·¸ë ‡ê²Œ í•˜ë©´ ìš°ë¦¬ëŠ” objectë¥¼ ë³´ë‚´ì¤€ ê²ƒì´ ì•„ë‹ˆë¼, ë‹¨ì§€ ê¸´ stringì„ ì „ë‹¬í•˜ë¯€ë¡œ ì„œë²„ë„ ì´í•´í•  ìˆ˜ ìˆê²Œ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
  fetch(`/api/videos/${videoId}/comment`, {
    method: "POST",
    body: JSON.stringify({ text: "This is text", rating: "5" }),
  });
</code></pre></div></div>

<p>ê·¸ë ‡ë‹¤ë©´ ì´ë ‡ê²Œ ì „ë‹¬í•œ ë‚´ìš©ì„ ê°ì²´ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œ? createCommentì—ì„œ <code class="language-plaintext highlighter-rouge">console.log(req.body.text, req.body.rating);</code>ë¡œ í™•ì¸í•´ë³´ë©´, ì•„ì‰½ê²Œë„ undefinedë¡œ ë‚˜ì˜¨ë‹¤. ë‹¹ì—°íˆë„ ì´ëŠ” stringì´ì§€ ê°ì²´ê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. ì´ëŠ” <code class="language-plaintext highlighter-rouge">app.use(express.text())</code>ë¥¼ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤. ë¬¼ë¡  textë§Œì„ ë°›ì•„ì˜¤ë©´ ì´ë¡œë„ ì¶©ë¶„í•˜ì§€ë§Œ, ìš°ë¦¬ëŠ” ëª¨ë“  stringì„ jsonìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤. ë‹¤í–‰íˆë„ expressì—ëŠ” <code class="language-plaintext highlighter-rouge">app.use(express.json())</code>ìœ¼ë¡œ stringì„ ëª¨ë‘ jsonìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.</p>

<p>ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ëŠ” êµ‰ì¥íˆ ê°„ë‹¨í•˜ë‹¤. JSON.stringify()ë¡œ stringì´ ëœ ê²ƒì„ ë‹¤ì‹œ, JSON.parse()ë¡œ ë‚˜ëˆ ì£¼ëŠ” ê²ƒì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JSON.stringify({ text: "This is text", rating: "5" })
// "{ text: "This is text", rating: "5" }"
JSON.parse("{ text: "This is text", rating: "5" }")
// { text: "This is text", rating: "5" }
</code></pre></div></div>

<p>ì—¬ê¸°ë‹¤ê°€ ì¶”ê°€ë¡œ expressì—ê²Œ ë³´ë‚´ëŠ” ê²ƒì´ textê°€ ì•„ë‹ˆë¼ jsonì´ë¼ëŠ” ê²ƒì„ ì•Œë ¤ì¤˜ì•¼ í•œë‹¤. ê·¸ë˜ì„œ fetchë¡œ ëŒì•„ê°€ì„œ headerì— <code class="language-plaintext highlighter-rouge">"Content-type": "applicaion/json"</code>ì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
fetch(`/api/videos/${videoId}/comment`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ text }),
  });
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ textê°€ ë¹„ì–´ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ ë³´ë‚´ì£¼ì§€ ì•Šê²Œ í•˜ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
if (text === "") {
    return;
}
fetch(`/api/videos/${videoId}/comment`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ text }),
  });
</code></pre></div></div>

<h3 id="165-commenting">16.5 Commenting</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
    body: JSON.stringify({ text }),
  });
  textarea.value = "";
};
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const createComment = async (req, res) =&gt; {
  const {
    session: { user },
    body: { text },
    params: { id },
  } = req;
  const video = await Video.findById(id);
  if (!video) {
    return res.sendStatus(404);
  }
  const comment = await Comment.create({
    text,
    owner: user._id,
    video: id,
  });
  return res.sendStatus(201);
};
</code></pre></div></div>

<h3 id="166-rendering-comments">16.6 Rendering Comments</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
export const createComment = async (req, res) =&gt; {
  const {
    session: { user },
    body: { text },
    params: { id },
  } = req;
  const video = await Video.findById(id);
  if (!video) {
    return res.sendStatus(404);
  }
  const comment = await Comment.create({
    text,
    owner: user._id,
    video: id,
  });
  video.comments.push(comment._id);
  video.save();
  return res.sendStatus(201);
};
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.pug
    if loggedIn
        div.video__add-comments
            form.video__comment-form#commentForm
                textarea(cols="30", rows="10", placeholder="Write a nice commment...")
                button Add Comment
    div.video__comments
        ul
            each comment in video.comments.reverse()
                li.video__comment
                    i.fas.fa-comment
                    span  #{comment.text}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// watch.scss
.video__comments {
  display: flex;
  flex-direction: column;
  max-width: 320px;
  width: 100%;
  margin: 0 auto;
  margin-top: 20px;
  .video__comment {
    padding: 10px;
    border-radius: 9999px;
    background-color: white;
    color: black;
    margin-bottom: 10px;
  }
}
</code></pre></div></div>

<p>ì‹¤ì‹œê°„ìœ¼ë¡œ ëŒ“ê¸€ì´ ì¶”ê°€ë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì—¬ì£¼ë ¤ë©´ async/await, window.location.reload()ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì„œ async/awaitì„ ì‚¬ìš©í•œ ì´ìœ ëŠ” fetchê°€ ì‹¤í–‰ë˜ëŠ” ìˆœì„œë¥¼ ì¡°ì ˆí•˜ê¸° ìœ„í•¨ì´ì—ˆë‹¤. ë§Œì•½ async/awaitì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ë”ë¼ë©´ í”„ë¡œë¯¸ìŠ¤ë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ìˆœì„œë¥¼ ë³´ì¥í•  ìˆ˜ ì—†ê³ , window.location.reload()ê°€ ë¨¼ì € ì‹¤í–‰ë  ìˆ˜ë„ ìˆë‹¤. ê·¸ë˜ì„œ fetchê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•  ì‹œê°„ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ì„œ async/awaitì„ ì‚¬ìš©í–ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
const handleSubmit = async (event) =&gt; {
    ...
    await fetch(`/api/videos/${videoId}/comment`, {
        ...
    });
    window.location.reload();
};
</code></pre></div></div>

<p>ê·¸ëŸ°ë° ëŒ“ê¸€ì´ ìƒê¸¸ë•Œë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨ì„ í•´ì£¼ëŠ” ê²ƒì„ ë³„ë¡œ ì¢‹ì€ ìƒê°ì€ ì•„ë‹ˆë‹¤. ë§¤ë²ˆ ë¹„ë””ì˜¤, ì‚¬ìš©ì, ëŒ“ê¸€ ì •ë³´ë¥¼ ë°›ì•„ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë˜ì„œ ìƒê°í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìƒˆë¡œê³ ì¹¨ í•˜ëŠ” ëŒ€ì‹ ì—, ë°©ê·¼ ë§Œë“  ëŒ“ê¸€ì´ ì¶”ê°€ëœ ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œ ë§Œë“œëŠ” ê²ƒì´ë‹¤.</p>

<h3 id="167-realtime-comments">16.7 Realtime Comments</h3>
<p>ìš°ë¦¬ê°€ fetchë¥¼ ì‹¤í–‰ì‹œí‚¤ê¸´ í–ˆì§€ë§Œ ì¢…ë£Œë˜ì—ˆì„ ë•Œ, ì„±ê³µì—¬ë¶€ëŠ” í™•ì¸í•  ìˆ˜ ì—†ì—ˆë‹¤. fetchì˜ í”„ë¡œë¯¸ìŠ¤ë¥¼ ë°˜í™˜ ë°›ì•„ì„œ ì½˜ì†”ì— ì¶œë ¥í•´ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
const handleSubmit = async (event) =&gt; {
    ...
    const response = await fetch(`/api/videos/${videoId}/comment`, {
        ...
    });
    console.log(response);
    textarea.value = '';
};
</code></pre></div></div>

<p>ì¶œë ¥ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´ responseì— statusê°€ ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì„œ statusê°€ 201ì´ë¼ë©´ ëŒ“ê¸€ì´ ì¶”ê°€ë˜ì—ˆë‹¤. ê·¸ë¦¬ê³  ìƒˆë¡œ ìƒê¸´ ëŒ“ê¸€ì„ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” ì½”ë“œë¥¼ ë§Œë“¤ë©´ ìƒˆë¡œê³ ì¹¨ ì—†ì´ë„ ëŒ“ê¸€ì´ ìƒˆë¡œ ìƒì„±ëœ íš¨ê³¼ë¥¼ ë³´ì¼ ìˆ˜ ìˆë‹¤. ì´ë¥¼ ìœ„í•´ statusê°€ 201ì¼ ê²½ìš°ì— ìƒˆë¡œ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë„ë¡ í˜•íƒœë¥¼ ë§Œë“ ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js

const addComment = (text) =&gt; {
    // write code here
};

const handleSubmint = async (event) =&gt; {
    ...
    const { status } = await fetch(`/api/videos/${videoId}/comment`, {
        ...
    });
    ...
    if (status === 201) {
        addComment(text);
    }
};
</code></pre></div></div>

<p>ì´ì œ addCommentì—ì„œ ìƒˆë¡œ elementë¥¼ ë§Œë“¤ì–´ì„œ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤. ì´ë•Œ, ìµœì¢…ì ìœ¼ë¡œ ì™„ì„±í•œ ê²ƒì€ Element.prepend()ë¡œ ì œì¼ ì•ì— ì˜¤ë„ë¡ ë§ë¶™ì¸ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// commentSection.js
const addComment = (text) =&gt; {
  const videoComments = document.querySelector(".video__comments ul");
  const newComment = document.createElement("li");
  newComment.className = "video__comment";
  const icon = document.createElement("i");
  icon.className = "fas fa-comment";
  const span = document.createElement("span");
  span.innerText = ` ${text}`;
  newComment.appendChild(icon);
  newComment.appendChild(span);
  videoComments.prepend(newComment);
};
</code></pre></div></div>

<h3 id="168-comment-ids">16.8 Comment ids</h3>
<p>ëŒ“ê¸€ì„ ì‘ì„±í•œ ì‚¬ëŒì´ë¼ë©´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ ì¶”ê°€í•˜ê¸°.</p>

<p>fetchë¡œ ì ‘ê·¼í•œ urlì—ì„œ res.json()ìœ¼ë¡œ ë°˜í™˜í•œ ê°’ì„ ì‚¬ìš©í•˜ëŠ”ë²•</p>

<p>response.json() -&gt; bodyì˜ ë‚´ìš©ì´ parsing ë˜ì–´ì„œ ì“¸ ìˆ˜ ìˆê²Œ ëœë‹¤.</p>

<h3 id="169-recap-and-challenge">16.9 Recap and Challenge</h3>
<p>method: â€œDELETEâ€ë¡œ ë³´ë‚¸ ê²ƒì„ route.delete()ë¡œ ì‚¬ìš© ê°€ëŠ¥</p>

<h2 id="17-deployment">17 DEPLOYMENT</h2>

<h3 id="170-building-the-backend">17.0 Building the Backend</h3>
<p>ë°±ì—”ë“œë¥¼ ì‹¤ì œë¡œ ë°°í¬í•˜ëŠ” ë²•ì„ ì•Œì•„ë³´ì. ìš°ë¦¬ëŠ” Herokuë¡œ ë°°í¬í•  ì˜ˆì •ì¸ë°, ê·¸ì „ì— í•´ì•¼í•  ì¼ì´ ì•„ì§ ë§ë‹¤. ë¨¼ì € ì–´ë–¤ Node.js í™˜ê²½ì—ì„œë„ ì„œë²„ê°€ êµ¬ë™ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì •í•´ì¤˜ì•¼ í•˜ê³ , mongooseë¡œ ëŒ€ì²´í•œ DBë„ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ì´ë¯¸ì§€ë‚˜ ë¹„ë””ì˜¤ë¥¼ ì»´í“¨í„°ì— ì €ì¥í•˜ê³  ìˆëŠ”ë°, ì´ë¥¼ ì•„ë§ˆì¡´ì— ì˜¬ë ¤ì¤˜ì•¼ í•œë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ Production ë°©ë²•ìœ¼ë¡œ ë¹Œë“œí•´ì„œ ì½”ë“œë¥¼ ì••ì¶•í•´ì¤˜ì•¼ í•œë‹¤.</p>

<p>ê° ë‹¨ê³„ê°€ ë§ìœ¼ë¯€ë¡œ ì§€ê¸ˆì€ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê² ë‹¤. ì§€ê¸ˆ ìš°ë¦¬ ì½”ë“œëŠ” Babelì´ ë²ˆì—­í•´ì„œ êµ¬ë™í•´ì£¼ê³  ìˆë‹¤. ê·¸ëŸ°ë° Babelì€ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆë¼ ê°œë°œ ë‹¨ê³„ì—ì„œë§Œ ì‚¬ìš©ë˜ëŠ” ëª©ì ìœ¼ë¡œ ë§Œë“¤ì–´ì¡Œë‹¤. ì™œëƒí•˜ë©´ Babelì„ ì‚¬ìš©í•´ì„œ ë§¤ ë²ˆ ì½”ë“œë¥¼ ë²ˆì—­í•˜ë©´ êµ¬ë™ ì†ë„ê°€ ëŠë ¤ì§€ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë˜ì„œ Babel CLIë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>

<p><a href="https://www.npmjs.com/package/@babel/cli">@babel/cli</a>ë¥¼ ë³´ë©´ <code class="language-plaintext highlighter-rouge">npm install --save-dev @babel/cli</code>ë¡œ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤. <a href="https://babeljs.io/docs/en/babel-cli">ì‚¬ìš©ë²•</a>ì€ ì´ê³³ì„ ì°¸ê³ í•˜ì. <code class="language-plaintext highlighter-rouge">npm babel file</code>ì˜ í˜•íƒœë¡œ íŒŒì¼ì´ë‚˜ í´ë”ë¥¼ ë²ˆì—­í•´ì£¼ëŠ”ë° ì—¬ê¸°ì„œ -dë¡œ ì €ì¥ ìœ„ì¹˜ë¥¼ ì •í•  ìˆ˜ ìˆë‹¤. ìš°ë¦¬ëŠ” src í´ë”ë¥¼ ë²ˆì—­í•´ì„œ build í´ë”ì— ì €ì¥í•˜ë„ë¡ script ëª…ë ¹ì–´ë¥¼ ë§Œë“¤ì–´ì¤¬ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// package.json
  "scripts": {
    "build:server": "babel src -d build",
    "dev:server": "nodemon",
    "dev:assets": "webpack"
  },
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">npm run build:server</code>ë¡œ scriptë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ build í´ë”ì— ë²ˆì—­ëœ íŒŒì¼ì´ ìƒì„±ëœë‹¤. ì´ íŒŒì¼ë“¤ì€ ê¹ƒí—ˆë¸Œì— ì˜¬ë ¤ì¤„ í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ .gitignoreì— ì¶”ê°€í•´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// .gitignore
/build
</code></pre></div></div>

<p>ë¹Œë“œëœ íŒŒì¼ì„ í™•ì¸í•´ë³´ë©´ views í´ë”ê°€ ì—†ë‹¤. ê·¸ë¦¬ê³  client í´ë”ë„ ë²ˆì—­ë˜ì—ˆëŠ”ë° ìš°ë¦¬ëŠ” ë°±ì—”ë“œë¥¼ babelë¡œ ë°”ê¾¸ëŠ” ê²ƒì´ë¯€ë¡œ, í”„ë¡ íŠ¸ì—”ë“œì¸ clientëŠ” ë²ˆì—­ë˜ë©´ ì•ˆ ëœë‹¤.</p>

<p>ë¹Œë“œëœ íŒŒì¼ì„ ì‹¤í–‰í•˜ë ¤ë©´ build/init.jsë¥¼ ì‹¤í–‰ì‹œí‚¤ë©´ ëœë‹¤. ì´ë¥¼ ìœ„í•´ scriptë¥¼ í•˜ë‚˜ ë” ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// package.json
  "scripts": {
    "start": "node build/init.js",
    "build:server": "babel src -d build",
    "dev:server": "nodemon",
    "dev:assets": "webpack"
  },
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ startëŠ” ê¸°ë³¸ ëª…ë ¹ì–´ë¼ì„œ <code class="language-plaintext highlighter-rouge">npm run start</code>ê°€ ì•„ë‹ˆë¼ <code class="language-plaintext highlighter-rouge">npm start</code>ë¡œ ì‘ë™í•œë‹¤. ê·¸ëŸ°ë° <code class="language-plaintext highlighter-rouge">npm start</code>ë¡œ ì‹¤í–‰í•˜ë©´ ì‘ë™ë˜ì§€ ì•ŠëŠ”ë°, ëŒ€ì‹  â€˜regeneratorRuntime is not definedâ€™ ì—ëŸ¬ê°€ ë‚˜ì˜¨ë‹¤. ì´ëŠ” ì´ì „ì— async/awaitì„ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©í•˜ë ¤ê³  í–ˆì„ ë•Œ, ë‚˜ì˜¨ ì—ëŸ¬ë¡œ ë‹¤ìŒì—ëŠ” ì´ë¥¼ ê³ ì³ë³´ë„ë¡ í•˜ì.</p>

<h3 id="171-building-the-backend-part-two">17.1 Building the Backend part Two</h3>
<p>ì´ì „ì— â€˜regeneratorRuntime is not definedâ€™ ì—ëŸ¬ê°€ ë‚˜ì˜¨ ê²ƒì€ clientì—ì„œ async/awaitì„ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë¦¬ê³  ì´ë¥¼ import â€œregenerator-runtimeâ€ìœ¼ë¡œ í•´ê²°í•´ì¤¬ì—ˆë‹¤.</p>

<p>init.js ì œì¼ ìœ„ì— <code class="language-plaintext highlighter-rouge">import "regenerator-runtime";</code>ì„ ì ì–´ì£¼ì. ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">npm run build:server</code>ë¡œ ìƒˆë¡œ ë¹Œë“œí•œ ë‹¤ìŒ <code class="language-plaintext highlighter-rouge">npm start</code>ë¡œ ìƒˆë¡œ ì‹œì‘í•´ì£¼ì. ê·¸ëŸ¬ë©´ ì„œë²„ê°€ ì´ì „ì²˜ëŸ¼ ì‘ë™í•œë‹¤. ê·¸ëŸ°ë° build í´ë”ë¥¼ ë³´ë©´ views í´ë”ê°€ ì—†ëŠ”ë°ë„ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•œë‹¤. ì´ëŠ” viewsì˜ ìœ„ì¹˜ê°€ processë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ì •ë˜ì–´ ìˆì–´ì„œ í´ë” ìœ„ì¹˜ê°€ ê·¸ëŒ€ë¡œì—¬ë„ ì•Œì•„ì„œ ì°¾ì•„ì£¼ê¸° ë•Œë¬¸ì´ë‹¤.</p>

<p>ë‹¤ìŒì—ëŠ” assets í´ë”ë¥¼ ë¹Œë”©í•´ë³´ê² ë‹¤.</p>

<h3 id="172-building-the-frontend">17.2 Building the Frontend</h3>
<p>ë°±ì—”ë“œë¥¼ ë¹Œë“œí–ˆìœ¼ë¯€ë¡œ ì´ì œ í”„ë¡ íŠ¸ì—”ë“œë¥¼ ë¹Œë“œí•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ê¸° ìœ„í•´ì„  2ê°€ì§€ë¥¼ ìˆ˜ì •í•´ì•¼ í•œë‹¤. webpack.config.jsì—ì„œ modeì™€ watchë¥¼ ì§€ì›Œì¤€ë‹¤. ëŒ€ì‹ ì— ì´ ì˜µì…˜ì€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì§€ì •í•´ì£¼ë„ë¡ í•˜ê² ë‹¤. webpackì— â€“mode, â€“watchë¡œ modeì™€ watchë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  buildë¥¼ <code class="language-plaintext highlighter-rouge">"build": "npm run build:server &amp;&amp; npm run build:assets",</code>ë¡œ í•˜ë‚˜ë¡œ ë¬¶ì–´ì£¼ê² ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// package.json
  "scripts": {
    "start": "node build/init.js",
    "build": "npm run build:server &amp;&amp; npm run build:assets",
    "build:server": "babel src -d build",
    "build:assets": "webpack --mode=production",
    "dev:server": "nodemon",
    "dev:assets": "webpack --mode=development -w"
  },
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// webpack.config.js
module.exports = {
    entry: {
        main: "./src/client/js/main.js",
        videoPlayer: "./src/client/js/videoPlayer.js",
    },
    // delete mode and watch
    // mode: 'development',
    // watch: true,
</code></pre></div></div>

<p>ì§€ê¸ˆê¹Œì§€ ì‘ì—…í•œ ë‚´ìš©ì„ Herokuì— ì˜¬ë ¤ë³´ê² ë‹¤. ë¬¼ë¡  ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•Šê² ì§€ë§Œ, ì–´ë–¤ ì—ëŸ¬ê°€ ë°œìƒí• ì§€ ì•Œê³  ì‹¶ë‹¤.</p>

<h3 id="173-deploying-to-heroku">17.3 Deploying to Heroku</h3>
<p>ìš°ì„  Herokuì— ë“¤ì–´ê°€ì„œ íšŒì›ê°€ì…ì„ í•´ì£¼ì. ê·¸ë¦¬ê³  create new appì„ ëˆ„ë¥´ì. ì—¬ê¸°ì„œ App name, regionì„ ì„¤ì •í•˜ê³  Create app ë²„íŠ¼ì„ ëˆ„ë¥¸ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì•±ì´ ë§Œë“¤ì–´ì§„ë‹¤.</p>

<p>Herokuì— ë°°í¬í•˜ëŠ” ë°©ë²•ì€ 2ê°€ì§€ë¡œ Heroku Gitì„ ì‚¬ìš©í•˜ê±°ë‚˜ Github ìì²´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ìˆë‹¤. ìš°ì„ ì€ Heroku Gitìœ¼ë¡œ ë°°í¬í•´ë³´ê² ë‹¤. Heroku Gitìœ¼ë¡œ ë°°í¬í•˜ê¸° ìœ„í•´ Heroku CLIë¥¼ ì„¤ì¹˜í•´ì•¼ í•œë‹¤. ì‚¬ì´íŠ¸ì˜ ë§í¬ì—ì„œ OSì— ë”°ë¼ ì„¤ì¹˜í•´ì£¼ë©´ ëœë‹¤. ì„¤ì¹˜ê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ <code class="language-plaintext highlighter-rouge">heroku login</code>ì„ ì½˜ì†”ì—ì„œ ì‹¤í–‰í•œë‹¤. ì•„ë¬´í‚¤ë‚˜ ëˆ„ë¥´ê³ , ë¶ˆëŸ¬ì™€ì§€ëŠ” í˜ì´ì§€ì—ì„œ í™•ì¸ì„ í•˜ë©´ ëœë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ í”„ë¡œì íŠ¸ íŒŒì¼ì´ ìˆëŠ” í´ë”ë¡œ cdë¡œ ì´ë™í•œë‹¤. ê·¸ë¦¬ê³  ë§Œì•½ <code class="language-plaintext highlighter-rouge">git init</code>ì„ í•˜ì§€ ì•Šì•˜ë‹¤ë©´ í•´ì¤˜ì•¼í•œë‹¤. ì™œëƒí•˜ë©´ Heroku Gitì€ ê¹ƒí—ˆë¸Œ ë ˆíŒŒì§€í† ë¦¬ë¡œ ì‹¤í–‰ë˜ëŠ”ë°, ì•„ë¬´ ë‚´ìš©ë„ ì—†ìœ¼ë©´ ì‹¤í–‰í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë¦¬ê³  <code class="language-plaintext highlighter-rouge">heroku git:remote -a appname</code>ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ”ë° appnameì€ ì•ì„œ ì§€ì •í•œ ì´ë¦„ì— ë”°ë¼ ë‹¤ë¥´ë¯€ë¡œ ìì‹ ì˜ ê²ƒì„ ì‚¬ìš©í•˜ì.</p>

<p>ì´ì œ Heroku ë ˆíŒŒì§€í† ë¦¬ë¥¼ í•˜ë‚˜ ì–»ê²Œ ëœë‹¤. ì—¬ê¸°ë¡œ git add/commit/pushê°€ ê°€ëŠ¥í•˜ë‹¤. ë§Œì•½ ê¹ƒí—ˆë¸Œì— ë ˆíŒŒì§€í† ë¦¬ê°€ ìˆë‹¤ë©´ <code class="language-plaintext highlighter-rouge">heroku git:remote -a repositoryName</code>ìœ¼ë¡œ ì—°ê²°í•´ì£¼ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ì¶©ë¶„í•˜ë‹¤. ìš°ë¦¬ëŠ” ê¹ƒí—ˆë¸Œ ë ˆíŒŒì§€í† ë¦¬ì— íŒŒì¼ì„ ì˜¬ë ¸ìœ¼ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">heroku git: remote -a repositoryName</code>ì„ ì‚¬ìš©í•˜ì.</p>

<p><code class="language-plaintext highlighter-rouge">git push heroku master</code>ì„ ì…ë ¥í•˜ë©´ ìš°ë¦¬ ì½”ë“œë¥¼ ë°°í¬í•  ìˆ˜ ìˆë‹¤. ê·¸ ì „ì— ìƒˆ ì½˜ì†”ì— <code class="language-plaintext highlighter-rouge">heroku logs --tail</code>ë¡œ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì. ê·¸ë¦¬ê³  ì»¤ë§¨ë“œ ì°½ì— pushë¥¼ í•´ì£¼ë©´ ì•Œì•„ì„œ íŒŒì¼ì„ ì½ì–´ì„œ í•„ìš”í•œ ê²ƒì„ ì„¤ì¹˜í•˜ê¸° ì‹œì‘í•œë‹¤. ê·¸ëŸ°ë° HerokuëŠ” commit í•˜ì§€ ì•Šìœ¼ë©´ ì½”ë“œë¥¼ ë³¼ ìˆ˜ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ì™œ ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì¼ê¹Œ?</p>

<p>herokuëŠ” ê¸°ë³¸ì ìœ¼ë¡œ npm build, npm startë¥¼ ì‹¤í–‰í•œë‹¤. ë§Œì•½ ì´ì „ì˜ ì½”ë“œë¥¼ commitì„ í•˜ì§€ ì•Šìœ¼ë©´  buildë¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤. ê·¸ëŸ¬ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">git commit -m "some message"</code>ë¡œ ì»¤ë°‹í•´ì£¼ê³  <code class="language-plaintext highlighter-rouge">git push origin master &amp;&amp; git push heroku master</code>ë¡œ ê¹ƒí—ˆë¸Œ ë ˆíŒŒì§€í† ë¦¬ì— ì˜¬ë¦¬ê³ , Herokuë„ ì‹¤í–‰í•´ì£¼ê² ë‹¤.</p>

<table>
  <tbody>
    <tr>
      <td>ê·¸ëŸ°ë° ë¡œê·¸ë¥¼ ë³´ë©´ Assertion failed: You must provide either mongoUrl</td>
      <td>clientPromise</td>
      <td>clientë¼ëŠ” ì—ëŸ¬ê°€ ë‚˜ì˜¤ê³  Error: Cannot init client. ë¼ëŠ” ê²ƒë„ ë‚˜ì™€ ìˆë‹¤.</td>
    </tr>
  </tbody>
</table>

<p>herokuê°€ ë³´ëŠ” íŒŒì¼ì€ ëª¨ë‘ githubì˜ íŒŒì¼ì´ë‹¤. ê·¸ëŸ°ë° db.jsë¥¼ ë³´ë©´ process.env.DB_URLì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ë¬¸ì œëŠ” ìš°ë¦¬ê°€ .gitignoreë¡œ .envë¥¼ ì˜¬ë ¤ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì— ë°œìƒí•œë‹¤. í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” .env íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì•ˆ ëœë‹¤. ëŒ€ì‹ ì— process.env.DB_URLë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ì´ ìˆë‹¤.</p>

<p>í˜„ì¬ ìš°ë¦¬ëŠ” Herokuë¡œ ë°°í¬í•˜ëŠ”ë° ì„±ê³µí–ˆì§€ë§Œ, ì•„ì§ DBê°€ ì—†ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ mongoDB Atlas ê³„ì •ì´ í•„ìš”í•˜ë¯€ë¡œ íšŒì›ê°€ì… í•´ì£¼ì.</p>

<h3 id="174-mongodb-atlas">17.4 MongoDB Atlas</h3>
<p>mongoDB Atlasì— ê°€ì…í–ˆë‹¤ë©´, New Projectë¡œ ìƒˆë¡œ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤. ê·¸ë¦¬ê³  Create Projectë¥¼ ëˆ„ë¥´ê³ , ëª¨ë‘ freeë¡œ ì„ íƒí•œë‹¤. ì§€ì—­ì„ ì„ íƒí•˜ê³ , ê³„ì† ì§„í–‰í•œë‹¤. ì¤‘ê°„ì— ë¹„ë°€ë²ˆí˜¸ì™€ urlì´ ë‚˜ì˜¤ëŠ”ë°, urlì— ë¹„ë°€ë²ˆí˜¸ë¥¼ ë„£ì–´ì¤˜ì•¼ í•˜ë¯€ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ê¼­ ë‹¤ë¥¸ ê³³ì— ì €ì¥í•´ë‘ì. ê·¸ë¦¬ê³  Heroku ì‚¬ì´íŠ¸ë¡œ ì´ë™í•´ì„œ settingsë¡œ ë“¤ì–´ê°€ì„œ Reveal Config Varsë¥¼ ëˆ„ë¥¸ë‹¤. ì—¬ê¸°ì„œ KEY VALUEë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ê³µê°„ì´ ìˆëŠ”ë°, ì—¬ê¸°ë‹¤ê°€ DB_URLì„ KEYë¡œ í•˜ê³ , Atlasì˜ urlì„ valueë¡œ ë„£ì–´ì¤€ë‹¤. ì´ë ‡ê²Œí•˜ë©´ .envë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  Herokuë¡œ ë³€ìˆ˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ server.jsì— COOKIE_SECRETì„ ì„¤ì •í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì´ ì—­ì‹œ Config Varsì— ì¶”ê°€í•´ì¤˜ì•¼ í•œë‹¤. COOKIE_SECRETì€ ëœë¤í•œ ê°’ì´ë¯€ë¡œ ì•„ë¬´ê²ƒì´ë‚˜ ì ì–´ì£¼ë©´ ëœë‹¤.</p>

<p>í•˜ì§€ë§Œ Herokuê°€ ì„œë²„ì™€ ì—°ê²°ì— ì‹¤íŒ¨í–ˆë‹¤ëŠ” ì—ëŸ¬ê°€ ë‚˜ì˜¨ë‹¤.</p>

<h3 id="175-environment-variables">17.5 Environment Variables</h3>
<p>ìš°ë¦¬ëŠ” PORTë¡œ 4000ì„ ì“°ê³  ìˆë‹¤. ê·¸ëŸ°ë° Herokuê°€ ì„¤ì •í•´ì¤€ PORTë¡œ ì—°ê²°í•´ì•¼ í•˜ë¯€ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤. ê·¸ë˜ì„œ init.jsì—ì„œ <code class="language-plaintext highlighter-rouge">const PORT = process.env.PORT || 4000</code>;ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤. ì´ë ‡ê²Œí•˜ë©´ Herokuë¥¼ ì‚¬ìš©í•  ë•Œì™€ ì»´í“¨í„°ì—ì„œ ì‚¬ìš©í•  ë•Œ, ëª¨ë‘ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•œë‹¤. ë‹¤ì‹œ git commit, git push heroku master ìœ¼ë¡œ ë ˆíŒŒì§€í† ë¦¬ë¥¼ ì—…ë¡œë“œí•´ì•¼ í•œë‹¤. ì´í›„ Herokuê°€ ë‹¤ì‹œ ì‹œì‘ëœë‹¤.</p>

<p>ìƒˆë¡œ PORTê°€ ì—´ë¦¬ë©´, Heroku í˜ì´ì§€ë¡œ ëŒì•„ê°€ì„œ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ë©´ ë¸Œë¼ìš°ì € ìƒì— ìš°ë¦¬ê°€ ë§Œë“  í˜ì´ì§€ê°€ ë³´ì´ê²Œ ëœë‹¤. ê¹ƒí—ˆë¸Œë¡œ ë¡œê·¸ì¸ í•˜ë ¤ë©´ ì—­ì‹œ .env íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ GH_CLIENTë¥¼ ì„¤ì •í•´ì¤˜ì•¼ í•œë‹¤. ì•„ê¹Œ Cofig Varsë¡œ ëŒì•„ê°€ì„œ ì¶”ê°€í•´ì£¼ê³ , GH_SECRETë„ ì¶”ê°€í•´ì•¼í•œë‹¤. ëª¨ë“  ê²ƒì„ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ ì´ì œ Hide Config Varsë¡œ ê°€ë ¤ì£¼ë©´ ëœë‹¤.</p>

<h3 id="176-github-and-aws-s3-part-one">17.6 Github and AWS S3 part One</h3>
<p>ê·¸ëŸ°ë° ê¹ƒí—ˆë¸Œë¡œ ë¡œê·¸ì¸ í•˜ë ¤ê³  í•˜ë©´ ìš°ë¦¬ê°€ localhost:4000ìœ¼ë¡œ ëŒì•„ê°€ë„ë¡ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì— ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤. Github settingë¡œ ì´ë™í•´ì„œ Authorization callback URLì— Herokuì—ì„œ ì‚¬ìš©í•˜ëŠ” URLì„ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤. ë§¤ë²ˆ ì´ë ‡ê²Œí•˜ë©´ ë²ˆê±°ë¡­ê¸° ë•Œë¬¸ì— 2ê°œë¥¼ ë§Œë“¤ì–´ì„œ í•˜ë‚˜ëŠ” í…ŒìŠ¤íŠ¸ìš©, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ë°°í¬ìš©ìœ¼ë¡œ ë§Œë“œëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.</p>

<p>ì´ì œ Atlasë¡œ ì´ë™í•´ì„œ usersë¥¼ ë³´ë©´ ê¹ƒí—ˆë¸Œë¡œ ë¡œê·¸ì¸í•œ ì •ë³´ê°€ ë³´ì´ê²Œ ëœë‹¤.</p>

<p>ì´ì œ Githubë¡œ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì•Œã…‡ì•„ë³´ì. Heroku ì‚¬ì´íŠ¸ì—ì„œ Connect to Github ì•„ì´ì½˜ì„ ëˆ„ë¥¸ë‹¤. ê·¸ë¦¬ê³  ë ˆíŒŒì§€í† ë¦¬ë¥¼ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•´ì„œ ì—°ê²°í•˜ë©´ ì¤€ë¹„ëŠ” ëë‚¬ë‹¤. ì—¬ê¸°ì„œëŠ” ê¹ƒí—ˆë¸Œ ë ˆíŒŒì§€í† ë¦¬ì— <code class="language-plaintext highlighter-rouge">git push origin master</code>ë¥¼ í•  ë•Œë§ˆë‹¤ ë°”ë¡œ ë°°í¬í•˜ê²Œ ëœë‹¤. ë‹¤ì‹œ ë§í•´ ì´ì œ <code class="language-plaintext highlighter-rouge">git push heroku master</code>ì„ í•´ì¤„ í•„ìš”ê°€ ì—†ë‹¤. ë¬¼ë¡  git push origin masterì„ í•  ë•Œë§ˆë‹¤ ë°°í¬ê°€ ë˜ê¸° ë•Œë¬¸ì— ë¸Œëœì¹˜ê°€ ë°°í¬ ê°€ëŠ¥í•œ ìƒíƒœì—¬ì•¼ë§Œ í•œë‹¤.</p>

<p>ì´ì œ í”„ë¡œí•„ì„ ìˆ˜ì •í•´ì„œ ì´ë¯¸ì§€ë¥¼ ë°”ê¿”ë³´ì. ê·¸ëŸ°ë° <code class="language-plaintext highlighter-rouge">git push heroku master</code>ì„ ì‚¬ìš©í•´ì„œ ì•±ì„ ì¬ë°°í¬ í•˜ë©´ ì´ì „ ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì‚­ì œëœë‹¤. ì´ëŠ” ë§¤ë²ˆ ìƒˆë¡œ ë°°í¬í•  ë•Œë§ˆë‹¤ ì™„ì „íˆ ìƒˆë¡œìš´ ì•±ì„ ë§Œë“¤ê¸° ë•Œë¬¸ì— ë°œìƒí•œë‹¤.</p>

<h3 id="177-aws-s3-part-two">17.7 AWS S3 part Two</h3>
<p>ì´ì œ ì„œë²„ë¥¼ íŒŒì¼ ì €ì¥ì†Œë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê·¸ë§Œë‘ê² ë‹¤. ì™œëƒí•˜ë©´ ì„œë²„ë¥¼ ì—…ë°ì´íŠ¸ í–ˆì„ ë¿ì¸ë° ì €ì¥ëœ ì´ë¯¸ì§€ì™€ ë¹„ë””ì˜¤ê°€ ëª¨ë‘ ì‚­ì œë˜ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë˜ì„œ íŒŒì¼ì„ ì €ì¥í•˜ê¸° ìœ„í•´ AWSë¥¼ ì‚¬ìš©í•˜ê² ë‹¤. AWS Service - Storage - S3ë¡œ ì´ë™í•œë‹¤. ê·¸ë¦¬ê³  Create bucketì„ ëˆ„ë¥¸ë‹¤. bucket nameì€ ìœ ì¼í•´ì•¼ í•˜ë¯€ë¡œ ì ë‹¹í•œ ì´ë¦„ì„ ì„ íƒí•˜ì. ìš°ë¦¬ëŠ” block all public accessë§Œ ëˆ„ë¥´ê³  bucketì„ ë§Œë“ ë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ API Keyë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤. IAMìœ¼ë¡œ ì´ë™í•´ì„œ Users, Add usersë¥¼ ëˆ„ë¥¸ë‹¤. user namedì„ ì…ë ¥í•˜ê³  programmatic accessë¥¼ ì²´í¬í•˜ì. ë‹¤ìŒìœ¼ë¡œ ê¶Œí•œì„ ì¤„ ìˆ˜ ìˆëŠ”ë°, ê´€ë¦¬ì ê¶Œí•œ(AdministratorAccess)ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ë©´ ì•ˆ ëœë‹¤. ë§Œì•½ ì´ ê¶Œí•œì„ ì£¼ë©´ ì´ Keyë¥¼ ì•Œì•„ë‚´ëŠ” ìˆœê°„ ê³„ì •ì˜ ëª¨ë“  ê¶Œí•œì„ ì–»ê²Œ ëœë‹¤. ëŒ€ì‹ ì— AmazonS3FullAccessë¥¼ ì„ íƒí•œë‹¤.</p>

<p>tagëŠ” í•„ìš”ì—†ê³  reviewë¡œ ì›í•˜ëŠ”ëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê³  Create Userë¥¼ ëˆ„ë¥¸ë‹¤. ê·¸ëŸ¬ë©´ Access key IDì™€ Secret access keyë¥¼ ë³´ì—¬ì£¼ëŠ”ë°, Secret access keyëŠ” ì´ í˜ì´ì§€ì—ì„œ ë‹¨ í•œ ë²ˆ ë°–ì— ì•ˆ ë³´ì—¬ì¤€ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì € ë‘˜ì„ ë³µì‚¬í•´ì„œ .envì— ì¶”ê°€í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤. ì´ì œ herokuì˜ ì„¤ì •ìœ¼ë¡œ ê°€ì„œ ì € ë‘ ë³€ìˆ˜ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤. AWS_ID, AWS_SECRETë¥¼ ì¶”ê°€í•´ì£¼ë©´ ì¤€ë¹„ëŠ” ëë‚¬ë‹¤.</p>

<p>ì´ì œ Multer S3ë¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤. ì´ íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ aws-sdkë¼ëŠ” íŒ¨í‚¤ì§€ë„ í•„ìš”í•˜ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">npm i aws-sdk multer-s3</code>ë¡œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ê³  middlewares.jsë¡œ ì´ë™í•´ì„œ ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì •í•´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// middlewares.js
import aws from "aws-sdk";
import multerS3 from "multerS3";

const se = new aws.S3({
    credentials: {
        accessKeyId: process.end.AWS_ID,
        secretAccessKey: process.env.AWS_SECRET,
    }
})

const multerUploader = multerS3({
    s3: s3,
    bucket: "bucketname",
});

...
export const avatarUpload = multer({
    dest: "uploads/avatars/",
    limits: {
        fileSize: 3000000,
    }
    storage: multerUploader,
});

export const videoUpload = multer({
    dest: "uploads/videos/",
    limits: {
        fileSize: 10000000,
    },
    storage: multerUploader,
})
</code></pre></div></div>

<p>ì´ì œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ íŒŒì¼ì´ AWSì— ì˜¬ë¼ê°€ê²Œ ëœë‹¤. ê·¸ëŸ°ë° avatarUrlì´ ì‚¬ë¼ì§€ëŠ” ë²„ê·¸ê°€ ìƒê²¼ë‹¤.</p>

<h3 id="178-aws-s3-part-three">17.8 AWS S3 part Three</h3>
<p>AWSì˜ bucketì—ì„œ permissionì— ë“¤ì–´ê°€ì„œ ë§ˆì§€ë§‰ 2ê°œë§Œ ì²´í¬í•´ì¤€ë‹¤. ê·¸ë¦¬ê³  ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì •í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// middlewares.js
const multerUploader = multerS3({
    s3: s3,
    bucket: "bucketname",
    acl: "public-read",
});
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const postEdit = async (req, res) =&gt; {
    console.log(file);
    const updateUser = await User.findByIdAndupdate(
        _id,
        {
            avatarUrl: file ? file.path : avatarUrl,
            ...
        }
    )
    ...
};
</code></pre></div></div>

<p>ì´ì œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ì¶œë ¥ë˜ëŠ” ê²ƒì„ í™•ì¸í•´ë³´ì. ë³´ë©´ íŒŒì¼ ìœ„ì¹˜ê°€ locationìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìœ„ì˜ file.pathëŠ” file.locationìœ¼ë¡œ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
export const postEdit = async (req, res) =&gt; {
    console.log(file);
    const updateUser = await User.findByIdAndupdate(
        _id,
        {
            avatarUrl: file ? file.location: avatarUrl,
            ...
        }
    )
    ...
};
</code></pre></div></div>

<p>ë™ì¼í•œ ì¼ì„ ë¹„ë””ì˜¤ì—ë„ í•´ì¤˜ì•¼ í•œë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// videoController.js
const postUpload = ... {
    const newVideo = ... ({
        fileUrl: video[0].location,
        thumbUrl: thumb[0].location,
    })
}
</code></pre></div></div>

<p>ê·¸ ì™¸ì— í¼ê·¸ì— ë§í¬ë„ ìˆ˜ì •í•´ì£¼ë©´ ëœë‹¤.</p>
<h3 id="179-production-environment">17.9 Production Environment</h3>

<h3 id="1710-conclusions">17.10 Conclusions</h3>

:ET