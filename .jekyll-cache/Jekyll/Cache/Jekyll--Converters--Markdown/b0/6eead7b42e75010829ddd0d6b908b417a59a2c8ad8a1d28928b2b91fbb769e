I"ÀŠ<p>ì›¹ì‚¬ì´íŠ¸ë¥¼ ì´ìš©í•˜ë‹¤ë³´ë©´ ì†Œì…œ ë¡œê·¸ì¸ì„ ë§ˆì£¼ì¹˜ê²Œ ëœë‹¤. ì—¬ê¸°ì„œ ì†Œì…œ ë¡œê·¸ì¸ì´ë€ êµ¬ê¸€, ì¹´ì¹´ì˜¤, ê¹ƒí—ˆë¸Œ ë“±ì˜ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì˜ ê³„ì •ìœ¼ë¡œ í˜ì´ì§€ì— ë¡œê·¸ì¸ í•˜ëŠ” ê²ƒì„ ë§í•œë‹¤. ì†Œì…œ ë¡œê·¸ì¸ì„ ì´ìš©í•˜ë©´ í•˜ë‚˜ì˜ ê³„ì •ìœ¼ë¡œ ì—¬ëŸ¬ ì‚¬ì´íŠ¸ì—ì„œ ë¡œê·¸ì¸ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ê°„í¸í•˜ë¯€ë¡œ ë§ì€ ì‚¬ìš©ìê°€ ì´ìš©í•œë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ê¹ƒí—ˆë¸Œë¥¼ ì‚¬ìš©í•´ì„œ ì†Œì…œ ë¡œê·¸ì¸ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ë‹¤. ë‹¤ë¥¸ ì†Œì…œ ë¡œê·¸ì¸ë„ ì„¸ì„¸í•œ ë¶€ë¶„ì€ ë‹¤ë¥´ì§€ë§Œ í° í‹€ì€ ë¹„ìŠ·í•˜ë¯€ë¡œ, ê¹ƒí—ˆë¸Œ ë°©ì‹ë§Œ ì•Œë©´ ë‹¤ë¥¸ ì†Œì…œ ë¡œê·¸ì¸ì—ë„ ì ìš© ê°€ëŠ¥í•˜ë‹¤.</p>

<h3 id="authorized-oauth-apps">Authorized OAuth Apps</h3>
<p>ì†Œì…œ ë¡œê·¸ì¸ì„ í•˜ê¸° ì „ì— ê¹ƒí—ˆë¸Œì—ì„œ ëª‡ ê°€ì§€ í•´ì•¼ í•  ì¼ì´ ìˆë‹¤. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ê°€ì.</p>

<ol>
  <li>github.com/settings/applicationsì— ì ‘ì†í•œë‹¤.</li>
  <li>ì¢Œì¸¡ì˜ Developer settingsì— ë“¤ì–´ê°„ë‹¤.</li>
  <li>ì¢Œì¸¡ì˜ OAut Appsë¥¼ ëˆ„ë¥¸ë‹¤.</li>
  <li>ì˜¤ë¥¸ìª½ ìœ„ì˜ New OAut Appì„ ëˆ„ë¥¸ë‹¤.</li>
  <li>Application nameì€ ì›í•˜ëŠ” ëŒ€ë¡œ ì ì–´ì£¼ê³ , Homepage URLì€ ìš°ë¦¬ ì›¹ì‚¬ì´íŠ¸ì˜ URLì„ ì ì–´ì¤€ë‹¤.(ìš°ë¦¬ì˜ ê²½ìš° http://localhost:4000/)</li>
  <li>Application descripttionì€ ì ë‹¹íˆ ì ì–´ì£¼ê³ , Authorization callback URLì€ ìš°ì„ ì€ http://localhost:4000/users/github/finish ë¡œ ë„£ì–´ì¤€ë‹¤. ì•„ë¬´ê±°ë‚˜ ë„£ì–´ì¤˜ë„ ë˜ì§€ë§Œ ì½”ë“œì—ì„œ ì‚¬ìš©í•´ì•¼ í•˜ë‹ˆ ê¼­ ê¸°ì–µí•˜ì.</li>
  <li>Register applicationì„ ëˆ„ë¥¸ë‹¤.</li>
  <li>Client IDê°€ ë‚˜ì˜¤ëŠ” í˜ì´ì§€ê°€ ë³´ì´ëŠ”ë° ì´ í˜ì´ì§€ëŠ” ì¶”í›„ì— ì¨ì•¼í•˜ë‹ˆ ë„ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ë‘”ë‹¤.</li>
</ol>

<p>ê¹ƒí—ˆë¸Œì—ì„œ í•„ìš”í•œ ê²ƒì„ ëëƒˆìœ¼ë©´ ë³¸ê²©ì ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ì. ì†Œì…œ ë¡œê·¸ì¸ì´ í–‰í•´ì§€ëŠ” ê³¼ì •ê³¼ ì„¤ëª…ì€ <a href="https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps">Aurhoeizing OAuth Apps</a>ì—ì„œ ì½ì„ ìˆ˜ ìˆëŠ”ë°, í° í‹€ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ol>
  <li>ì‚¬ìš©ìëŠ” ê¹ƒí—ˆë¸Œë¡œ ë³´ë‚´ì ¸ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­í•œë‹¤.</li>
  <li>ê¹ƒí—ˆë¸ŒëŠ” ì‚¬ìš©ìë¥¼ ë‹¤ì‹œ ì›¹ì‚¬ì´íŠ¸ë¡œ ëŒë ¤ë³´ë‚´ì¤€ë‹¤.</li>
  <li>ëŒë¥¼ë°›ì„ ë•Œ, ë°›ì€ í† í°ìœ¼ë¡œ ì›¹ì‚¬ì´íŠ¸ì— ì ‘ê·¼ ê°€ëŠ¥í•´ì§„ë‹¤.</li>
</ol>

<h3 id="1-request-a-users-github-identity">1 Request a userâ€™s GitHub identity</h3>

<h4 id="11-ë§¤ê°œë³€ìˆ˜">1.1 ë§¤ê°œë³€ìˆ˜</h4>

<p>ìš°ë¦¬ëŠ” ê¹ƒí—ˆë¸Œë¡œë¶€í„° ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì™€ì•¼ í•˜ëŠ”ë°, â€œhttps://github.com/login/oauth/authorizeâ€ì—ë‹¤ê°€ GETìœ¼ë¡œ ì •ë³´ë¥¼ ìš”ì²­í•˜ê²Œ ëœë‹¤. ìš”ì²­í•  ë•Œ ë’¤ì— ë§¤ê°œë³€ìˆ˜ë¥¼ ë¶™ì¼ ìˆ˜ ìˆëŠ”ë°, ìš°ë¦¬ê°€ í•„ìš”í•œ ì •ë³´ë¥¼ ë°›ìœ¼ë ¤ë©´ ì ì ˆí•œ ë§¤ê°œë³€ìˆ˜ë¥¼ ë§ë¶™ì—¬ì•¼ í•œë‹¤.</p>

<ul>
  <li>client_id: <strong>í•„ìˆ˜</strong>ì ìœ¼ë¡œë³´ë‚´ì¤˜ì•¼ í•˜ëŠ” ê°’ìœ¼ë¡œ, ì•ì„œ ê¹ƒí—ˆë¸Œì—ì„œ ë§Œë“  Client IDë¥¼ ì ì–´ì¤˜ì•¼ í•œë‹¤.</li>
  <li>scope: ìœ ì €ì—ê²Œì„œ ì–¼ë§ˆë‚˜ ë§ì€ ì •ë³´ë¥¼ ìš”ì²­í• ì§€ ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ ì–´ë–¤ ê²ƒì„ ë°›ì„ ìˆ˜ ìˆëŠ”ì§€ëŠ” <a href="https://docs.github.com/en/developers/apps/building-oauth-apps/scopes-for-oauth-apps">scope</a>ë¥¼ ì°¸ê³ í•˜ì. ìš°ë¦¬ê°€ í•„ìš”í•œ ê²ƒì€ read:userê³¼ user:emailì´ë‹¤.</li>
  <li>allow_signup: ê¹ƒí—ˆë¸Œë¡œ ë³´ë‚´ì¤¬ì„ ë•Œ, ì•„ì´ë””ê°€ ìˆë‹¤ë©´ ë¡œê·¸ì¸ í•˜ê² ì§€ë§Œ ì—†ì„ ê²½ìš°ëŠ” ìƒˆë¡œ ë§Œë“¤ê²Œ ë  ê²ƒì´ë‹¤. ë§Œì•½ allow_signupì„ trueë¡œ ì§€ì •í•˜ë©´ ìƒˆë¡œ ì•„ì´ë””ë¥¼ ë§Œë“œëŠ” ê²ƒì„ í—ˆìš©í•˜ì§€ë§Œ, falseë¡œ ì§€ì •í•˜ë©´ ì•„ì´ë””ë¥¼ ë§Œë“œëŠ” ê²ƒì„ ì œí•œí•œë‹¤.</li>
</ul>

<p>ì£¼ì†Œì— ë§¤ê°œë³€ìˆ˜ë¥¼ ë¶™ì—¬ì£¼ë ¤ë©´ ê¸°ë³¸ì •ì¸ urlì˜ ì‚¬ìš©ë²•ì„ ì•Œì•„ì•¼ í•œë‹¤. url ë’¤ì— ?ë¥¼ ë¶™ì´ë©´ ë§¤ê°œë³€ìˆ˜ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ì„œ êµ¬ê¸€ì—ì„œ ê²€ìƒ‰í•  ê²½ìš°, ?q=ê²€ìƒ‰ì–´ í˜•íƒœë¡œ ì£¼ì†Œë¥¼ ë³´ë‚´ì„œ ê²€ìƒ‰ì–´ë¥¼ ì•Œë ¤ì¤€ë‹¤. ë˜í•œ &amp;ë¥¼ ì‚¬ìš©í•˜ë©´ ë™ì‹œì— ì—¬ëŸ¬ ë§¤ê°œë³€ìˆ˜ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ?a=1&amp;b=2ë¥¼ ì‚¬ìš©í•˜ë©´ a=1ê³¼ b=2ë¥¼ ë™ì‹œì— ì‚¬ìš©í•œë‹¤.</p>

<h4 id="12-ë§í¬-ë§Œë“¤ê¸°">1.2 ë§í¬ ë§Œë“¤ê¸°</h4>

<p>ë‹¤ì‹œ ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ì„œ ìš°ë¦¬ëŠ” â€œhttps://github.com/login/oauth/authorizeâ€ì—ë‹¤ê°€ client_idì™€ allow_signupì„ ë³´ë‚´ì¤˜ì•¼ í•œë‹¤. ì´ë•Œ client_idëŠ” ì•ì„œ ê¹ƒí—ˆë¸Œì—ì„œ ë§Œë“  ê²ƒì´ë‹ˆ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ë„£ì–´ì£¼ê³ , signupì€ falseë¡œ ì§€ì •í•´ì„œ íšŒì›ê°€ì…ì€ ë§‰ì•„ë†“ê² ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì£¼ì†ŒëŠ” â€œhttps://github.com/login/oauth/authorize?client_id=9fac726866be2ff14f36&amp;allow_signup=falseâ€ê°€ ëœë‹¤. ì´ ìœ„ì¹˜ë¡œ ê°€ëŠ” ë§í¬ë¥¼ login.pugì— ë§Œë“¤ì–´ì£¼ë©´ ë‹¤ìŒì²˜ëŸ¼ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// login.pug
        input(type="submit", value="Login")
        br
        a(href="https://github.com/login/oauth/authorize?client_id=6d1bb5d0737bc0cd2d42&amp;allow_signup=false") Continue with Github &amp;rarr;    // *
    hr
    div
        span Don't have an account? 
</code></pre></div></div>

<p>ì´ ë§í¬ë¥¼ ëˆ„ë¥´ë©´ ê¹ƒí—ˆë¸Œì—ì„œ ë¡œê·¸ì¸ì„ í—ˆê°€í•˜ëŠ” í˜ì´ì§€ê°€ ë‚˜ì˜¤ê²Œ ëœë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì²« ë²ˆì§¸ ë‹¨ê³„ëŠ” í•´ê²°í–ˆë‹¤.</p>

<h4 id="13-ë§í¬-ìˆ˜ì •">1.3 ë§í¬ ìˆ˜ì •</h4>

<p>í•˜ì§€ë§Œ í•œ ê°€ì§€ ë¬¸ì œê°€ ë‚¨ì•„ ìˆë‹¤. ë°”ë¡œ ë§í¬ê°€ ë„ˆë¬´ ê¸¸ì–´ì§„ë‹¤ëŠ” ê²ƒì´ë‹¤. ë§Œì•½ ì§€ê¸ˆ ë” ë§ì€ ë‚´ìš©ì„ ë§¤ê°œë³€ìˆ˜ë¡œ ë³´ë‚´ê³  ì‹¶ë‹¤ë©´ ë§í¬ê°€ ê¸¸ì–´ì ¸ì„œ ê°€ë…ì„±ì´ í¬ê²Œ ë–¨ì–´ì§„ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ë§í¬ë¡œ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ í›„ì— ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ì´ë¥¼ ê´€ë¦¬í•´ì£¼ê² ë‹¤. login.pugì—ì„œ ë§í¬ë¥¼ ì•„ë˜ì²˜ëŸ¼ ë°”ê¿”ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// login.pug
...
        a(href="/users/github/start") Continue with Github &amp;rarr;
...
</code></pre></div></div>

<p>ì•„ì§ users/github/start ë¼ìš°í„°ê°€ ì—†ìœ¼ë¯€ë¡œ uerRouter.jsì— ë¼ìš°í„°ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
import {
    ...
    startGithubLogin    // *
    ...
} from "../controllers/userController";
...
userRouter.get("/remove", remove);
userRouter.get("/users/github/start", startGithubLogin);    // *
userRouter.get(":id", see);
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  userController.jsì— ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤. ì´ë•Œ, ì •ë³´ë¥¼ ë‚˜ëˆ ì„œ ì ì–´ì¤„í…ë° baseUrlì—ëŠ” ìš°ë¦¬ê°€ ìš”ì²­í•  í˜ì´ì§€ë¥¼ ì ê³ , ì¶”ê°€ì ì¸ ì •ë³´ëŠ” configì— ì ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const startGithubLogin = (req, res) =&gt; {
  const baseUrl = "https://github.com/login/oauth/authorize";
  const config = {
    client_id: "6d1bb5d0737bc0cd2d42",
    allow_signup: false,
    scope: "read:user user:email",
  };
};
</code></pre></div></div>

<h4 id="14-urlsearchparams">1.4 URLSearchParams</h4>

<p>ê·¸ëŸ°ë° ë¬¸ì œëŠ” configì˜ ì •ë³´ë¥¼ ì–´ë–»ê²Œ í•˜ë‚˜ë¡œ ëª¨ì„ ê²ƒì¸ì§€ë‹¤. ì´ëŠ” <a href="https://developer.mozilla.org/ko/docs/Web/API/URLSearchParams">URLSearchParams</a>ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤. URLSearchParamsëŠ” URLì˜ ? ë’· ë¶€ë¶„ì„, ë‹¤ì‹œ ë§í•´ ì „ë‹¬ë˜ëŠ” ë³€ìˆ˜ ë¶€ë¶„ì„ ì‚¬ìš©í•˜ê²Œ í•´ì¤€ë‹¤. ì•„ë˜ ì˜ˆì‹œë¥¼ ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Retrieve params via url.search, passed into ctor
var url = new URL('https://example.com?foo=1&amp;bar=2');
var params = new URLSearchParams(url.search);

// Pass in a string literal
var params2 = new URLSearchParams("foo=1&amp;bar=2");
var params2a = new URLSearchParams("?foo=1&amp;bar=2");

// Pass in a sequence of pairs
var params3 = new URLSearchParams([["foo", "1"], ["bar", "2"]]);

// Pass in a record
var params4 = new URLSearchParams({"foo": "1", "bar": "2"});
</code></pre></div></div>

<p>ìœ„ì˜ ì˜ˆì‹œë¥¼ ë³´ë©´ <code class="language-plaintext highlighter-rouge">url = new URL()</code>ì„ í•˜ë‚˜ ë°›ì•„ì˜¨ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. URLì„ ì‚¬ìš©í•˜ë©´ ë³€ìˆ˜ë¡œ ë°›ì•„ì˜¨ urlì„ ë¶„ì„í•´ì„œ URL ê°ì²´ë¥¼ ë§Œë“ ë‹¤. íŠ¹íˆ ê·¸ ì•ˆì—ëŠ” searchë¼ëŠ” ê²ƒì´ í¬í•¨ë˜ëŠ”ë° URLì˜ ë§¤ê°œë³€ìˆ˜ê°€ string í˜•íƒœë¡œ ì €ì¥ëœë‹¤. ê·¸ëŸ¬ë¯€ë¡œ url.searchë¥¼ ì‚¬ìš©í•˜ë©´ í•´ë‹¹ urlì˜ ë§¤ê°œë³€ìˆ˜ ë¶€ë¶„ë§Œ ë‚˜ì˜¤ëŠ” ê²ƒì´ë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ URLSearchParamsì— ë§¤ê°œë³€ìˆ˜ stringì´ ìˆëŠ” êµ¬ì²´ì ì¸ í˜•íƒœë¥¼ ì‚´í´ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const params = new URLSearchParams("q=first+second&amp;value=1&amp;person=Me");

params.get("q") === "first second";
params.get("value") === "1";
params.get("person") === "Me";
</code></pre></div></div>

<p>ìœ„ë¥¼ ë³´ë©´ params.getì„ ì‚¬ìš©í•˜ë©´ ë§¤ê°œë³€ìˆ˜ì˜ ê°’ì„ ì‰½ê²Œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ë¿ ë§Œì•„ë‹ˆë¼ setì„ ì‚¬ìš©í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ ê°’ì„ ë„£ì–´ì£¼ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>params.set("value", 2);

</code></pre></div></div>

<p>ë§Œì•½ ë‹¤ë¥¸ ê°’ì„ ì¶”ê°€í•˜ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒì²˜ëŸ¼ appendë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>params.append("person", "You");
params.getAll("person") === ["Me", "You"];
</code></pre></div></div>

<p>deleteë¥¼ ì‚¬ìš©í•˜ë©´ ì§€ìš°ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>params.delete("person");
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ê°€ì¥ ì¤‘ìš”í•œ ê¸°ëŠ¥ìœ¼ë¡œ ì´ë¥¼ ë‹¤ì‹œ stringìœ¼ë¡œ ë°”ê¾¸ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const url = new URL("http://example.com?foo=1&amp;bar=2");
const params = new URLSearchParams(url.search);
params.set("bar", 3);

params.toString() === "foo=1&amp;bar=3";
</code></pre></div></div>

<p>ì •ë¦¬í•˜ë©´ URLSearchParamsë¥¼ ì‚¬ìš©í•˜ë©´ URLì˜ ë§¤ê°œë³€ìˆ˜ ë¶€ë¶„ì„ ìˆ˜ì •í•  ìˆ˜ ìˆê³ , ë§ˆì§€ë§‰ì— toString()ìœ¼ë¡œ ë‹¤ì‹œ stringìœ¼ë¡œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const url = new URL("http://example.com?foo=1&amp;bar=2");
const params = new URLSearchParams(url.search);
params.set("bar", 3);

const newParams = params.toString();

const modifiedUrl = `${url.origin}?${newParams}`
</code></pre></div></div>

<h3 id="2-users-are-redirected-back-to-your-site-by-github">2. Users are redirected back to your site by GitHub</h3>

<p>ìš°ë¦¬ê°€ í•˜ë ¤ë˜ ê²ƒì€ configì— ì ì–´ì¤€ ê²ƒì„ baseUrl ë’¤ì— ë¶™ì—¬ì£¼ëŠ” ê²ƒì´ë‹¤. ìš°ì„  configë¥¼ stringìœ¼ë¡œ ë°”ê¿”ì£¼ë ¤ë©´ <code class="language-plaintext highlighter-rouge">const params = new URLSearchParams(config).toString();</code>ì„ í•´ì£¼ë©´ ëœë‹¤. ê·¸ë¦¬ê³  ë°±í‹±ì„ ì‚¬ìš©í•´ì„œ ë‘ ì£¼ì†Œë¥¼ í•˜ë‚˜ë¡œ í•©ì³ì¤€ ë‹¤ìŒ ridirectë¡œ í•´ë‹¹ ì£¼ì†Œë¡œ ë³´ë‚´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const startGithubLogin = (req, res) =&gt; {
  const baseUrl = "https://github.com/login/oauth/authorize";
  const config = {
    client_id: "9fac726866be2ff14f36",
    allow_signup: false,
    scope: "read:user user:email",
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  return res.redirect(finalUrl);
};
</code></pre></div></div>

<p>ì´ë ‡ê²Œ ë˜ë©´ finalUrlë¡œ ë³´ë‚´ì£¼ëŠ”ë°, ê¹ƒí—ˆë¸Œì—ì„œ í—ˆê°€í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ê°€ ë‚˜ì˜¤ê²Œ ëœë‹¤. ê·¸ë¦¬ê³  ì—¬ê¸°ì„œ Authorizeë¥¼ ëˆ„ë¥´ë©´ ê¹ƒí—ˆë¸ŒëŠ” ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ë„˜ê²¨ì¤€ë‹¤. ì—¬ê¸°ì„œ ì£¼ì†Œë¥¼ ì‚´í´ë³´ë©´ ì´ì „ì— OAut Appì„ ë§Œë“¤ë•Œ, ì ì–´ì¤€ callbackì˜ ì£¼ì†Œì„ì„ ë‹¤ ìˆ˜ ìˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì‚¬ìš©ìëŠ” Authorizeë¡œ ë¡œê·¸ì¸ì´ í™•ì¸ë˜ë©´, http://localhost:4000/users/github/finishë¡œ ëŒì•„ì˜¤ê²Œ ëœë‹¤. ë‹¤ìŒìœ¼ë¡œ ì—¬ê¸°ì„œ ë°›ì•„ì˜¨ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ì•¼ í•œë‹¤. ì´ë¥¼ ìœ„í•´ ë¼ìš°í„°ì™€ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ í˜•íƒœë¥¼ ë§Œë“¤ì–´ ë†“ê³  ì´ë²ˆì—ëŠ” ë§ˆë¬´ë¦¬ í•˜ê² ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userRouter.js
import {
  edit,
  remove,
  logout,
  see,
  startGithubLogin,
  finishGithubLogin,
} from "../controllers/userController";
...
userRouter.get("/github/start", startGithubLogin);
userRouter.get("/github/finish", finishGithubLogin);
...
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userControllser.js
...
export const startGithubLogin = (req, res) =&gt; {
  ...
};

export const finishGithubLogin = (req, res) =&gt; {};
</code></pre></div></div>

<h3 id="2-users-are-redirected-back-to-your-site-by-github-1">2. Users are redirected back to your site by GitHub</h3>

<h4 id="21-post-to-httpsgithubcomloginoauthaccess_token">2.1 POST to https://github.com/login/oauth/access_token</h4>
<p>ê¹ƒí—ˆë¸Œ í˜ì´ì§€ì—ì„œ ë¦¬ë‹¤ì´ë ‰ì…˜ì„ ë°›ì•„ì„œ ë‹¤ì‹œ í™ˆí˜ì´ì§€ë¡œ ëŒì•„ì˜¤ëŠ” ê²ƒê¹Œì§€ëŠ” ì„±ê³µí–ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ í•´ì•¼í•  ê²ƒì€ ê¹ƒí—ˆë¸Œì—ì„œ ë°›ì€ í† í°ì„ Acess tokenìœ¼ë¡œ ë°”ê¾¸ëŠ” ì¼ì´ë‹¤. â€œhttps://github.com/login/oauth/access_tokenâ€ ì£¼ì†Œë¡œ POST ë°©ì‹ìœ¼ë¡œ ë³´ë‚´ì¤˜ì•¼ í•˜ëŠ”ë°, ë’¤ì— ë§¤ê°œë³€ìˆ˜ë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ë§¤ê°œë³€ìˆ˜ ì¤‘ í•„ìˆ˜ì ì¸ ê²ƒì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<ul>
  <li>client_id: ê¹ƒí—ˆë¸Œì—ì„œ ë°›ì€ cliend IDë¡œ í•„ìˆ˜ì ìœ¼ë¡œ ì ì–´ì¤˜ì•¼ í•œë‹¤.</li>
  <li>client_secret: ê¹ƒí—ˆë¸Œì—ì„œ ë°›ì€ client secretìœ¼ë¡œ ì½”ë“œì—ì„œ ì§ì ‘ì ìœ¼ë¡œ ë³´ì—¬ì„  ì•ˆ ëœë‹¤. ê·¸ëŸ¬ë¯€ë¡œ env íŒŒì¼ì—ì„œ ê°€ì ¸ì™€ì•¼ í•œë‹¤.</li>
  <li>code: ì•ì„  ë‹¨ê³„ì—ì„œ ëŒë ¤ë°›ì€ codeë¥¼ ë§í•˜ëŠ”ë°, ë¦¬ë‹¤ì´ë ‰ì…˜ìœ¼ë¡œ ë°›ì•„ì˜¨ ê²ƒì„ ë§í•œë‹¤.</li>
</ul>

<p>ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸°ì— ì•ì„œ env íŒŒì¼ì— client_idì™€ client_secretì„ ì ì–´ì¤˜ì•¼ í•œë‹¤. GH_CLIENTì—ëŠ” client_idë¥¼ ì ì–´ì£¼ê³  GH_SECRETì—ëŠ” client_secretì„ ì ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// .env
COOKIE_SECRET=####
DB_URL=####
GH_CLIENT=####
GH_SECRET=####
</code></pre></div></div>

<p>ì´ë•Œ ê¹ƒí—ˆë¸Œì—ì„œ ë°›ì€ client IDëŠ” urlì—ì„œ ë³´ì´ê¸° ë•Œë¬¸ì— ë³„ë„ë¡œ ì ì–´ì¤„ í•„ìš”ëŠ” ì—†ì§€ë§Œ í¸ì˜ë¥¼ ìœ„í•´ ì ì–´ì¤¬ë‹¤. GH_SECRETì—ëŠ” ê¹ƒí—ˆë¸Œì—ì„œ ë§Œë“  OAuth application í˜ì´ì§€ì—ì„œ client secretsë¥¼ ë³´ë©´ ì°¾ì„ ìˆ˜ ìˆë‹¤. ì£¼ì˜í•  ê²ƒì€ client secretsëŠ” ë‹¤ì‹œ ë³¼ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ê¼­ ë³µì‚¬í•´ì„œ ì½”ë“œë¡œ ì˜®ê²¨ë†”ì•¼ í•œë‹¤. ì´ë¥¼ ê°€ì§€ê³  finishGithubLogin ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‘ì„±í•´ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export const finishGithubLogin = async (req, res) =&gt; {
  const baseUrl = "https://github.com/login/oauth/access_token";
  const config = {
    client_id = process.env.GH_CLIENT,
    client_secret = process.env.GH_SECRET,
    code: req.query.code,
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?#{params}`;
  const data = await fetch(finalUrl, {
    method: "POST",
    headers: {
      Accept: "application/json",
    },
  });
  const json = await data.json();
  console.log(json);
};
</code></pre></div></div>

<h4 id="22-fetch">2.2 fetch</h4>

<p>ì—¬ê¸°ì„œ fetchë¥¼ ë³¼ ìˆ˜ ìˆëŠ”ë°, fetchëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì„œë²„ë¡œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ë°›ì„ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë§¤ì†Œë“œë‹¤. ê¸°ë³¸ í˜•íƒœëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fetch(url [,option])
  .then(res =&gt; {})
  .catch(error =&gt; {});
</code></pre></div></div>

<p>urlì—ëŠ” ìš”ì²­ì„ ë³´ë‚¼ urlì„ ì ì–´ì£¼ê³  .thenì—ëŠ” ì‘ë‹µìœ¼ë¡œ í•  ì¼ì„ ì ì–´ì¤€ë‹¤. ê·¸ë¦¬ê³  .catchì—ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš° ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ì´ë‹¤. ì—¬ê¸°ì„œ ë³´ë©´ [,option]ì´ ìˆëŠ”ë°, ì´ëŠ” fetchì˜ 2ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¡œ ì¶”ê°€ì ì¸ ì •ë³´ë¥¼ ì…ë ¥í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fetch(url, {
  method: something,
  headers: {
    something
  },
  body: something,
})
  .then(res =&gt; {})
  .catch(error =&gt; {});
</code></pre></div></div>

<ul>
  <li>method: HTTP methodë¥¼ ì ì–´ì£¼ëŠ” ê³³ìœ¼ë¡œ ì ì§€ ì•Šìœ¼ë©´ GETì„ ë””í´íŠ¸ ê°’ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.</li>
  <li>header: ìš”ì²­ì˜ headerì˜ ì •ë³´ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.</li>
  <li>body: ìš”ì²­ì— ë³´ë‚´ëŠ” ë°ì´í„°ë¥¼ ì˜ë¯¸í•œë‹¤.</li>
</ul>

<p>ìš°ë¦¬ëŠ” fetchë¡œ POST methodë¥¼ ë³´ë‚´ì£¼ê³  ìˆê³ , íŒŒì¼ì„ json í˜•íƒœë¡œ ë°›ê¸° ìœ„í•´ headersì— Accept: â€œapplication/jsonâ€ì„ ì ì–´ì¤¬ë‹¤. ê·¸ë¦¬ê³  ì´ë ‡ê²Œ ëŒë ¤ë°›ì€ ì •ë³´ë¥¼ dataì— ì €ì¥í–ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ ì •ë³´ë¥¼ data.jsonìœ¼ë¡œ json í˜•íƒœë¡œ ë°”ê¿”ì¤€ë‹¤.</p>

<p>ê¹ƒí—ˆë¸Œì—ì„œ ì¤€ í† í°ì´ 10ë¶„ë§Œ ìœ ì§€ë˜ê¸° ë•Œë¬¸ì—, ì´ ì½”ë“œëŠ” ì‹œê°„ì´ ë„ˆë¬´ ì§€ë‚˜ë©´ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤.</p>

<p>ìœ„ì˜ ì½”ë“œëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ ìƒìœ¼ë¡œ ë¬¸ì œê°€ ì—†ë‹¤. ê·¸ë ‡ì§€ë§Œ ì‹¤í–‰í•  ê²½ìš° ì—ëŸ¬ê°€ ë‚˜ì˜¨ë‹¤. ì´ëŠ” fetchê°€ NodeJsì— ì—†ê¸° ë•Œë¬¸ì— ì—ëŸ¬ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì´ë‹¤. ì§€ê¸ˆê¹Œì§€ëŠ” NodeJSê°€ ìë°”ìŠ¤í¬ë¦½íŠ¸ì™€ ê±°ì˜ ë™ì¼í•˜ê²Œ ì—¬ê²¨ì¡Œì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì‘ë™í•˜ì§€ ì•ŠëŠ” í•¨ìˆ˜ë“¤ì´ ì¡´ì¬í•œë‹¤. fetchê°€ ê·¸ ì¤‘ì— í•˜ë‚˜ë¡œ ë‹¤ìŒì—ëŠ” ì´ë¥¼ ìˆ˜ì •í•  ë°©ë²•ì„ ì•Œì•„ë³´ê² ë‹¤.</p>

<h4 id="23-node-fetch">2.3 node-fetch</h4>
<p>ìš°ë¦° fetchê°€ í•„ìš”í•œë° NodsJsì—ëŠ” fetchê°€ ì—†ë‹¤. ë‹¤í–‰íˆë„ <a href="https://www.npmjs.com/package/node-fetch">node-fetch</a>ë¥¼ ì„¤ì¹˜í•˜ë©´ fetchë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤. <code class="language-plaintext highlighter-rouge">npm i node-fetch@2.6.1</code>ìœ¼ë¡œ node-fetchë¥¼ ì„¤ì¹˜í•´ì¤€ë‹¤. ìµœì‹  ë²„ì „ì´ ì•„ë‹ˆë¼ êµ¬ë²„ì „ì„ ì„¤ì¹˜í•˜ëŠ” ì´ìœ ëŠ”, 3.0 ë²„ì „ë¶€í„° ESM-only Moduleì´ ë˜ë©´ì„œ ì‘ë™í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤.</p>

<p>ì„¤ì¹˜ë¥¼ ì™„ë£Œí•˜ë©´ <code class="language-plaintext highlighter-rouge">import fetch from "node-fetch";</code>ë¡œ í•´ì„œ ë‹¤ì‹œ ì‹¤í–‰ì‹œì¼œë³´ì. í† í°ì´ ë§Œë£Œë˜ì„œ ì—ëŸ¬ê°€ ë‚  ìˆ˜ë„ ìˆì§€ë§Œ, ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•œë‹¤. ìš°ë¦¬ê°€ ì‘ì„±í•œ json íŒŒì¼ì„ ë³´ê¸° ìœ„í•´ì„œ ë§ˆì§€ë§‰ ì¤„ì— res.send(JSON.stringify(json)); ì„ ì ì–´ì¤€ë‹¤. ê·¸ë¦¬ê³  ë‹¤ì‹œ ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸ì„ ëˆ„ë¥´ë©´ jsonì„ í˜ì´ì§€ì—ì„œ ë³¼ ìˆ˜ ìˆë‹¤.</p>

<p>jsonì´ ì •ìƒì ìœ¼ë¡œ ëŒì•„ì˜¤ëŠ” ê²ƒì„ í™•ì¸í–ˆìœ¼ë©´ ë§ˆì§€ë§‰ ì½”ë“œë¥¼ ì§€ìš°ê³  <code class="language-plaintext highlighter-rouge">res.send(JSON.stringify(json));</code>ì„ ì ì–´ì¤€ë‹¤. ê·¸ë ‡ê²Œí•˜ë©´ í˜ì´ì§€ì—ì„œ json ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
  const data = await fetch(finalUrl, {
    method: "POST",
    headers: {
      Accept: "application/json",
    },
  });
  const json = await data.json();
  res.send(JSON.stringify(json));
};
...
</code></pre></div></div>

<p>ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê³  í˜ì´ì§€ë¥¼ ë³´ë©´ access_token, token_type, scopeê°€ json í˜•íƒœë¡œ ë‚˜ì˜¨ë‹¤.</p>

<h3 id="3-use-the-access-token-to-access-the-api">3. Use the access token to access the API</h3>

<h4 id="31-user-information">3.1 User information</h4>
<p>ì§€ê¸ˆê¹Œì§€ í•œ ê²°ê³¼ jsonìœ¼ë¡œ access_tokenì„ ë°›ì•„ì™”ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ í•´ì•¼ í•  ì¼ì€ ì´ access_tokenìœ¼ë¡œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ì¼ì´ë‹¤. í•´ì•¼í•  ê²ƒì€ â€œhttps://api.github.com/userâ€ì—ë‹¤ê°€ GETìœ¼ë¡œ ë°›ì•„ì˜¤ëŠ”ë°, headersì—ë‹¤ê°€ Authorization: token OAUTH-TOKENì„ ë³´ë‚´ì•¼ í•œë‹¤. ì—¬ê¸°ì„œ OAUTH-TOKENì€ ì•ì„œ ìš°ë¦¬ê°€ ë°›ì€ access_tokenì„ ì˜ë¯¸í•œë‹¤.</p>

<p>ìœ„ì˜ ì¼ì€ fetchë¥¼ ì‚¬ìš©í•˜ë©´ ê°„ë‹¨íˆ í•´ê²°í•  ìˆ˜ ìˆë‹¤. ë‹¤ë§Œ access_tokenì„ ëª» ë°›ì•„ì˜¨ ê²½ìš°, ë‹¤ì‹œ ë§í•´ì„œ ì‹¤íŒ¨í•œ ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ë¥¼ ê³ ë ¤í•´ì„œ if-elseë¡œ ì‹¤íŒ¨í•œ ê²½ìš° login í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
    const json = await data.json();
    if("access_token" in json) {
        const { access_token } = json;
        const userData = await fetch("https://api.github.com/user", {
            headers: {
                Authorization: `token ${access_token}`,
            },
        });
    } else {
        return res.redirect("/login");
    }
};
</code></pre></div></div>

<p>ì—¬ê¸°ê¹Œì§€ ì‘ì„±í–ˆìœ¼ë©´ ì½”ë“œëŠ” ì™„ì„±í•œ ê²ƒì´ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ì½”ë“œê°€ ì§€ì €ë¶„í•˜ê¸° ë•Œë¬¸ì— ì¡°ê¸ˆ ìˆ˜ì •ì„ í•´ì£¼ê² ë‹¤. ìˆ˜ì •í•˜ê¸° ì „ì— í˜„ì¬ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
export const finishGithubLogin = async (req, res) =&gt; {
    ...
    const data = await fetch(finalUrl, {
        method: "POST",
        headers: {
          Accept: "application/json",
        },
    });
    const json = await data.json();
    if("access_token" in json) {
        const { access_token } = json;
        const userData = await fetch("https://api.github.com/user", {
            headers: {
                Authorization: `token ${access_token}`,
            },
        });
    } else {
        return res.redirect("/login");
    }
};
</code></pre></div></div>

<p>ì½”ë“œë¥¼ ë³´ë©´ dataì™€ jsonì„ êµ¬í•˜ëŠ” ë¶€ë¶„ì´ êµ¬ë³„ë˜ì–´ ìˆë‹¤. í•˜ì§€ë§Œ fetchë¥¼ ìƒê°í•´ë³´ë©´ fetch().json()ìœ¼ë¡œ jsonì„ ê°„ë‹¨íˆ êµ¬í•  ìˆ˜ ìˆë‹¤. ëŒ€ì‹ ì— ì´ëŠ” 2ë²ˆ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ë¯€ë¡œ awaitì„ 2ë²ˆ ì‚¬ìš©í•´ì¤˜ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ê²°ê³¼ê°’ì´ ìš”ì²­í•œ í† í°ì´ë¯€ë¡œ ì´ë¦„ì„ tokenRequestë¡œ ë°”ê¿”ì¤¬ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
  const tokenRequest = await (
    await fetch(finalUrl, {
      method: "POST",
      headers: {
        Accept: "application/json",
      },
    })
  ).json();
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ê°™ì€ ë…¼ë¦¬ë¡œ access_tokenì„ ì‚¬ìš©í•˜ëŠ” ë¶€ë¶„ë„ fetch().json()ì„ ì‚¬ìš©í•˜ë©´ ì•„ë˜ì²˜ëŸ¼ ê³ ì³ì¤„ ìˆ˜ ìˆë‹¤. ì´ë•Œ ì´ë¦„ë„ jsonì—ì„œ tokenRequestë¡œ ë°”ê¿”ì¤¬ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
  if ("access_token" in tokenRequest) {
    const { access_token } = tokenRequest;
    const userData = await (
      await fetch("https://api.github.com/user", {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
  } else {
    return res.redirect("/login");
  }
};
...
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ì—¬ê¸°ê¹Œì§€ ì‘ì„±í•œ ê²ƒì´ ì œëŒ€ë¡œ ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ console.log(userData)ë¡œ í™•ì¸í•´ë³´ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
  if ("access_token" in tokenRequest) {
    const { access_token } = tokenRequest;
    const userData = await (
      await fetch("https://api.github.com/user", {
        headers: {
          Authorization: `token ${access_token}`,
        }ì´
      })
    ).json();
    console.log(userData);   // *
  } else {
    return res.redirect("/login");
  }
};
...
</code></pre></div></div>

<p>ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´ ì‚¬ìš©ì ì •ë³´ê°€ json í˜•íƒœë¡œ ì˜ ë‚˜ì˜¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤. ê·¸ëŸ°ë° ë‚´ìš©ì„ í™•ì¸í•´ë³´ë©´ email: nullì¸ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì¦‰, ì´ë©”ì¼ ì •ë³´ëŠ” ë°›ì•„ì˜¤ì§€ ëª»í•œ ê²ƒì´ë‹¤. ì´ì „ì— access_tokenì„ ë§Œë“¤ ë•Œ, ìš°ë¦¬ëŠ” scopeì—ì„œ read:userê³¼ user:emailì„ ë‘˜ ë‹¤ ì ì–´ì¤¬ìœ¼ë¯€ë¡œ ì´ë©”ì¼ ì •ë³´ë„ ë“¤ì–´ì˜¤ê¸¸ ê¸°ëŒ€í•˜ì§€ë§Œ, ë‘˜ì€ ë³„ê°œì˜ ì¼ì´ë¼ ë“¤ì–´ì˜¤ì§€ ì•ŠëŠ”ë‹¤. ë‹¤ì‹œ ë§í•´ access_tokenì€ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì˜¤ê³ , ì´ë©”ì¼ì„ ë°›ì•„ì˜¤ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ê·¸ë ‡ì§€ë§Œ ë‘˜ì€ ë³„ê°œì˜ ê³¼ì •ì´ë¯€ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ê²ƒê³¼, ì´ë©”ì¼ì„ ë°›ì•„ì˜¤ëŠ” ê²ƒ ë‘˜ ë‹¤ ë§Œë“¤ì–´ì•¼ í•œë‹¤. ì§€ê¸ˆê¹Œì§€ëŠ” ì‚¬ìš©ì ì •ë³´ë§Œì„ ë°›ì•„ì™”ê³  ë‹¤ìŒìœ¼ë¡œ ì´ë©”ì¼ì„ ë°›ì•„ì˜¤ëŠ” ë²•ì„ ì•Œì•„ë³´ì.</p>

<h4 id="32-email-information">3.2 email information</h4>
<p><a href="https://docs.github.com/en/rest/reference/users#emails">ë§í¬</a>ë¥¼ í™•ì¸í•˜ë©´ emailì„ ì„¤ì •í•˜ëŠ” ë°©ë²•ì„ ë³¼ ìˆ˜ ìˆë‹¤. ìš°ë¦¬ê°€ ì›í•˜ëŠ” í•­ëª©ì€ â€œList public email addresses for the authenticated userâ€ì´ë‹¤.</p>

<p>ìš°ë¦¬ê°€ í•´ì•¼í•  ì¼ì€ â€œhttps://api.github.com/user/emailsâ€ì— í—¤ë”íŒŒì¼ì„ GETìœ¼ë¡œ ë³´ë‚´ì£¼ëŠ” ê²ƒì´ë‹¤. ê·¸ëŸ°ë° ì£¼ì†Œë¥¼ ë³´ë©´ ê³µí†µë˜ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë¯€ë¡œ, apiurl = â€œhttps://api.github.comâ€ë¡œ ì§€ì •í•˜ê³ , ê·¸ì— ë§ê²Œ fetch ì•ˆì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê² ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
  if ("access_token" in tokenRequest) {
    const { access_token } = tokenRequest;
    const apiUrl = "https://api.github.com";
    const userData = await (
      await fetch(`${apiUrl}/user`, {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
    console.log(userData);
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ì—¬ê¸°ì— ì´ì–´ì„œ emailDataë¥¼ ë°›ì•„ì˜¤ëŠ” fetchë¥¼ ë§Œë“¤ê² ë‹¤. ìš°ë¦¬ê°€ ë³´ë‚´ì¤˜ì•¼ í•˜ëŠ” ê²ƒì€ GETìœ¼ë¡œ â€œhttps://api.github.com/user/emailsâ€ì— í—¤ë”ë¥¼ ë³´ë‚´ì¤˜ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ì— ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ í™•ì¸í•˜ë„ë¡ console.log()ë¥¼ ì‚¬ìš©í–ˆë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    ...
    console.log(userData);
    const emailData = await (
      await fetch(`${apiUrl}/user/emails`, {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
    console.log(emailData);
  } else {
    return res.redirect("/login");
  }
</code></pre></div></div>

<p>ì´ë ‡ê²Œí•˜ë©´ email ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆê²Œ ëœë‹¤. ì •ë³´ë¥¼ í™•ì¸í•´ë³´ë©´ primaryì™€ verifiedë¼ëŠ” ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆëŠ”ë°, ìš°ë¦¬ëŠ” ì´ ë‘˜ì´ trueì¸ ì´ë©”ì¼ë§Œ ì‚¬ìš©í•œë‹¤. ì™œëƒí•˜ë©´ ê¹ƒí—ˆë¸Œì— ë¡œê·¸ì¸ í•˜ë”ë¼ë„ ë‘˜ì´ falseì¸ ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” emailì€ find()ë¡œ ì°¾ì•˜ê³ , ë§Œì•½ ì¡°ê±´ì— ë§ëŠ” emailì´ ì—†ë‹¤ë©´ login í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    console.log(userData);
    const emailData = await (
      await fetch(`${apiUrl}/user/emails`, {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
    const emailObj = emailData.find(email =&gt; email.primary === true &amp;&amp; email.verified === true);
    if (!emailObj) {
      return res.redirect("/login");
    }
    // ******
  } else {
    return res.redirect("/login");
  }
};
</code></pre></div></div>

<p>ì½”ë“œê°€ <code class="language-plaintext highlighter-rouge">// ******</code>ì— ë„ì°©í•˜ê²Œ ë˜ë©´ primary, verifiedê°€ trueì¸ ì´ë©”ì¼ì„ ë°›ì€ ê²ƒì´ë‹ˆ, í•„ìš”í•œ ì‚¬ìš©ì ë°ì´í„°ëŠ” ëª¨ë‘ ë°›ì€ ê²ƒì´ë‹¤. ì´ë¥¼ ì‚¬ìš©í•´ì„œ ì‚¬ìš©ìë¥¼ ë¡œê·¸ì¸ ì‹œí‚¬ ìˆ˜ë„ ìˆì§€ë§Œ, ì´ë©”ì¼ì´ ì—†ë‹¤ë©´ ê³„ì •ì„ ë§Œë“¤ê²Œ í•  ìˆ˜ë„ ìˆë‹¤. ê·¸ë¦¬ê³  ì´ë©”ì¼ì€ ë™ì¼í•˜ì§€ë§Œ í•˜ë‚˜ëŠ” í˜ì´ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ í•˜ëŠ” ê²½ìš°ì™€, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ê¹ƒí—ˆë¸Œì—ì„œ ë¡œê·¸ì¸ í•˜ëŠ” ê²½ìš°ê°€ ìˆì„ ìˆ˜ ìˆë‹¤. ê°„ë‹¨íˆ ë§í•´ì„œ ë¡œê·¸ì¸í•˜ë ¤ëŠ” ê²½ìš°ëŠ” ì•„ë˜ì²˜ëŸ¼ 4ê²½ìš°ì˜ ìˆ˜ê°€ ìˆë‹¤.</p>

<ul>
  <li>ì‚¬ì´íŠ¸ì— ì•„ì´ë””ê°€ ì—†ê³ , ê¹ƒí—ˆë¸Œì— ì•„ì´ë””ê°€ ì—†ë‹¤.</li>
  <li>ì‚¬ì´íŠ¸ì— ì•„ì´ë””ê°€ ìˆê³ , ê¹ƒí—ˆë¸Œì— ì•„ì´ë””ê°€ ì—†ë‹¤.</li>
  <li>ì‚¬ì´íŠ¸ì— ì•„ì´ë””ê°€ ì—†ê³ , ê¹ƒí—ˆë¸Œì— ì•„ì´ë””ê°€ ìˆë‹¤.</li>
  <li>ì‚¬ì´íŠ¸ì— ì•„ì´ë””ê°€ ìˆê³ , ê¹ƒí—ˆë¸Œì— ì•„ì´ë””ê°€ ìˆë‹¤.</li>
</ul>

<p>ì´ ì¤‘ì—ì„œ ë‘˜ ë‹¤ ì—†ëŠ” ê²½ìš°ë‚˜, ê¹ƒí—ˆë¸Œì— ì•„ì´ë””ê°€ ì—†ëŠ” ê²½ìš°ëŠ” ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ê¹ƒí—ˆë¸Œë¡œ ë¡œê·¸ì¸ì„ í•˜ë ¤ê³  í•˜ë©´ ê¹ƒí—ˆë¸Œì—ì„œ ì•„ì´ë””ë¥¼ ë§Œë“¤ê²Œ ëœë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ ê¹ƒí—ˆë¸Œì— ì•„ì´ë””ê°€ ìˆì§€ë§Œ ì‚¬ì´íŠ¸ì—” ì•„ì´ë””ê°€ ì—†ëŠ” ê²½ìš°ë‹¤. ì´ ê²½ìš°ì—” ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸ì„ í•œ ê²ƒìœ¼ë¡œ ê³„ì •ì„ ë§Œë“¤ì–´ì„œ ì„œë²„ì— ì €ì¥í•œë‹¤.</p>

<p>ì œì¼ ë¬¸ì œê°€ ë˜ëŠ” ê²½ìš°ëŠ” ë‘˜ ë‹¤ ìˆëŠ” ê²½ìš°ë‹¤. ë§Œì•½ ë‘ ì‚¬ìš©ìê°€ ë™ì¼í•œ ì´ë©”ì¼ì„ ì‚¬ìš©í•  ê²½ìš° ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ? ë‘˜ì„ ë™ì¼í•œ ì‚¬ìš©ìë¡œ ìƒê°í•´ì„œ ê³„ì •ì„ í•˜ë‚˜ë¡œ í•©ì³ì„œ ê´€ë¦¬í•  ìˆ˜ë„ ìˆì§€ë§Œ, ë”°ë¡œ ë¡œê·¸ì¸ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ ìˆ˜ë„ ìˆë‹¤. ì•„ë‹ˆë©´ ì—ëŸ¬ë¥¼ ë³´ë‚´ë©´ì„œ í•œìª½ì˜ ë¡œê·¸ì¸ì´ ë¶ˆê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ ìˆ˜ë„ ìˆë‹¤.</p>

<p>ìš°ë¦¬ëŠ” ì´ë©”ì¼ì´ ë™ì¼í•˜ë‹¤ë©´ ë¡œê·¸ì¸ì„ í—ˆìš©í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ë§Œë“¤ì–´ë³´ê² ë‹¤. ì‹¤ì œë¡œëŠ” ì´ë ‡ê²Œ í•˜ê¸° ë³´ë‹¤ëŠ” ì´ë©”ì¼ì„ ì—°ë™ì‹œí‚¨ë‹¤ê±°ë‚˜ ë³„ê°œë¡œ í•˜ëŠ” ê²½ìš°ê°€ ë§ì§€ë§Œ, ì¼ë‹¨ì€ ì´ëŒ€ë¡œ ì§„í–‰í•´ë³´ì.</p>

<p>emailObjë¥¼ ë³´ë©´ ì•ˆì— emailì´ ë“¤ì–´ìˆë‹¤. ì´ë¥¼ ì‚¬ìš©í•´ì„œ ê°™ì€ emailì„ ì“°ëŠ” ì‚¬ìš©ìë¥¼ ì°¾ì•„ì„œ existingUserì— ë„£ì–´ì¤¬ë‹¤. ë§Œì•½ ì‚¬ìš©ìê°€ ìˆë‹¤ë©´ ì„¸ì…˜ì˜ ê°’ì„ ë°”ê¿”ì„œ ë¡œê·¸ì¸ ì‹œì¼œì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    ...
    const emailObj = emailData.find(
      (email) =&gt; email.primary === true &amp;&amp; email.verified === true
    );
    if (!emailObj) {
      return res.redirect("/login");
    }
    const existingUser = await User.findOne({ email: emailObj.email });
    if (existingUser) {
      req.session.loggedIn = true;
      req.session.user = existingUser;
      return res.redirect("/");
    } else {
</code></pre></div></div>

<p>ê·¸ëŸ°ë° ì´ë©”ì¼ì´ ì—†ë‹¤ë©´, ì´ëŠ” ì‚¬ìš©ìê°€ ê¹ƒí—ˆë¸Œ ì•„ì´ë””ë§Œìœ¼ë¡œ ë¡œê·¸ì¸í•œë‹¤ëŠ” ì˜ë¯¸ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìƒˆë¡œìš´ Userë¥¼ ë§Œë“¤ì–´ì„œ ê³„ì •ì„ ìƒì„±í•´ì•¼í•œë‹¤. í•˜ì§€ë§Œ ê·¸ì— ì•ì„œ ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤. ì™œëƒí•˜ë©´ í˜„ì¬ëŠ” passwordê°€ requiredì´ë¯€ë¡œ ì—†ì–´ì„œëŠ” ì•ˆ ëœë‹¤. ë¤ìœ¼ë¡œ ì‚¬ìš©ìê°€ ì†Œì…œ ë¡œê·¸ì¸ì„ í–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ socialOnlyë¼ëŠ” ì†ì„±ì„ ë”í•´ì£¼ë ¤ê³  í•œë‹¤. User.jsì—ì„œ ìŠ¤í‚¤ë§ˆë¥¼ ìˆ˜ì •í•´ì„œ ì•„ë˜ì²˜ëŸ¼ ë§Œë“¤ì–´ì£¼ì.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// User.js
const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  socialOnly: { type: Boolean, default: false },  // ******
  username: { type: String, required: true, unique: true },
  password: { type: String }, // ******
  name: { type: String, required: true },
  location: String,
});
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ê±°ê¸°ì— ë§ì¶”ì„œ ê³„ì •ì„ ìƒì„±í•  ë•Œ, socialOnly: true,ë¥¼ ë„£ì–´ì„œ ë§Œë“¤ì–´ì¤€ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ...
    } else {
      const user = await User.create({
        name: userData.name,
        username: userData.login,
        email: emailObj.email,
        password: "",
        socialOnly: true,
        location: userData.location,
      });
      req.session.loggedIn = true;
      req.session.user = user;
      return res.redirect("/");
    }
  } else {
    return res.redirect("/login");
  }
</code></pre></div></div>

<p>ì†Œì…œ ë¡œê·¸ì¸ì„ í•  ë•Œ, socialOnly: trueë¡œ ë§Œë“¤ì–´ì¤¬ë‹¤. ê·¸ëŸ°ë° ì‚¬ì´íŠ¸ì—ì„œ ë¡œê·¸ì¸ì„ í•  ë•Œ, ìš°ë¦¬ëŠ” socialOnlyì˜ ê°’ì„ ì²´í¬í•´ì£¼ì§€ ì•Šê³  ìˆë‹¤. ê·¸ëŸ°ë° ì†Œì…œ ë¡œê·¸ì¸ë§Œ í•œ ê³„ì •ì˜ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì‚¬ì´íŠ¸ì—ì„œ ë¡œê·¸ì¸ í•  ë•Œ, ì•„ì´ë””ë§Œ ì•Œì•„ë‚´ë©´ ë¹„ë°€ë²ˆí˜¸ì™€ ê´€ê³„ ì—†ì´ ë¡œê·¸ì¸ í•  ìˆ˜ ìˆê²Œ ëœë‹¤.</p>

<p>ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì‚¬ì´íŠ¸ì—ì„œ ë¡œê·¸ì¸ í•˜ëŠ” ê²½ìš°ì— socialOnly: falseì¸ ê²½ìš°ë§Œ ì°¾ì•„ë³´ë„ë¡ ë§Œë“¤ì–´ì£¼ê² ë‹¤. postLoginìœ¼ë¡œ ê°€ì„œ ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì •í•´ì¤€ë‹¤.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
...
  const pageTitle = "Login";
  const user = await User.findOne({ username, socialOnly: false });
  if (!user) {
...
</code></pre></div></div>

<p>ë‹¤ìŒìœ¼ë¡œ ì½”ë“œë¥¼ ì¡°ê¸ˆ ì •ë¦¬í•´ì£¼ê² ë‹¤. ìš°ë¦°ëŠ” req.session() ë¶€ë¶„ì„ 2ë²ˆ ë°˜ë³µí•˜ê³  ìˆë‹¤. ì´ë¥¼ ê³ ì¹˜ê¸° ìœ„í•´ì„  constë¥¼ letìœ¼ë¡œ ë°”ê¾¸ê³  if-elseì˜ ìˆœì„œë¥¼ ë°”ê¿”ì„œ ì•„ë˜ì²˜ëŸ¼ ì ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
 if (!emailObj) {
      return res.redirect("/login");
    }
    let user = await User.findOne({ email: emailObj.email });
    if (!user) {
      user = await User.create({
        name: userData.name,
        username: userData.login,
        email: emailObj.email,
        password: "",
        socialOnly: true,
        location: userData.location,
      });
    }
    req.session.loggedIn = true;
    req.session.user = user;
    return res.redirect("/");
  } else {
    return res.redirect("/login");
  }
};
</code></pre></div></div>

<p>ì¶”ê°€ì ìœ¼ë¡œ User.jsë¥¼ ìˆ˜ì •í•´ì„œ avatarURlì„ ì¶”ê°€í•˜ê² ë‹¤. ì´ëŠ” ë‹¤ìŒì— avatarë¥¼ ë‹¤ë£¨ê¸° ìœ„í•´ ë¯¸ë¦¬ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// User.js
const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  avatarUrl: String,  // ******
  socialOnly: { type: Boolean, default: false },
  username: { type: String, required: true, unique: true },
  password: { type: String },
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ê·¸ì— ë§ì¶°ì„œ ê¹ƒí—ˆë¸Œë¡œ ê³„ì •ì„ ë§Œë“¤ ë•Œ, avatarUrlì„ ë°›ì•„ì˜¤ë„ë¡ ë§Œë“ ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// userController.js
    if (!user) {
      user = await User.create({
        avatarUrl: userData.avatar_url, // ******
        name: userData.name,
        username: userData.login,
        email: emailObj.email,
        password: "",
        socialOnly: true,
        location: userData.location,
      });
    }
</code></pre></div></div>

<p>ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒ í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ë³´ê² ë‹¤. ë¡œê·¸ì•„ì›ƒ í•˜ëŠ” ë°©ë²•ì€ ê°„ë‹¨í•˜ë‹¤. <code class="language-plaintext highlighter-rouge">req.session.destroy();</code>ë¡œ ì„¸ì…˜ì„ ì—†ì• ì£¼ê³  í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ì—´ì–´ì£¼ë©´ ëœë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export const logout = (req, res) =&gt; {
  req.session.destroy();
  return res.redirect("/");
};
...
</code></pre></div></div>

<p>ê·¸ë¦¬ê³  ì½”ë“œì—ì„œ í•„ìš”ì—†ëŠ” remove ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë¼ìš°í„°ë¥¼ ì‚­ì œí•´ì¤¬ë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ base.pugì—ì„œ logout ë§í¬ë¥¼ ìˆ˜ì •í•´ì£¼ë©´ ëì´ë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// base.pug
      if loggedIn
          li
              a(href="/users/logout")  Log Out
          li
</code></pre></div></div>
:ET